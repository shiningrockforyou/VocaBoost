# Section 20.1 to 20.3 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 20.1 to 20.3:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 20.1 to 20.3 (Seed Data & Phase Verification 1-4)

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_20.1_to_20.3_criteria_audit.md

## Executive Summary
- Total Issues: 9
- ‚ö†Ô∏è Partial Implementations: 4
- ‚ùå Missing Features: 4
- ‚ùì Needs Investigation: 1
- Estimated Complexity: Medium

---

## Issue 1: FRQ Section for Phase 3 Testing (Seed Data)

### Audit Finding
- **Status:** ‚ùå Missing
- **Criterion:** Test with FRQ section for Phase 3 testing
- **Current State:** Seed data only includes MCQ section. No FRQ section or FRQ test is seeded.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/seedTestData.js` (lines 15-188) - Contains seedAPTestData function that creates MCQ-only test
  - `src/apBoost/utils/apTypes.js` (lines 6-12, 27-31) - Defines QUESTION_TYPE.FRQ/SAQ/DBQ and SECTION_TYPE.FRQ
- **Current Implementation:** Only one test ("AP US History Practice Exam #1") with MCQ section containing 5 MCQ questions
- **Gap:** No FRQ section exists. No FRQ questions with `subQuestions` array are defined.
- **Dependencies:** apTypes.js provides the type constants needed

### Fix Plan

#### Step 1: Add FRQ Test Document
**File:** `src/apBoost/utils/seedTestData.js`
**Action:** Add new test document after the existing MCQ test
**Details:**
- Create new test document `test_apush_frq_practice_1`
- Set `testType: TEST_TYPE.EXAM` and `hasFRQ: true`
- Include single FRQ section with `sectionType: SECTION_TYPE.FRQ`
- Reference FRQ question IDs: `['frq1', 'frq2']`
- Include proper `scoreRanges` for AP 1-5 conversion

```javascript
// Pattern to follow - add after line 48 (after existing test creation)
const frqTestId = 'test_apush_frq_practice_1'
await setDoc(doc(db, COLLECTIONS.TESTS, frqTestId), {
  title: 'AP US History FRQ Practice',
  subject: 'AP_US_HISTORY',
  testType: TEST_TYPE.EXAM,
  createdBy: 'system',
  isPublic: true,
  hasFRQ: true,
  questionOrder: QUESTION_ORDER.FIXED,
  sections: [{
    id: 'section_frq',
    title: 'Free Response',
    sectionType: SECTION_TYPE.FRQ,
    timeLimit: 60,
    questionIds: ['frq1', 'frq2'],
    calculatorEnabled: false,
  }],
  scoreRanges: { ...DEFAULT_SCORE_RANGES },
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp(),
})
```

#### Step 2: Add FRQ Question Documents
**File:** `src/apBoost/utils/seedTestData.js`
**Action:** Add FRQ questions with `subQuestions` array
**Details:**
- Create 2 FRQ questions with proper structure
- Each question must have `subQuestions` array with `label`, `prompt`, `points`, and optional `rubric`
- Use `questionType: QUESTION_TYPE.SAQ` or `QUESTION_TYPE.DBQ`

```javascript
// FRQ question structure to add
const frqQuestions = [
  {
    id: 'frq1',
    testId: frqTestId,
    subject: 'AP_US_HISTORY',
    questionType: QUESTION_TYPE.SAQ,
    format: QUESTION_FORMAT.VERTICAL,
    questionDomain: 'Unit 5: Early Republic',
    difficulty: 'MEDIUM',
    questionText: 'Answer all parts of the question that follows.',
    subQuestions: [
      { label: 'a', prompt: 'Briefly describe ONE economic change...', points: 3, rubric: '1 pt for identification, 2 pts for explanation' },
      { label: 'b', prompt: 'Briefly explain ONE political consequence...', points: 3, rubric: '...' },
      { label: 'c', prompt: 'Briefly explain ONE social effect...', points: 3, rubric: '...' },
    ],
    points: 9,
  },
  // Add second FRQ question following same pattern
]
```

### Verification Steps
1. Run `seedAPTestData()` in browser console
2. Verify in Firestore: `ap_tests/test_apush_frq_practice_1` exists with `hasFRQ: true`
3. Verify `ap_questions/frq1` and `frq2` exist with `subQuestions` arrays
4. Load APDashboard - new FRQ test should appear
5. Click test - should navigate to test session
6. Verify sub-question navigation works (1a ‚Üí 1b ‚Üí 1c)

### Potential Risks
- None - additive change to seed data

---

## Issue 2: Mixed MCQ + FRQ Test (Seed Data)

### Audit Finding
- **Status:** ‚ùå Missing
- **Criterion:** Test with mixed MCQ + FRQ for full testing
- **Current State:** No mixed test exists in seed data. Only single MCQ section test.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/seedTestData.js` (lines 28-37) - sections array only contains MCQ section
  - `src/apBoost/utils/apTypes.js` (line 30) - `SECTION_TYPE.MIXED` exists
- **Current Implementation:** Only single-section MCQ test
- **Gap:** Need multi-section test with both MCQ and FRQ sections
- **Dependencies:** Requires FRQ questions from Issue 1

### Fix Plan

#### Step 1: Add Mixed Test Document
**File:** `src/apBoost/utils/seedTestData.js`
**Action:** Add new mixed test after FRQ test
**Details:**
- Create test `test_apush_full_exam`
- Include 2 sections: MCQ section (reuse q1-q5) + FRQ section (reuse frq1-frq2)
- Set `hasFRQ: true`

```javascript
const mixedTestId = 'test_apush_full_exam'
await setDoc(doc(db, COLLECTIONS.TESTS, mixedTestId), {
  title: 'AP US History Full Practice Exam',
  subject: 'AP_US_HISTORY',
  testType: TEST_TYPE.EXAM,
  createdBy: 'system',
  isPublic: true,
  hasFRQ: true,
  questionOrder: QUESTION_ORDER.FIXED,
  sections: [
    {
      id: 'section_mcq',
      title: 'Section 1: Multiple Choice',
      sectionType: SECTION_TYPE.MCQ,
      timeLimit: 45,
      questionIds: ['q1', 'q2', 'q3', 'q4', 'q5'],
      mcqMultiplier: 1.0,
      calculatorEnabled: false,
    },
    {
      id: 'section_frq',
      title: 'Section 2: Free Response',
      sectionType: SECTION_TYPE.FRQ,
      timeLimit: 60,
      questionIds: ['frq1', 'frq2'],
      calculatorEnabled: false,
    }
  ],
  scoreRanges: { ...DEFAULT_SCORE_RANGES },
  createdAt: serverTimestamp(),
  updatedAt: serverTimestamp(),
})
```

### Verification Steps
1. Run seed function
2. Verify test exists with 2 sections in Firestore
3. Start test - complete MCQ section
4. Verify section transition to FRQ works
5. Submit - verify Report Card shows both section scores

### Potential Risks
- Section transition logic may need verification in `useTestSession.submitSection()`

---

## Issue 3: Assignment Document (Seed Data)

### Audit Finding
- **Status:** ‚ùå Missing
- **Criterion:** At least one assignment linking test to students
- **Current State:** No assignment document is seeded.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/seedTestData.js` - No assignment creation code
  - `src/apBoost/utils/apTypes.js` (line 97) - `COLLECTIONS.ASSIGNMENTS = 'ap_assignments'` defined
  - `src/apBoost/services/apGradingService.js` (lines 43-48) - Filters by `classId` implying assignment structure
- **Current Implementation:** No assignment seed data
- **Gap:** Need sample `ap_assignments` document with `testId`, `classId`, `studentIds[]`
- **Dependencies:** Requires ap_classes collection (may also need seed data)

### Fix Plan

#### Step 1: Add Sample Class Document
**File:** `src/apBoost/utils/seedTestData.js`
**Action:** Add class document before assignment
**Details:**
- Create class `class_apush_period1`
- Include `teacherId`, `name`, `studentIds[]`

```javascript
const classId = 'class_apush_period1'
await setDoc(doc(db, COLLECTIONS.CLASSES, classId), {
  name: 'AP US History - Period 1',
  teacherId: 'demo_teacher', // Placeholder
  studentIds: ['demo_student_1', 'demo_student_2'],
  subject: 'AP_US_HISTORY',
  createdAt: serverTimestamp(),
})
```

#### Step 2: Add Assignment Document
**File:** `src/apBoost/utils/seedTestData.js`
**Action:** Add assignment linking test to class
**Details:**
- Create assignment `assignment_apush_exam1`
- Link to MCQ test and class
- Include due date, available dates

```javascript
const assignmentId = 'assignment_apush_exam1'
await setDoc(doc(db, COLLECTIONS.ASSIGNMENTS, assignmentId), {
  testId: testId, // 'test_apush_practice_1'
  classId: classId,
  teacherId: 'demo_teacher',
  title: 'APUSH Practice Exam #1',
  studentIds: ['demo_student_1', 'demo_student_2'],
  availableFrom: serverTimestamp(),
  dueDate: null, // No due date for practice
  allowLateSubmission: true,
  createdAt: serverTimestamp(),
})
```

### Verification Steps
1. Run seed function
2. Verify `ap_classes/class_apush_period1` exists
3. Verify `ap_assignments/assignment_apush_exam1` exists with proper references
4. Verify assignment shows in teacher's assignment list (if implemented)

### Potential Risks
- Teacher/student IDs are placeholders - actual integration needs real user IDs

---

## Issue 4: Submit with Pending Queue Shows Sync Progress

### Audit Finding
- **Status:** ‚ö†Ô∏è Partial
- **Criterion:** Submit with pending queue ‚Üí shows sync progress
- **Current State:** `submitTest` calls `flushQueue()` before creating result if `queueLength > 0`. However, progress modal/UI during flush is not clearly visible.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/hooks/useTestSession.js` (lines 396-421) - `submitTest` function
  - `src/apBoost/components/ReviewScreen.jsx` (lines 138-144) - Shows "Submitting..." spinner
  - `src/apBoost/hooks/useOfflineQueue.js` (lines 173-266) - `flushQueue` with `isFlushing` state
- **Current Implementation:**
  - ReviewScreen shows "Submitting..." with spinner during submit
  - `isFlushing` state exposed from useOfflineQueue
  - `queueLength` exposed but not shown in UI
- **Gap:** No specific progress indicator showing "Syncing X items..." before submit
- **Dependencies:** useTestSession exposes `isSyncing` and `queueLength` already

### Fix Plan

#### Step 1: Enhance ReviewScreen Submit Button
**File:** `src/apBoost/components/ReviewScreen.jsx`
**Action:** Show queue sync progress before submission
**Details:**
- Add `isSyncing` and `queueLength` props to ReviewScreen
- Show specific sync message when queue is flushing
- Show different states: "Syncing answers..." ‚Üí "Submitting..."

```jsx
// Add props
export default function ReviewScreen({
  // ... existing props
  isSyncing,    // NEW
  queueLength,  // NEW
}) {

// Update submit button (lines 133-149)
<button onClick={onSubmit} disabled={isSubmitting || isSyncing}>
  {isSyncing ? (
    <>
      <Spinner />
      Syncing {queueLength} answer{queueLength !== 1 ? 's' : ''}...
    </>
  ) : isSubmitting ? (
    <>
      <Spinner />
      Submitting...
    </>
  ) : (
    isFinalSection ? 'Submit Test' : 'Submit Section'
  )}
</button>
```

#### Step 2: Pass Props from APTestSession
**File:** `src/apBoost/pages/APTestSession.jsx`
**Action:** Pass sync state to ReviewScreen
**Details:**
- Find ReviewScreen render (around line 352-384)
- Add `isSyncing` and `queueLength` props

```jsx
<ReviewScreen
  // ... existing props
  isSyncing={isSyncing}
  queueLength={queueLength}
/>
```

### Verification Steps
1. Answer questions, then go offline (Network tab ‚Üí Offline)
2. Answer more questions (builds queue)
3. Go online and click "Go to Review Screen"
4. Click "Submit Test" - should show "Syncing X answers..."
5. After sync completes, should show "Submitting..."

### Potential Risks
- Need to disable submit button during sync to prevent double-submit

---

## Issue 5: Cross-Browser Duplicate Detection Timing

### Audit Finding
- **Status:** ‚ö†Ô∏è Partial
- **Criterion:** Open in different browser ‚Üí first browser shows modal within 15s
- **Current State:** BroadcastChannel only works same-browser. Cross-browser detection relies on Firestore `sessionToken` check during heartbeat.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/hooks/useHeartbeat.js` (lines 8-9) - `HEARTBEAT_INTERVAL = 15000` (15 seconds)
  - `src/apBoost/hooks/useHeartbeat.js` (lines 46-50) - Session takeover detection via `sessionToken` comparison
- **Current Implementation:**
  - Heartbeat interval is correctly set to 15 seconds (line 9)
  - When heartbeat detects different `sessionToken`, sets `sessionTakenOver = true` (line 49)
- **Gap:** None - implementation appears correct per spec. Timing is 15s heartbeat interval.
- **Dependencies:** Works with `useDuplicateTabGuard` for same-browser, heartbeat for cross-browser

### Fix Plan

#### Step 1: Verify Implementation (No Code Change Needed)
**File:** `src/apBoost/hooks/useHeartbeat.js`
**Action:** Documentation/verification only
**Details:**
- Heartbeat interval is correctly 15000ms (line 9)
- `MAX_FAILURES = 3` means detection after max 45 seconds in worst case
- Cross-browser: New browser claims session, old browser's next heartbeat (within 15s) detects `sessionToken` mismatch

### Verification Steps
1. Start test in Chrome, note test session is active
2. Open same test URL in Firefox
3. Firefox should claim session (new `sessionToken`)
4. Chrome should show "Session taken over" modal within 15 seconds
5. Time the actual detection - should be ‚â§15 seconds from Firefox opening

### Potential Risks
- If heartbeat is in-flight when takeover occurs, detection may take up to 30s (2 intervals)

---

## Issue 6: Connection Unstable Banner Timing

### Audit Finding
- **Status:** ‚ö†Ô∏è Partial
- **Criterion:** Disconnect network ‚Üí "Connection unstable" banner after ~45s
- **Current State:** ConnectionStatus component exists and shows banner based on `isConnected` prop. Timing depends on heartbeat failure count.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/ConnectionStatus.jsx` (lines 40-48) - Disconnected state banner
  - `src/apBoost/hooks/useHeartbeat.js` (lines 8-10) - `HEARTBEAT_INTERVAL = 15000`, `MAX_FAILURES = 3`
  - `src/apBoost/hooks/useHeartbeat.js` (lines 70-76) - Failure count increment and `isConnected` toggle
- **Current Implementation:**
  - Heartbeat every 15 seconds
  - After 3 consecutive failures, `isConnected` becomes false
  - 3 failures √ó 15s = 45 seconds matches spec
- **Gap:** None - implementation appears correct. Just needs integration testing.
- **Dependencies:** APTestSession must pass `isConnected` to ConnectionStatus

### Fix Plan

#### Step 1: Verify Integration (No Code Change Needed)
**File:** `src/apBoost/pages/APTestSession.jsx`
**Action:** Verify ConnectionStatus receives props
**Details:**
- Check that `isConnected` from useTestSession is passed to ConnectionStatus
- `useTestSession` exposes `isConnected` (line 498)

### Verification Steps
1. Start a test session
2. Open DevTools ‚Üí Network tab ‚Üí Set "Offline"
3. Wait and observe:
   - At ~15s: First heartbeat failure
   - At ~30s: Second heartbeat failure
   - At ~45s: Third failure - banner should appear
4. Verify banner says "Connection unstable - your progress is being saved locally"

### Potential Risks
- None - timing is mathematically correct per implementation

---

## Issue 7: Mark Complete ‚Üí Student Sees Updated Score

### Audit Finding
- **Status:** ‚ö†Ô∏è Partial
- **Criterion:** "Mark Complete" ‚Üí student sees updated score
- **Current State:** Components exist. Would need integration testing to verify score recalculation and real-time update flow.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/grading/GradingPanel.jsx` (lines 302-314) - `handleMarkComplete` function
  - `src/apBoost/services/apGradingService.js` (lines 165-210) - `saveGrade` with score recalculation
  - `src/apBoost/pages/APReportCard.jsx` (lines 271-297) - `loadResult` on mount only
- **Current Implementation:**
  - GradingPanel calls `saveGrade(resultId, grades, GRADING_STATUS.COMPLETE, ...)`
  - `saveGrade` recalculates `score`, `percentage`, `apScore` and updates Firestore (lines 182-203)
  - APReportCard loads result once on mount - no real-time listener
- **Gap:** APReportCard doesn't have real-time updates. If student has page open while teacher grades, they won't see update without refresh.
- **Dependencies:** Firestore onSnapshot listener needed

### Fix Plan

#### Step 1: Add Firestore Listener to APReportCard
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Replace one-time fetch with real-time listener
**Details:**
- Import `onSnapshot` from firebase/firestore
- Replace `getDoc` with `onSnapshot` in useEffect
- Handle unsubscribe in cleanup

```jsx
// Replace getDoc with onSnapshot (around lines 271-297)
import { onSnapshot } from 'firebase/firestore'

useEffect(() => {
  if (!resultId) return

  setLoading(true)
  setError(null)

  // Real-time listener for result updates
  const unsubscribe = onSnapshot(
    doc(db, COLLECTIONS.TEST_RESULTS, resultId),
    async (docSnap) => {
      if (!docSnap.exists()) {
        setError('Result not found')
        setLoading(false)
        return
      }

      const resultData = { id: docSnap.id, ...docSnap.data() }
      setResult(resultData)

      // Load test metadata (can still be one-time)
      if (resultData.testId && !test) {
        const testData = await getTestMeta(resultData.testId)
        setTest(testData)
      }

      setLoading(false)
    },
    (err) => {
      console.error('Error loading result:', err)
      setError(err.message || 'Failed to load results')
      setLoading(false)
    }
  )

  return () => unsubscribe()
}, [resultId])
```

#### Step 2: Add Visual Feedback for Score Update
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Add transition animation when score updates
**Details:**
- Add CSS transition to APScoreBadge
- Optionally show "Score Updated!" toast when grading completes

### Verification Steps
1. Student submits test with FRQ, opens Report Card (shows "Pending")
2. Keep Report Card open in student's browser
3. Teacher opens Gradebook, grades the FRQ, clicks "Mark Complete"
4. Student's Report Card should update WITHOUT refresh:
   - AP Score badge updates from ‚è≥ to actual score
   - "Awaiting Grade" banner disappears
   - FRQ points fill in
5. Verify total score and percentage update

### Potential Risks
- Real-time listener uses Firestore quota - consider debouncing or limiting
- Need to handle document deletion edge case

---

## Issue 8: Annotations Visible in Review Mode

### Audit Finding
- **Status:** ‚ùì Unable to Verify
- **Criterion:** Annotations visible in review mode (read-only)
- **Current State:** ReviewScreen shows question grid but doesn't appear to display annotation details.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/ReviewScreen.jsx` (lines 1-155) - No annotation props or display
  - `src/apBoost/hooks/useAnnotations.js` (lines 1-258) - Full annotation state management
  - `src/apBoost/pages/APTestSession.jsx` - Uses useAnnotations but may not pass to ReviewScreen
- **Current Implementation:**
  - ReviewScreen receives `questions`, `answers`, `flags`, `onGoToQuestion`, etc.
  - ReviewScreen does NOT receive highlights, strikethroughs, or display them
  - QuestionBox only shows answered/flagged state
- **Gap:** Annotations are not passed to or displayed in ReviewScreen
- **Dependencies:** Need to pass annotation state from APTestSession

### Fix Plan

#### Step 1: Add Annotation Props to ReviewScreen
**File:** `src/apBoost/components/ReviewScreen.jsx`
**Action:** Accept and display annotation summary
**Details:**
- Add `highlights` and `strikethroughs` props (Maps from useAnnotations)
- Show annotation indicators in QuestionBox or summary

```jsx
// Add props to ReviewScreen signature
export default function ReviewScreen({
  // ... existing props
  highlights,      // Map<questionId, HighlightRange[]>
  strikethroughs,  // Map<questionId, Set<choiceId>>
}) {

// Calculate annotation counts
const annotatedCount = Array.from(highlights?.keys() || []).length
  + Array.from(strikethroughs?.keys() || []).filter(qId =>
      strikethroughs.get(qId)?.size > 0
    ).length
```

#### Step 2: Update QuestionBox to Show Annotation Indicator
**File:** `src/apBoost/components/ReviewScreen.jsx`
**Action:** Add annotation indicator to QuestionBox
**Details:**
- Show small icon/indicator if question has highlights or strikethroughs
- Keep read-only (no editing in review mode)

```jsx
function QuestionBox({ number, questionId, isAnswered, isFlagged, hasAnnotations, onClick }) {
  return (
    <button ...>
      {isFlagged ? 'üö©' : hasAnnotations ? <span className="text-xs">üìù</span> : number}
    </button>
  )
}

// In render:
<QuestionBox
  hasAnnotations={
    (highlights?.get(questionId)?.length > 0) ||
    (strikethroughs?.get(questionId)?.size > 0)
  }
/>
```

#### Step 3: Add Annotation Summary to Review Summary
**File:** `src/apBoost/components/ReviewScreen.jsx`
**Action:** Show annotation count in summary section
**Details:**
- Add "Questions with annotations: X" to summary

```jsx
// In Summary section (around line 88-96)
<li>‚Ä¢ Answered: {answeredCount}/{totalQuestions}</li>
{annotatedCount > 0 && (
  <li>‚Ä¢ With annotations: {annotatedCount}</li>
)}
```

#### Step 4: Pass Annotations from APTestSession
**File:** `src/apBoost/pages/APTestSession.jsx`
**Action:** Pass annotation state to ReviewScreen
**Details:**
- Find where ReviewScreen is rendered
- Pass `highlights` and `strikethroughs` from useAnnotations

### Verification Steps
1. Start test, answer questions
2. Add highlights to some passage text
3. Add strikethroughs to some answer choices
4. Go to Review Screen
5. Verify:
   - Summary shows "With annotations: X"
   - QuestionBox shows üìù icon for annotated questions
   - Annotations are read-only (can't edit in review mode)

### Potential Risks
- Displaying full annotation details (actual highlight text) in review may clutter UI
- Keep it as indicator only, not full annotation viewer

---

## Implementation Order
Recommended order to implement fixes (considering dependencies):

1. **Issues 1-3 (Seed Data)** - Foundation for testing other features
   - Issue 1: FRQ test and questions (enables FRQ testing)
   - Issue 2: Mixed test (enables full flow testing)
   - Issue 3: Assignment + Class (enables assignment-based access)

2. **Issue 7: Real-time Score Updates** - High user value, independent fix
   - APReportCard onSnapshot listener
   - Most impactful for student experience

3. **Issue 4: Submit Sync Progress** - UX improvement
   - ReviewScreen UI enhancement
   - Builds on existing isSyncing/queueLength

4. **Issues 5 & 6: Timing Verification** - No code changes
   - Integration testing to confirm timing
   - Document results in test plan

5. **Issue 8: Review Mode Annotations** - Lower priority
   - Nice-to-have feature
   - Can be deferred if time-constrained

## Cross-Cutting Concerns

### Type Constants
All fixes should use constants from `src/apBoost/utils/apTypes.js`:
- `QUESTION_TYPE.FRQ`, `QUESTION_TYPE.SAQ`, `QUESTION_TYPE.DBQ`
- `SECTION_TYPE.FRQ`, `SECTION_TYPE.MCQ`
- `COLLECTIONS.TESTS`, `COLLECTIONS.QUESTIONS`, `COLLECTIONS.ASSIGNMENTS`, `COLLECTIONS.CLASSES`

### Seed Data Best Practices
- Include `createdAt: serverTimestamp()` and `updatedAt: serverTimestamp()` on all documents
- Use consistent ID patterns (`test_*`, `frq*`, `class_*`, `assignment_*`)
- Return created IDs from seed function for verification

### Firestore Patterns
- Use `onSnapshot` for real-time updates (Issue 7)
- Always handle unsubscribe in cleanup
- Include error handling for all Firestore operations

## Notes for Implementer

1. **Testing Order**: Implement seed data first (Issues 1-3) as they enable testing of other features

2. **FRQ Sub-question Structure**: Each sub-question must have:
   - `label`: Single letter (a, b, c)
   - `prompt`: The sub-question text
   - `points`: Points for this sub-question
   - `rubric`: (Optional) Grading rubric text

3. **Real-time Listener Quota**: APReportCard real-time listener (Issue 7) counts against Firestore quota. For production, consider:
   - Only enabling listener when `gradingStatus !== 'COMPLETE'`
   - Adding polling fallback for high-traffic scenarios

4. **Review Mode Annotations**: The current fix plan shows indicators only. If full annotation viewing is needed in review mode, that would require additional component work to render highlights/strikethroughs in read-only mode.

5. **Timing Verification**: Issues 5 and 6 don't require code changes but need integration testing. Create test scenarios:
   - Cross-browser: Chrome + Firefox simultaneously
   - Network offline: DevTools Network tab ‚Üí Offline
   - Document test results for QA sign-off

---

## Part 2: Codebase Facts

# CODEBASE_FACTS__20__20.1_to_20.3.md

**Generated:** 2026-01-14
**Chunk ID:** 20__20.1_to_20.3
**Source document:** Fix Plan: Sections 20.1 to 20.3 (Seed Data & Phase Verification 1-4)

---

## 1) Canonical Data Schema / Source-of-Truth

**Found: Yes**

### ap_tests Collection Schema

**Source of truth:** `src/apBoost/utils/apTypes.js` (lines 21-31, 89-98) + `src/apBoost/utils/seedTestData.js` (lines 21-48)

```javascript
// apTypes.js:21-31
export const TEST_TYPE = {
  EXAM: 'EXAM',
  MODULE: 'MODULE',
}

export const SECTION_TYPE = {
  MCQ: 'MCQ',
  FRQ: 'FRQ',
  MIXED: 'MIXED',
}
```

**Expected ap_tests fields (from seedTestData.js:21-48):**
| Field | Type | Notes |
|-------|------|-------|
| `title` | string | Test title |
| `subject` | string | e.g., 'AP_US_HISTORY' |
| `testType` | string | `TEST_TYPE.EXAM` or `TEST_TYPE.MODULE` |
| `createdBy` | string | User ID or 'system' |
| `isPublic` | boolean | Whether publicly accessible |
| `questionOrder` | string | `QUESTION_ORDER.FIXED` or `RANDOMIZED` |
| `sections[]` | array | Array of section objects (see below) |
| `scoreRanges` | object | `{ap5: {min, max}, ap4: {...}, ...}` |
| `hasFRQ` | boolean | Set by apTeacherService.js:91-93 |
| `isPublished` | boolean | apTeacherService.js:64 |
| `createdAt` | timestamp | serverTimestamp |
| `updatedAt` | timestamp | serverTimestamp |

**Section object structure:**
```javascript
{
  id: 'section1',
  title: 'Multiple Choice',
  sectionType: SECTION_TYPE.MCQ,  // or FRQ or MIXED
  timeLimit: 45,  // in minutes
  questionIds: ['q1', 'q2', ...],
  mcqMultiplier: 1.0,
  calculatorEnabled: false,
}
```

---

### ap_questions Collection Schema

**Source of truth:** `src/apBoost/services/apQuestionService.js` (lines 159-188) + `src/apBoost/utils/seedTestData.js` (lines 52-157)

**MCQ Question fields:**
| Field | Type | Notes |
|-------|------|-------|
| `testId` | string | Optional link to test |
| `subject` | string | e.g., 'AP_US_HISTORY' |
| `questionType` | string | `QUESTION_TYPE.MCQ`, `MCQ_MULTI`, `FRQ`, `SAQ`, `DBQ` |
| `format` | string | `QUESTION_FORMAT.VERTICAL` or `HORIZONTAL` |
| `questionDomain` | string | e.g., 'Unit 3: Colonial America' |
| `questionTopic` | string | More specific topic |
| `difficulty` | string | `EASY`, `MEDIUM`, `HARD` |
| `questionText` | string | The question prompt |
| `choiceA-E` | object | `{ text: "..." }` for each choice |
| `choiceCount` | number | Number of choices (typically 4) |
| `correctAnswers` | array | `['B']` for single, `['A', 'C']` for multi |
| `partialCredit` | boolean | For MCQ_MULTI |
| `explanation` | string | Answer explanation |
| `points` | number | Points for this question |
| `stimulus` | object | Optional: `{ type, content, source }` |
| `createdBy` | string | User ID |
| `createdAt` | timestamp | serverTimestamp |

**FRQ Question fields (additional):**

**Source:** `src/apBoost/services/apQuestionService.js:176`
```javascript
subQuestions: questionData.subQuestions || null,
```

**subQuestions schema (expected by UI/grading):**

**Evidence from:**
- `src/apBoost/hooks/useTestSession.js:93-104` (navigation logic)
- `src/apBoost/components/grading/GradingPanel.jsx:144, 183-216` (grading UI)

```javascript
subQuestions: [
  {
    label: 'a',      // Required: subquestion identifier
    prompt: '...',   // Optional: sub-question text
    points: 3,       // Optional: defaults to 3 in grading UI (line 209)
    rubric: '...',   // Optional: not currently used in code
  },
  { label: 'b', ... },
  { label: 'c', ... },
]
```

**Answer:** `subQuestions` is NOT strictly required - code checks with `question.subQuestions?.length > 0` (useTestSession.js:95). For FRQ without subQuestions, it's treated as a single-item question. However, grading UI (GradingPanel.jsx:183-216) expects subQuestions to exist for proper scoring.

---

### ap_classes Collection Schema

**Source of truth:** `src/apBoost/services/apTeacherService.js` (lines 160-178, 186-223)

**Expected fields:**
| Field | Type | Notes |
|-------|------|-------|
| `teacherId` | string | Teacher's user ID (queried at line 165) |
| `name` | string | Class name (ordered by at line 166) |
| `studentIds` | array | Array of student user IDs (line 195) |
| `subject` | string | Not explicitly in code, inferred from spec |

---

### ap_assignments Collection Schema

**Source of truth:** `src/apBoost/services/apTeacherService.js` (lines 230-251)

```javascript
// apTeacherService.js:234-245
const newAssignment = {
  testId: assignmentData.testId,
  classIds: assignmentData.classIds || [],
  studentIds: assignmentData.studentIds || [],
  dueDate: assignmentData.dueDate || null,
  maxAttempts: assignmentData.maxAttempts || 1,
  frqSubmissionType: assignmentData.frqSubmissionType || 'TYPED',
  assignedBy: assignmentData.assignedBy,
  assignedAt: serverTimestamp(),
}
```

**Note:** `availableFrom` is NOT currently in the schema (not found in codebase). Only `dueDate` exists.

---

### ap_test_results Collection Schema

**Source of truth:** `src/apBoost/services/apScoringService.js` (lines 127-154) + `src/apBoost/services/apGradingService.js` (lines 165-206)

**Fields from createTestResult (apScoringService.js:127-154):**
```javascript
{
  userId, testId, classId, assignmentId, attemptNumber, isFirstAttempt, sessionId,
  answers,
  score, maxScore, percentage, apScore,
  sectionScores,  // { 0: { correct, total, points } }
  mcqResults,     // [{ questionId, studentAnswer, correctAnswer, correct }]
  frqSubmissionType, frqUploadedFiles, frqAnswers, frqMaxPoints,
  frqScore: null,       // Set after grading
  annotatedPdfUrl: null,
  frqGrades: null,
  gradingStatus,  // PENDING, IN_PROGRESS, COMPLETE, NOT_NEEDED
  startedAt, completedAt, gradedAt: null,
}
```

**Fields updated by saveGrade (apGradingService.js:169-206):**
```javascript
{
  frqGrades: grades,     // { [questionId]: { subScores: { a: 2, b: 3 }, comment: "...", maxPoints: N } }
  gradingStatus: status,
  gradedBy: teacherId,
  gradedAt: serverTimestamp(),
  annotatedPdfUrl,       // Optional
  // When status === COMPLETE:
  frqScore,              // Calculated from grades
  score,                 // mcqScore + frqScore
  maxScore,              // mcqMaxPoints + frqMaxPoints
  percentage,            // Recalculated
  apScore,               // Recalculated via calculateAPScore()
}
```

---

### SECTION_TYPE.MIXED Usage

**Answer:** `SECTION_TYPE.MIXED` is **defined** in `apTypes.js:30` but **rarely used at runtime**.

**Evidence:**
- `apTeacherService.js:91-93` checks for MIXED when setting `hasFRQ`:
  ```javascript
  hasFRQ = updates.sections.some(section =>
    section.sectionType === 'FRQ' || section.sectionType === 'MIXED'
  )
  ```
- `apScoringService.js:122-123` checks for FRQ or MIXED to set grading status:
  ```javascript
  const hasFRQ = test.sections.some(s => s.sectionType === SECTION_TYPE.FRQ || s.sectionType === SECTION_TYPE.MIXED)
  ```
- **Runtime navigation** in `useTestSession.js` uses `flatNavigationItems` which iterates over `currentSection.questionIds` and checks individual question types (`QUESTION_TYPE.FRQ`, `SAQ`, `DBQ`) - not section type.

**Conclusion:** Mixed tests currently work by having **two separate sections** (one MCQ, one FRQ), not a single `SECTION_TYPE.MIXED` section. The MIXED type exists but is not heavily utilized in section transitions.

---

## 2) Write Paths

**Found: Yes**

### 2.1 Seed Writes

**Entry function:** `seedAPTestData()` in `src/apBoost/utils/seedTestData.js`

**What is written:**
| Collection | Document ID | Method |
|------------|-------------|--------|
| `ap_tests` | `test_apush_practice_1` | `setDoc()` - line 21 |
| `ap_questions` | `q1` - `q5` | `setDoc()` - line 162 |

**Trigger:** Manual invocation - console or import (line 4: "Run this in the browser console or import and call seedAPTestData()")

**Idempotency:** Uses `setDoc()` which overwrites - idempotent by design.

**Gap:** Currently only seeds MCQ test and questions. No FRQ/class/assignment seed data.

---

### 2.2 Offline Queue Writes

**Entry function:** `addToQueue()` in `src/apBoost/hooks/useOfflineQueue.js` (lines 125-160)

**Storage:** IndexedDB database `ap_boost_queue`, store `actions` (lines 8-10)

**Queue item structure (lines 131-138):**
```javascript
{
  id: generateId(),
  sessionId,
  localTimestamp: Date.now(),
  action: action.action,    // ANSWER_CHANGE, FLAG_TOGGLE, NAVIGATION, TIMER_SYNC
  payload: action.payload,
  status: 'PENDING',
}
```

**Flush behavior (`flushQueue()` lines 173-266):**
1. Reads all PENDING items from IndexedDB for sessionId
2. Builds Firestore update object from actions
3. Writes to `ap_session_state/{sessionId}` via `updateDoc()`
4. Deletes processed items from IndexedDB
5. Exponential backoff retry on failure (2s, 4s, 8s, 16s)

**Idempotency:** Each queue item has unique ID. Last-write-wins for answer changes.

---

### 2.3 Submit Flow Writes

**Entry function:** `submitTest()` in `src/apBoost/hooks/useTestSession.js` (lines 396-421)

**Flow:**
```javascript
// useTestSession.js:396-421
const submitTest = useCallback(async (frqData = null) => {
  // 1. Stop timer
  timer.pause()

  // 2. Flush queue if pending items exist
  if (queueLength > 0) {
    await flushQueue()  // <-- Guaranteed flush before result creation
  }

  // 3. Create test result
  const resultId = await createTestResult(session.id, frqData)
  return resultId
}, [session?.id, isSubmitting, timer, queueLength, flushQueue])
```

**createTestResult() (apScoringService.js:67-166):**
1. Gets session from Firestore
2. Gets test with questions
3. Calculates MCQ scores per section
4. Creates result document via `setDoc()` with deterministic ID: `{userId}_{testId}_{attemptNumber}`
5. Marks session as completed via `completeSession()`

**Idempotency:** Document ID is deterministic - overwrites existing result for same attempt.

---

### 2.4 Grading Writes

**Entry function:** `saveGrade()` in `src/apBoost/services/apGradingService.js` (lines 165-211)

**What is written:**
- Collection: `ap_test_results`
- Fields updated: `frqGrades`, `gradingStatus`, `gradedBy`, `gradedAt`
- When `status === COMPLETE`: also `frqScore`, `score`, `maxScore`, `percentage`, `apScore`

**Score recalculation (lines 182-203):**
```javascript
if (status === GRADING_STATUS.COMPLETE) {
  const frqScore = calculateFRQScore(grades)
  updateData.frqScore = frqScore

  // Get current result to update totals
  const resultSnap = await getDoc(resultRef)
  const resultData = resultSnap.data()
  const mcqScore = resultData.mcqScore || 0
  // ...
  updateData.score = mcqScore + frqScore
  updateData.percentage = Math.round((updateData.score / updateData.maxScore) * 100)
  updateData.apScore = calculateAPScore(updateData.percentage)
}
```

**Idempotency:** Uses `updateDoc()` - last write wins.

---

## 3) Offline/Resilience Mechanics

**Found: Yes**

### 3.1 Queue Storage

**Location:** IndexedDB
- Database name: `ap_boost_queue` (useOfflineQueue.js:9)
- Store name: `actions` (useOfflineQueue.js:10)
- Key: `id` (auto-generated)
- Indexes: `sessionId`, `status` (lines 32-33)

### 3.2 flushQueue Mechanics

**Source:** `src/apBoost/hooks/useOfflineQueue.js:173-266`

| State | Location | Description |
|-------|----------|-------------|
| `isFlushing` | line 54 | True while flush in progress |
| `queueLength` | line 52 | Count of pending items for current session |
| `isOnline` | line 53 | `navigator.onLine` state |

**Progress reporting:** Currently `queueLength` is exposed (line 280) but NOT shown in ReviewScreen UI. The `isSyncing` prop is passed but only shows "Syncing your progress..." message, not item count.

### 3.3 Heartbeat + Connectivity

**Source:** `src/apBoost/hooks/useHeartbeat.js`

**Constants (lines 9-10):**
```javascript
const HEARTBEAT_INTERVAL = 15000  // 15 seconds
const MAX_FAILURES = 3
```

**`isConnected` derivation (lines 70-76):**
```javascript
setFailureCount(prev => {
  const newCount = prev + 1
  if (newCount >= MAX_FAILURES) {
    setIsConnected(false)  // Flips after 3 failures
  }
  return newCount
})
```

**Flow to UI:**
- `useHeartbeat()` returns `isConnected` (line 122)
- `useTestSession()` exposes it (line 498)
- `APTestSession` passes to `ConnectionStatus` (lines 277, 333, 361, 392)

**ConnectionStatus display (ConnectionStatus.jsx:41-48):**
```javascript
// Disconnected state shows when isConnected=false AND not syncing
return (
  <div className="bg-warning ...">
    <span>Connection unstable - your progress is being saved locally</span>
  </div>
)
```

### 3.4 Duplicate Tab / Cross-Browser Takeover

**Same-browser detection:** `BroadcastChannel` in `useDuplicateTabGuard.js:71-97`
- Channel name: `ap_session_${sessionId}`
- Listens for `SESSION_CLAIMED` messages
- Instant detection within same browser

**Cross-browser detection:** Firestore `sessionToken` in `useHeartbeat.js:47-50`
```javascript
// Check if another tab took over
if (sessionData.sessionToken && sessionData.sessionToken !== instanceToken) {
  setSessionTakenOver(true)
  return
}
```

**Detection timing:**
- Same browser: Instant via BroadcastChannel
- Cross-browser: Up to `HEARTBEAT_INTERVAL` (15s) for detection
- **Conditions that extend timing:** If network is slow/offline, heartbeat may fail before detecting takeover. Heartbeat timeout (`TIMEOUTS.HEARTBEAT`) could add delay.

**Modal trigger:** `DuplicateTabModal` shown when `isInvalidated` (line 395 in APTestSession.jsx)

---

## 4) UI/Flow Entry Points

**Found: Yes**

### 4.1 Dashboard to Test Session Flow

```
APDashboard (/ap)
    ‚Üì click TestCard
navigate(`/ap/test/${testId}`) or navigate(`/ap/test/${testId}/assignment/${assignmentId}`)
    ‚Üì
APTestSession (/ap/test/:testId or /ap/test/:testId/assignment/:assignmentId)
    ‚Üì view='instruction'
InstructionScreen (shows test info, Resume/Begin button)
    ‚Üì handleBegin() ‚Üí startTest()
view='testing' (main test UI)
    ‚Üì handleGoToReview()
view='review' ‚Üí ReviewScreen
    ‚Üì handleSubmit() ‚Üí submitTest()
navigate(`/ap/results/${resultId}`)
    ‚Üì
APReportCard (/ap/results/:resultId)
```

### 4.2 ReviewScreen Props

**Source:** `APTestSession.jsx:368-383`
```javascript
<ReviewScreen
  section={currentSection}
  questions={sectionQuestions}
  answers={answers}
  flags={flags}
  onGoToQuestion={(idx) => {...}}
  onSubmit={handleSubmit}
  onCancel={handleReturnFromReview}
  isSubmitting={isSubmitting}
  isFinalSection={position.sectionIndex === (test?.sections?.length || 1) - 1}
/>
```

**NOT currently passed:** `isSyncing`, `queueLength` - these are available in `useTestSession` but not forwarded to ReviewScreen.

### 4.3 ConnectionStatus Props

**Source:** `APTestSession.jsx:392`
```javascript
<ConnectionStatus isConnected={isConnected} isSyncing={isSyncing} />
```

**Rendered in:** Multiple views (frqChoice, frqHandwritten, review, main testing)

### 4.4 APReportCard Data Loading

**Source:** `APReportCard.jsx:271-297`
```javascript
useEffect(() => {
  async function loadResult() {
    const resultData = await getTestResult(resultId)  // getDoc - one-time fetch
    setResult(resultData)
    const testData = await getTestMeta(resultData.testId)
    setTest(testData)
  }
  if (resultId) {
    loadResult()
  }
}, [resultId])
```

**Answer:** Uses `getDoc()` only (one-time fetch). **No `onSnapshot` listener** currently implemented for real-time updates.

### 4.5 Annotations in Session vs Review

**Session mode:** `APTestSession.jsx:91-141`
- `useAnnotations()` hook provides highlights, strikethroughs, line reader
- Passed to `QuestionDisplay` (lines 423-435)
- `currentHighlights`, `currentStrikethroughs` computed per question

**Review mode:** `ReviewScreen.jsx` does **NOT** receive annotation props.
- ReviewScreen only shows question boxes (answered/flagged status)
- No highlight/strikethrough indicators visible in review grid

**Storage:** Annotations are keyed by `questionId` in Maps:
- `highlights: Map<questionId, HighlightRange[]>` (useAnnotations.js:22)
- `strikethroughs: Map<questionId, Set<choiceId>>` (useAnnotations.js:25)

---

## 5) Must-Answer Questions (from checklist)

**Found: Yes**

### Question 1: Does `seedAPTestData()` currently seed only one MCQ test?

**Answer: Yes**

**Evidence:** `src/apBoost/utils/seedTestData.js:20-48`
- Single test ID: `test_apush_practice_1`
- Single section with `sectionType: SECTION_TYPE.MCQ`
- 5 MCQ questions (`q1` - `q5`)

```javascript
// seedTestData.js:20-21
const testId = 'test_apush_practice_1'
await setDoc(doc(db, COLLECTIONS.TESTS, testId), {...})
```

Collections written: `ap_tests`, `ap_questions` only.

---

### Question 2: Is there already any FRQ/SAQ/DBQ seed logic or subQuestions usage?

**Answer: No (in seed data)**

**Evidence:** Searched `seedTestData.js` - no FRQ questions, no `subQuestions` field populated.

**subQuestions schema expected by UI (from GradingPanel.jsx:144, 183-216):**
```javascript
subQuestions: [
  { label: 'a', prompt: '...', points: 3, rubric: '...' },
  { label: 'b', ... },
]
```

**UI usage:**
- `useTestSession.js:95-104`: Iterates `question.subQuestions` for flat navigation
- `GradingPanel.jsx:183-216`: Renders sub-question grading inputs
- `APReportCard.jsx:125-145`: Displays FRQ answers by sub-question label

---

### Question 3: For mixed tests, does runtime expect separate sections or MIXED type?

**Answer: Separate sections (MCQ + FRQ)**

**Evidence:**
- `apScoringService.js:88-115`: Iterates `test.sections` and checks `section.sectionType === SECTION_TYPE.MCQ` individually
- `useTestSession.js:58-66`: `currentSection` is determined by `currentSectionIndex`
- Section transition: `submitSection()` at line 386-393 increments `currentSectionIndex`

**SECTION_TYPE.MIXED:** Exists in type definitions but actual scoring logic only handles MCQ sections with FRQ scoring deferred to grading.

---

### Question 4: Are assignments/classes already used in teacher/student flows?

**Answer: Yes (partially)**

**Teacher side:**
- `apTeacherService.js`: `getTeacherClasses()` (line 160), `createAssignment()` (line 230)
- `AssignTestModal.jsx`: Uses `createAssignment()` (line 114)

**Student side:**
- `APDashboard.jsx:48-52`: Shows `assignment.dueDate` if present
- `APTestSession.jsx:40`: Receives `assignmentId` from route params
- `useTestSession.js:228`: Passes `assignmentId` to `createOrResumeSession()`

**Fields queried:** `testId`, `classIds`, `studentIds`, `dueDate`, `assignedBy`, `assignedAt`

**Gap:** No `availableFrom` field in current schema.

---

### Question 5: Is flushQueue() guaranteed before result creation when queueLength > 0?

**Answer: Yes**

**Evidence:** `useTestSession.js:405-408`
```javascript
// Flush any pending changes first
if (queueLength > 0) {
  await flushQueue()  // Awaited before createTestResult
}
const resultId = await createTestResult(session.id, frqData)
```

The `await flushQueue()` blocks until flush completes. Sequential execution guaranteed.

---

### Question 6: Is there UI state for "syncing X items" in ReviewScreen?

**Answer: No**

**Evidence:**
- `ReviewScreen.jsx:34-44` props: `section`, `questions`, `answers`, `flags`, `onGoToQuestion`, `onSubmit`, `onCancel`, `isSubmitting`, `isFinalSection`
- **NOT present:** `isSyncing`, `queueLength`

**Where it would come from:** `useTestSession` already exposes `isSyncing` (line 500) and `queueLength` (line 501). Would need to be passed through `APTestSession.jsx` to `ReviewScreen`.

---

### Question 7: Is cross-browser takeover detection strictly bounded to 15s?

**Answer: No - 15s in normal cases, potentially longer**

**Normal case:** Heartbeat runs every 15s (`HEARTBEAT_INTERVAL`), so detection within 15s.

**Conditions that extend it:**
1. **Network timeout:** `TIMEOUTS.HEARTBEAT` (from withTimeout.js) adds timeout duration
2. **Visibility hidden:** Heartbeat runs on visibility change (line 102-113), but if tab stays hidden, no extra heartbeat
3. **Offline period:** If offline when takeover happens, won't detect until back online

```javascript
// useHeartbeat.js:31-36
const sessionDoc = await withTimeout(
  getDoc(doc(db, COLLECTIONS.SESSION_STATE, sessionId)),
  TIMEOUTS.HEARTBEAT,  // Could add delay
  'Heartbeat read'
)
```

---

### Question 8: Connection unstable banner timing and display

**Answer: Flips after MAX_FAILURES (3) failures**

**Evidence:** `useHeartbeat.js:70-76`
```javascript
setFailureCount(prev => {
  const newCount = prev + 1
  if (newCount >= MAX_FAILURES) {  // MAX_FAILURES = 3
    setIsConnected(false)
  }
  return newCount
})
```

**Display:** Yes, shown in APTestSession via `ConnectionStatus` component.

**Message:** `"Connection unstable - your progress is being saved locally"` (ConnectionStatus.jsx:44-45)

---

### Question 9: What fields change when teacher marks complete?

**Answer:** Multiple fields updated in `saveGrade()`

**Evidence:** `apGradingService.js:169-206`

```javascript
// Always updated:
frqGrades, gradingStatus, gradedBy, gradedAt

// When status === COMPLETE (lines 182-203):
frqScore       // calculateFRQScore(grades)
score          // mcqScore + frqScore
maxScore       // mcqMaxPoints + frqMaxPoints
percentage     // Math.round((score / maxScore) * 100)
apScore        // calculateAPScore(percentage)
annotatedPdfUrl // If provided
```

**Recalculation confirmed:** Yes, `saveGrade()` recalculates totals.

---

### Question 10: Does APReportCard use getDoc or onSnapshot?

**Answer: getDoc only (one-time fetch)**

**Evidence:** `APReportCard.jsx:277`
```javascript
const resultData = await getTestResult(resultId)
```

`getTestResult()` in `apScoringService.js:173-184`:
```javascript
const resultDoc = await getDoc(doc(db, COLLECTIONS.TEST_RESULTS, resultId))
```

**No onSnapshot:** Not currently implemented. No automatic refresh mechanism.

---

### Question 11: Does ReviewScreen receive annotation props?

**Answer: No**

**Evidence:** `ReviewScreen.jsx:34-44` - no highlight/strikethrough props accepted.

**Where annotations stored:**
- `useAnnotations.js:22-25`:
  ```javascript
  const [highlights, setHighlights] = useState(new Map())     // Map<questionId, HighlightRange[]>
  const [strikethroughs, setStrikethroughs] = useState(new Map())  // Map<questionId, Set<choiceId>>
  ```
- Keyed by `questionId`
- Only used in `QuestionDisplay` during testing view, not review

---

### Question 12: Idempotency safeguards for annotations and submission?

**Answer: Partial**

**Annotations:**
- Queue items have unique IDs (`generateId()` at useOfflineQueue.js:42-44)
- Last-write-wins for same action type/questionId
- No explicit dedupe logic for identical actions

**Submission:**
- Result document ID is deterministic: `{userId}_{testId}_{attemptNumber}` (apScoringService.js:126)
- `setDoc()` overwrites - prevents duplicates
- `isSubmitting` state prevents concurrent submits (useTestSession.js:397)

**Gap:** No explicit idempotency key for queued actions beyond unique ID. Duplicate actions (e.g., two ANSWER_CHANGE for same question) would both be processed, but last wins.

---

## Summary of Key Gaps Identified

1. **Seed data:** Only MCQ test, no FRQ/class/assignment data
2. **ReviewScreen:** Missing `isSyncing`/`queueLength` props for sync progress UI
3. **APReportCard:** No real-time listener - uses one-time `getDoc()`
4. **Review mode annotations:** Not displayed in ReviewScreen
5. **Assignment schema:** Missing `availableFrom` field
6. **SECTION_TYPE.MIXED:** Defined but not fully utilized in runtime logic
