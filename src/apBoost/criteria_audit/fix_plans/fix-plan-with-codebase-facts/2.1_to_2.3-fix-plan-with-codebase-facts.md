# Section 2.1 to 2.3 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 2.1 to 2.3:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 2.1 to 2.3

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_2.1_to_2.3_criteria_audit.md

## Executive Summary
- Total Issues: 6
- ⚠️ Partial Implementations: 4
- ❌ Missing Features: 2
- ❓ Needs Investigation: 0
- Estimated Complexity: **Medium-High**

All issues are related to MCQ_MULTI (Multiple Choice - Multiple Answers) functionality. The data model and question creation support MCQ_MULTI, but the runtime UI and scoring do not.

---

## Issue 1: MCQ_MULTI Question Text Display Missing "Select All That Apply" Indicator

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Displays question text (for MCQ_MULTI)
- **Current State:** Uses same QuestionDisplay component as MCQ - works, but no visual indicator that multiple selections are allowed

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/QuestionDisplay.jsx` (lines 48-164) - Main question display component
  - `src/apBoost/pages/APTestSession.jsx` (lines 416-456) - Renders QuestionDisplay with question prop
- **Current Implementation:** QuestionDisplay renders question text at lines 130-132 (HORIZONTAL) and 156-157 (VERTICAL), but has no awareness of question type for MCQ variations
- **Gap:** No "Select all that apply" or similar hint displayed for MCQ_MULTI questions
- **Dependencies:** Needs `question.questionType` to be passed through to display

### Fix Plan

#### Step 1: Add MCQ_MULTI indicator in QuestionDisplay.jsx
**File:** `src/apBoost/components/QuestionDisplay.jsx`
**Action:** Modify
**Details:**
- Import `QUESTION_TYPE` from `../utils/apTypes`
- Add check for `question.questionType === QUESTION_TYPE.MCQ_MULTI` after question text
- Add visual hint: `<p className="text-text-muted text-sm italic mt-1">Select all that apply</p>`
- Apply to both HORIZONTAL (after line 131) and VERTICAL (after line 157) layouts

**Code Pattern Reference:**
```jsx
// After question text, add:
{question.questionType === QUESTION_TYPE.MCQ_MULTI && (
  <p className="text-text-muted text-sm italic mt-1">Select all that apply</p>
)}
```

### Verification Steps
1. Create or load an MCQ_MULTI question in test session
2. Verify "Select all that apply" text appears below question text
3. Verify hint does NOT appear for regular MCQ questions
4. Test both VERTICAL and HORIZONTAL layouts

### Potential Risks
- None - purely additive visual change

---

## Issue 2: AnswerInput Does Not Support Checkbox Behavior for MCQ_MULTI

### Audit Finding
- **Status:** ❌ Missing (CRITICAL)
- **Criterion:** Displays answer options with checkboxes
- **Current State:** AnswerInput.jsx uses the SAME radio-button-style interface for all MCQ types. No checkbox implementation exists for MCQ_MULTI.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/AnswerInput.jsx` (lines 1-107) - Current MCQ answer component
  - `src/apBoost/pages/APTestSession.jsx` (lines 446-455) - Where AnswerInput is rendered
  - `src/apBoost/utils/apTypes.js` (line 8) - `QUESTION_TYPE.MCQ_MULTI` constant
- **Current Implementation:**
  - Line 36: `isSelected = selectedAnswer === letter` - compares single string value
  - Line 45: `onClick={() => !disabled && onSelect(letter)}` - passes single letter
  - No differentiation between MCQ and MCQ_MULTI types
- **Gap:** No checkbox UI, no array-based selection, no support for multiple selections
- **Dependencies:**
  - `APTestSession.jsx` passes `selectedAnswer` (single value) and `onSelect` (single callback)
  - `useTestSession.js` stores single answer for MCQ questions

### Fix Plan

#### Step 1: Add questionType prop and multi-select logic to AnswerInput
**File:** `src/apBoost/components/AnswerInput.jsx`
**Action:** Modify
**Details:**
- Add `questionType` prop to the component signature (default to `QUESTION_TYPE.MCQ`)
- Import `QUESTION_TYPE` from `../utils/apTypes`
- Determine if multi-select: `const isMultiSelect = questionType === QUESTION_TYPE.MCQ_MULTI`
- For multi-select mode:
  - Change `isSelected` check: `isSelected = Array.isArray(selectedAnswer) && selectedAnswer.includes(letter)`
  - Change click handler: toggle letter in array instead of replacing
- Add checkbox visual indicator for MCQ_MULTI (replace radio dot with checkbox square)

**Updated Component Signature:**
```jsx
export default function AnswerInput({
  question,
  questionType = 'MCQ', // NEW PROP
  selectedAnswer,
  onSelect,
  disabled = false,
  strikethroughs = new Set(),
  onStrikethrough,
}) {
```

**Multi-select Logic:**
```jsx
const isMultiSelect = questionType === QUESTION_TYPE.MCQ_MULTI

// For isSelected check:
const isSelected = isMultiSelect
  ? Array.isArray(selectedAnswer) && selectedAnswer.includes(letter)
  : selectedAnswer === letter

// For click handler:
onClick={() => {
  if (disabled) return
  if (isMultiSelect) {
    const current = Array.isArray(selectedAnswer) ? selectedAnswer : []
    if (current.includes(letter)) {
      onSelect(current.filter(l => l !== letter))
    } else {
      onSelect([...current, letter].sort())
    }
  } else {
    onSelect(letter)
  }
}}
```

#### Step 2: Add visual checkbox indicator for MCQ_MULTI
**File:** `src/apBoost/components/AnswerInput.jsx`
**Action:** Modify
**Details:**
- In the choice letter badge (lines 57-65), conditionally render checkbox vs radio style
- For MCQ_MULTI: use square checkbox icon
- For MCQ: keep current circular badge

**Code Pattern:**
```jsx
{/* Choice indicator - checkbox for multi, radio for single */}
{isMultiSelect ? (
  <span className={`
    inline-flex items-center justify-center w-5 h-5 rounded shrink-0 border-2
    ${isSelected
      ? 'bg-brand-primary border-brand-primary text-white'
      : 'border-border-default bg-surface'
    }
  `}>
    {isSelected && (
      <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
      </svg>
    )}
  </span>
) : (
  <span className={`
    inline-flex items-center justify-center w-6 h-6 rounded-full text-sm font-medium shrink-0
    ${isSelected ? 'bg-white/20 text-white' : 'bg-muted text-text-secondary'}
  `}>
    {letter}
  </span>
)}
```

#### Step 3: Update APTestSession to pass questionType
**File:** `src/apBoost/pages/APTestSession.jsx`
**Action:** Modify
**Details:**
- Pass `questionType={currentQuestion?.questionType}` prop to AnswerInput (around line 447)

**Code Change:**
```jsx
<AnswerInput
  question={currentQuestion}
  questionType={currentQuestion?.questionType}  // ADD THIS
  selectedAnswer={currentAnswer}
  onSelect={setAnswer}
  disabled={isSubmitting || isInvalidated}
  strikethroughs={currentStrikethroughs}
  onStrikethrough={handleStrikethrough}
/>
```

### Verification Steps
1. Create an MCQ_MULTI question with correct answers A and C
2. Start a test session with this question
3. Verify checkbox-style UI appears (not radio buttons)
4. Click A - verify it's selected
5. Click C - verify BOTH A and C are selected
6. Click A again - verify only C remains selected
7. Verify regular MCQ still uses radio-button behavior

### Potential Risks
- **Risk:** Existing answer data format mismatch
  - **Mitigation:** The `isSelected` check handles both string and array formats gracefully
- **Risk:** Click handler complexity
  - **Mitigation:** Sort array to ensure consistent storage order

---

## Issue 3: Multiple Options Cannot Be Selected Simultaneously

### Audit Finding
- **Status:** ❌ Missing (CRITICAL)
- **Criterion:** Multiple options can be selected simultaneously
- **Current State:** `selectedAnswer === letter` and `onSelect(letter)` only support single selection. No array-based multi-select logic exists.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/hooks/useTestSession.js` (lines 327-359) - setAnswer callback
  - `src/apBoost/hooks/useTestSession.js` (lines 311-325) - currentAnswer getter
- **Current Implementation:**
  - Line 344: `next.set(questionId, answer)` - stores answer directly (string for MCQ)
  - Line 316: `answers.get(questionId)` - retrieves stored value
  - No special handling for array values for MCQ_MULTI
- **Gap:** The hook's setAnswer and currentAnswer work with any value type, but the calling code (APTestSession + AnswerInput) only uses string values
- **Dependencies:** Issue 2 fix enables array passing; this issue is about ensuring data flows correctly

### Fix Plan

#### Step 1: Verify useTestSession handles array values (already does)
**File:** `src/apBoost/hooks/useTestSession.js`
**Action:** Verify (no change needed)
**Details:**
- The `setAnswer` callback at lines 327-359 already handles any answer value
- For non-FRQ questions, line 344 stores `answer` directly without type coercion
- This means arrays will work correctly once Issue 2 is fixed

#### Step 2: Update currentAnswer to handle array for MCQ_MULTI
**File:** `src/apBoost/hooks/useTestSession.js`
**Action:** Verify (likely no change needed)
**Details:**
- Line 316: `const answer = answers.get(questionId)` returns the stored value
- Lines 320-322 only apply to FRQ with sub-questions
- For MCQ/MCQ_MULTI, line 324 returns the raw answer (string or array)

**Conclusion:** No changes needed to useTestSession.js - it already supports any answer value type.

### Verification Steps
1. After Issue 2 is implemented, select multiple answers for MCQ_MULTI
2. Navigate away and back - verify selections persist
3. Check browser dev tools: `answers.get(questionId)` should return array like `["A", "C"]`

### Potential Risks
- None - the hook is already type-agnostic

---

## Issue 4: correctAnswers Array for MCQ_MULTI Not Utilized at Runtime

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** correctAnswers array contains multiple values (e.g., ["A", "C"])
- **Current State:** The data model supports MCQ_MULTI as a type constant and questions can be created with multiple correct answers in APQuestionEditor, but the runtime answer-selection UI does not support it

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APQuestionEditor.jsx` (lines 181-193) - Creates correctAnswers array
  - `src/apBoost/services/apScoringService.js` (lines 23-45) - Uses correctAnswers for scoring
- **Current Implementation:**
  - APQuestionEditor correctly stores `correctAnswers: ["A", "C"]` for MCQ_MULTI
  - apScoringService.js line 35: `correctAnswers.includes(studentAnswer)` - only works for single string
- **Gap:** The correctAnswers array is stored correctly; the gap is in scoring (Issue 5/6) and UI (Issue 2)
- **Dependencies:** This is addressed by Issues 2 and 5/6

### Fix Plan

This issue is resolved by implementing Issues 2, 5, and 6. No additional changes needed.

### Verification Steps
1. Create MCQ_MULTI question with correct answers A and C
2. In Firestore, verify `correctAnswers: ["A", "C"]` is stored
3. After Issues 2/5/6, verify scoring correctly compares arrays

### Potential Risks
- None - data model is correct

---

## Issue 5: MCQ_MULTI Partial Credit Scoring Not Implemented

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** If partialCredit: true, partial points awarded for partially correct selections
- **Current State:** `partialCredit` field is set when creating MCQ_MULTI questions, but `calculateMCQScore()` only checks `correctAnswers.includes(studentAnswer)` - no partial credit calculation implemented

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/services/apScoringService.js` (lines 23-45) - calculateMCQScore function
  - `src/apBoost/pages/APQuestionEditor.jsx` (line 248) - Sets `partialCredit = true` for MCQ_MULTI
- **Current Implementation:**
  - Line 35-37: Only checks `correctAnswers.includes(studentAnswer)` - single answer comparison
  - No array comparison logic
  - `partialCredit` field is stored but never read during scoring
- **Gap:** Need to implement array comparison and partial credit formula
- **Dependencies:** Need student answers stored as arrays (Issue 2/3)

### Fix Plan

#### Step 1: Create calculateMCQMultiScore helper function
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Add new function
**Details:**
- Add new function `calculateMCQMultiScore(studentAnswer, correctAnswers, partialCredit)`
- Implement partial credit formula: `score = correct_selections - wrong_selections` (minimum 0)
- Implement all-or-nothing: exact array match required

**New Function (add after line 45):**
```javascript
/**
 * Calculate score for MCQ_MULTI question
 * @param {Array} studentAnswer - Array of selected letters (e.g., ["A", "C"])
 * @param {Array} correctAnswers - Array of correct letters (e.g., ["A", "C"])
 * @param {boolean} partialCredit - Whether to allow partial credit
 * @returns {number} Score (0 to 1 for partial, 0 or 1 for all-or-nothing)
 */
function calculateMCQMultiScore(studentAnswer, correctAnswers, partialCredit) {
  // Normalize inputs
  const selected = Array.isArray(studentAnswer) ? studentAnswer : []
  const correct = Array.isArray(correctAnswers) ? correctAnswers : []

  if (correct.length === 0) return 0

  // Count correct and incorrect selections
  let correctCount = 0
  let incorrectCount = 0

  for (const letter of selected) {
    if (correct.includes(letter)) {
      correctCount++
    } else {
      incorrectCount++
    }
  }

  // Check for missed correct answers
  const missedCount = correct.length - correctCount

  if (partialCredit) {
    // Partial credit formula: (correct - wrong) / total_correct, minimum 0
    const rawScore = (correctCount - incorrectCount) / correct.length
    return Math.max(0, rawScore)
  } else {
    // All-or-nothing: must select exactly the correct answers
    return (correctCount === correct.length && incorrectCount === 0) ? 1 : 0
  }
}
```

#### Step 2: Update calculateMCQScore to handle MCQ_MULTI
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Modify calculateMCQScore function
**Details:**
- Import QUESTION_TYPE if not already imported
- Check question type before scoring
- For MCQ_MULTI, use new calculateMCQMultiScore function
- For MCQ, keep existing single-answer logic

**Modified calculateMCQScore (lines 23-45):**
```javascript
export function calculateMCQScore(answers, questions, section) {
  let correct = 0
  let total = 0
  let partialPoints = 0

  for (const questionId of section.questionIds || []) {
    const question = questions[questionId]
    if (!question) continue

    total++
    const studentAnswer = answers[questionId]
    const correctAnswers = question.correctAnswers || []

    // Check if MCQ_MULTI
    if (question.questionType === QUESTION_TYPE.MCQ_MULTI) {
      const score = calculateMCQMultiScore(
        studentAnswer,
        correctAnswers,
        question.partialCredit !== false // Default to true for MCQ_MULTI
      )
      partialPoints += score
      if (score === 1) correct++
    } else {
      // Standard MCQ - single answer
      if (correctAnswers.includes(studentAnswer)) {
        correct++
        partialPoints += 1
      }
    }
  }

  // Apply multiplier if present
  const multiplier = section.mcqMultiplier || 1
  const points = partialPoints * multiplier

  return { correct, total, points }
}
```

#### Step 3: Update imports in apScoringService.js
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Modify imports
**Details:**
- Add `QUESTION_TYPE` to imports from `../utils/apTypes`

**Updated import (line 12):**
```javascript
import { COLLECTIONS, GRADING_STATUS, SECTION_TYPE, DEFAULT_SCORE_RANGES, QUESTION_TYPE } from '../utils/apTypes'
```

### Verification Steps
1. Create MCQ_MULTI question with correct answers ["A", "C"] and partialCredit: true
2. Student selects ["A"] only
   - Expected: 50% credit (1 correct, 0 wrong, 2 total)
3. Student selects ["A", "C"]
   - Expected: 100% credit
4. Student selects ["A", "B"]
   - Expected: 0% credit (1 correct - 1 wrong = 0)
5. Student selects ["A", "C", "D"]
   - Expected: 50% credit (2 correct - 1 wrong = 1, 1/2 = 0.5)

### Potential Risks
- **Risk:** Existing test results might have string answers for MCQ_MULTI
  - **Mitigation:** calculateMCQMultiScore handles non-array input gracefully (returns 0)
- **Risk:** Partial credit formula may need adjustment
  - **Mitigation:** Document the formula; can be tweaked later

---

## Issue 6: MCQ_MULTI All-or-Nothing Scoring Not Implemented

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** If partialCredit: false, must select exactly the correct options for credit
- **Current State:** Scoring logic does not handle array comparisons for multi-select answers

### Code Analysis
- Same as Issue 5
- **Gap:** No exact-match array comparison exists

### Fix Plan

This is addressed in Issue 5, Step 1 - the `calculateMCQMultiScore` function handles both:
- `partialCredit: true` - partial credit formula
- `partialCredit: false` - exact match required

### Verification Steps
1. Create MCQ_MULTI question with correct answers ["A", "C"] and partialCredit: false
2. Student selects ["A"] only
   - Expected: 0% credit (not exact match)
3. Student selects ["A", "C"]
   - Expected: 100% credit (exact match)
4. Student selects ["A", "C", "D"]
   - Expected: 0% credit (extra selection)
5. Student selects ["C", "A"]
   - Expected: 100% credit (order doesn't matter)

### Potential Risks
- None - covered by Issue 5 implementation

---

## Implementation Order

Recommended order to implement fixes (considering dependencies):

1. **Issue 2: AnswerInput Checkbox Behavior** - FIRST
   - This is the foundation - enables students to select multiple answers
   - Includes passing questionType prop from APTestSession
   - Without this, no other fixes can be tested

2. **Issue 1: "Select All That Apply" Indicator** - SECOND
   - Simple visual enhancement
   - Can be done in parallel with Issue 2 if desired
   - Improves UX for MCQ_MULTI

3. **Issue 5 & 6: Scoring Logic** - THIRD
   - Requires Issue 2 to be working (to generate array answers)
   - Implements both partial credit and all-or-nothing scoring
   - Critical for correct grading

4. **Issue 3: Multiple Selection Storage** - AUTOMATIC
   - No code changes needed - handled by Issue 2

5. **Issue 4: correctAnswers Array** - AUTOMATIC
   - No code changes needed - data model already correct

---

## Cross-Cutting Concerns

### 1. Answer Format Consistency
- MCQ answers: string (e.g., "B")
- MCQ_MULTI answers: sorted array (e.g., ["A", "C"])
- FRQ answers: object with sub-question keys (e.g., {a: "...", b: "..."})

The codebase already handles mixed types in useTestSession.js via Map storage.

### 2. Backward Compatibility
- Existing MCQ answers (strings) will continue to work
- Existing MCQ_MULTI questions in database are correct
- Scoring handles missing/malformed answers gracefully

### 3. Testing Considerations
- Test with 2, 3, and 4 correct answer combinations
- Test partial credit boundary cases (0%, 50%, 100%)
- Test navigation between questions preserves multi-select state
- Test session persistence (reload preserves selections)

---

## Notes for Implementer

1. **APQuestionEditor.jsx is already correct** - no changes needed for question creation
2. **useTestSession.js is already type-agnostic** - stores any answer value
3. **Focus on AnswerInput.jsx and apScoringService.js** - these are the main changes
4. **The `partialCredit` field** defaults to `true` for MCQ_MULTI in APQuestionEditor (line 248)
5. **Array sorting** - always sort selected answers to ensure consistent storage/comparison
6. **QuestionDisplay.jsx** only needs the small indicator text addition

---

## Files to Modify Summary

| File | Changes |
|------|---------|
| `src/apBoost/components/AnswerInput.jsx` | Add questionType prop, multi-select logic, checkbox UI |
| `src/apBoost/components/QuestionDisplay.jsx` | Add "Select all that apply" hint for MCQ_MULTI |
| `src/apBoost/pages/APTestSession.jsx` | Pass questionType to AnswerInput |
| `src/apBoost/services/apScoringService.js` | Add calculateMCQMultiScore, update calculateMCQScore |

---

## Estimated Changes

- **AnswerInput.jsx:** ~40 lines modified/added
- **QuestionDisplay.jsx:** ~6 lines added
- **APTestSession.jsx:** ~1 line added
- **apScoringService.js:** ~45 lines added/modified

**Total:** ~92 lines of code changes

---

## Part 2: Codebase Facts

# Codebase Facts Report: MCQ_MULTI Runtime UI + Scoring (Sections 2.1–2.3)

**Generated:** 2026-01-14
**Chunk ID:** UNK__2.1_to_2.3
**Purpose:** Ground-truth facts for validating/refining fix plan scope

---

## 1) Canonical Data Schema / Source-of-Truth

**Found: Yes**

### QUESTION_TYPE Definition

- **Location:** `src/apBoost/utils/apTypes.js:6-12`
- **MCQ_MULTI Token:** `'MCQ_MULTI'` (string value)
- **All Question Types:**
  - `MCQ: 'MCQ'`
  - `MCQ_MULTI: 'MCQ_MULTI'`
  - `FRQ: 'FRQ'`
  - `SAQ: 'SAQ'`
  - `DBQ: 'DBQ'`

**Evidence:**
```javascript
// src/apBoost/utils/apTypes.js:6-12
export const QUESTION_TYPE = {
  MCQ: 'MCQ',
  MCQ_MULTI: 'MCQ_MULTI',
  FRQ: 'FRQ',
  SAQ: 'SAQ',
  DBQ: 'DBQ',
}
```

### Question Object Schema (Creation)

- **Location:** `src/apBoost/services/apQuestionService.js:155-188`
- **`questionType`:** Defaults to `QUESTION_TYPE.MCQ` (line 161)
- **`correctAnswers`:** Always stored as array, defaults to `[]` (line 174)
- **`partialCredit`:** Boolean, defaults to `false` (line 183)

**Evidence:**
```javascript
// src/apBoost/services/apQuestionService.js:174,183
correctAnswers: questionData.correctAnswers || [],
partialCredit: questionData.partialCredit || false,
```

### MCQ_MULTI Creation in Editor

- **Location:** `src/apBoost/pages/APQuestionEditor.jsx:240-248`
- **`partialCredit`:** Set to `true` automatically for MCQ_MULTI (line 248)
- **`correctAnswers`:** Stored as array from state (line 247)

**Evidence:**
```javascript
// src/apBoost/pages/APQuestionEditor.jsx:247-248
questionData.correctAnswers = correctAnswers
questionData.partialCredit = questionType === QUESTION_TYPE.MCQ_MULTI
```

### Answer Storage Schema in Session State

- **Location:** `src/apBoost/hooks/useTestSession.js:39-40`
- **Data Structure:** React `Map` keyed by `questionId`
- **MCQ Answer Shape:** Single string value (e.g., `"A"`)
- **FRQ Answer Shape:** Object `{ subLabel: "answer text" }` when sub-questions exist (lines 337-342)

**Evidence:**
```javascript
// src/apBoost/hooks/useTestSession.js:39-40
// Answers state (Map for fast lookup)
const [answers, setAnswers] = useState(new Map())

// src/apBoost/hooks/useTestSession.js:343-344 (MCQ path)
} else {
  next.set(questionId, answer)  // Direct value assignment - string for MCQ
}
```

**KEY FACT:** No differentiation between MCQ and MCQ_MULTI in answer storage. Both use direct value assignment at line 344. There is NO array handling for MCQ_MULTI answers.

### Scoring Return Shapes

- **Location:** `src/apBoost/services/apScoringService.js:23-45`
- **Return Shape:** `{ correct: number, total: number, points: number }`
- **Multiplier:** Applied via `section.mcqMultiplier || 1` (line 41-42)

---

## 2) Write Paths

**Found: Yes**

### UI Event → State Update Flow

1. **AnswerInput click** → `onSelect(letter)` callback
   - **Location:** `src/apBoost/components/AnswerInput.jsx:45`
   - **Evidence:** `onClick={() => !disabled && onSelect(letter)}`

2. **APTestSession passes** → `setAnswer` from `useTestSession`
   - **Location:** `src/apBoost/pages/APTestSession.jsx:449-451`
   - **Evidence:** `selectedAnswer={currentAnswer}` and `onSelect={setAnswer}`

3. **useTestSession.setAnswer** → Updates local Map + queues for sync
   - **Location:** `src/apBoost/hooks/useTestSession.js:328-358`

**Evidence:**
```javascript
// src/apBoost/hooks/useTestSession.js:328-358
const setAnswer = useCallback((answer) => {
  const questionId = position.questionId
  if (!questionId || !session?.id) return

  // Update local state immediately (optimistic)
  setAnswers(prev => {
    const next = new Map(prev)
    // For FRQ with sub-questions, store as object
    if (isFRQQuestion && position.subQuestionLabel) {
      const existing = next.get(questionId) || {}
      next.set(questionId, {
        ...existing,
        [position.subQuestionLabel]: answer
      })
    } else {
      next.set(questionId, answer)  // ← MCQ path: direct value
    }
    return next
  })

  // Queue for sync
  addToQueue({
    action: 'ANSWER_CHANGE',
    payload: {
      questionId,
      value: answer,  // ← Value passed directly (string or any type)
      subQuestionLabel: position.subQuestionLabel // null for MCQ
    }
  })
}, [...])
```

### Queue → Firestore Write Path

- **Location:** `src/apBoost/hooks/useOfflineQueue.js:201-235`
- **Firestore Field Path:** `answers.${questionId}`
- **Write Method:** `updateDoc` with dot notation field path

**Evidence:**
```javascript
// src/apBoost/hooks/useOfflineQueue.js:203-207
case 'ANSWER_CHANGE':
  updates[`answers.${item.payload.questionId}`] = item.payload.value
  break
```

**KEY FACT:** The queue writes `item.payload.value` directly to Firestore. This value can be ANY type (string, array, object) — Firestore accepts arrays natively. The write path DOES support array values end-to-end.

### Direct Session Service (Fallback)

- **Location:** `src/apBoost/services/apSessionService.js:131-141`
- **Field Path:** `answers.${questionId}`
- **Function Signature:** `saveAnswer(sessionId, questionId, answer)`

**Evidence:**
```javascript
// src/apBoost/services/apSessionService.js:131-135
export async function saveAnswer(sessionId, questionId, answer) {
  try {
    await updateDoc(doc(db, COLLECTIONS.SESSION_STATE, sessionId), {
      [`answers.${questionId}`]: answer,  // ← Answer value passed directly
      lastAction: serverTimestamp(),
    })
```

**KEY FACT:** No type coercion or schema validation on `answer` parameter. Arrays would be accepted.

### Array Support Analysis

- **No JSON serialization** found in write paths
- **No schema validation** that enforces string type
- **Firestore natively supports** array field values

**CONCLUSION:** Write paths support arrays end-to-end. The blocker is the UI layer (AnswerInput only produces string values).

---

## 3) Offline/Resilience Mechanics

**Found: Yes** — Relevant to answer writes

### Queue Item Shape

- **Location:** `src/apBoost/hooks/useOfflineQueue.js:131-138`

**Evidence:**
```javascript
// src/apBoost/hooks/useOfflineQueue.js:131-138
const queueItem = {
  id: generateId(),
  sessionId,
  localTimestamp: Date.now(),
  action: action.action,       // 'ANSWER_CHANGE'
  payload: action.payload,     // { questionId, value, subQuestionLabel }
  status: 'PENDING',
}
```

### Flush/Reconciliation Logic

- **Location:** `src/apBoost/hooks/useOfflineQueue.js:203-207`
- **Action Type:** `'ANSWER_CHANGE'`
- **Behavior:** Directly assigns `payload.value` to Firestore field

**KEY FACT:** No type-checking or transformation in reconciliation. If `payload.value` is an array, it will be written as-is.

### Retry/Idempotency

- **Location:** `src/apBoost/hooks/useOfflineQueue.js:257-262`
- **Behavior:** Exponential backoff retry (2s, 4s, 8s, 16s)
- **Risk:** None for arrays — each write is a full replacement, not a merge

**Evidence:**
```javascript
// src/apBoost/hooks/useOfflineQueue.js:206
updates[`answers.${item.payload.questionId}`] = item.payload.value
```

This is a direct field set, not `arrayUnion` or similar. No merge/duplicate risk.

---

## 4) UI/Flow Entry Points

**Found: Yes**

### QuestionDisplay Rendering

- **Location:** `src/apBoost/pages/APTestSession.jsx:416-456`
- **Props Received:**
  - `question` (full question object including `questionType`)
  - `questionNumber`
  - `format` (VERTICAL/HORIZONTAL)
  - `subQuestionLabel` (for FRQ)

**Evidence:**
```javascript
// src/apBoost/pages/APTestSession.jsx:416-421
<QuestionDisplay
  question={currentQuestion}
  questionNumber={position.questionIndex + 1}
  stimulus={currentQuestion?.stimulus}
  format={format}
  subQuestionLabel={subQuestionLabel}
```

### QuestionDisplay Implementation

- **Location:** `src/apBoost/components/QuestionDisplay.jsx:48-164`
- **`questionType` Access:** Via `question.questionType` (line 77-78)
- **MCQ_MULTI Hint:** **NOT FOUND** — No "Select all that apply" text exists

**Evidence of Absence:**
```javascript
// src/apBoost/components/QuestionDisplay.jsx:155-158
// Question text rendering - NO questionType check
<p className="text-text-primary mb-6 whitespace-pre-wrap">
  {question.questionText}
</p>
```

The component imports `QUESTION_TYPE` but only uses it for FRQ type detection (line 77):
```javascript
const frqTypes = [QUESTION_TYPE.FRQ, QUESTION_TYPE.SAQ, QUESTION_TYPE.DBQ]
if (frqTypes.includes(question.questionType)) { ... }
```

### AnswerInput Rendering

- **Location:** `src/apBoost/pages/APTestSession.jsx:447-455`
- **Props Passed:**
  - `question` (full question object)
  - `selectedAnswer` → `currentAnswer` (single value)
  - `onSelect` → `setAnswer` (callback)
  - `strikethroughs` (Set)
  - `onStrikethrough` (callback)

**Evidence:**
```javascript
// src/apBoost/pages/APTestSession.jsx:447-455
<AnswerInput
  question={currentQuestion}
  selectedAnswer={currentAnswer}
  onSelect={setAnswer}
  disabled={isSubmitting || isInvalidated}
  strikethroughs={currentStrikethroughs}
  onStrikethrough={handleStrikethrough}
/>
```

**KEY FACT:** No `questionType` prop passed to AnswerInput. The component has no way to differentiate MCQ from MCQ_MULTI.

### AnswerInput Implementation

- **Location:** `src/apBoost/components/AnswerInput.jsx:17-107`
- **Selected Check:** `selectedAnswer === letter` (line 36) — STRING equality
- **Click Handler:** `onSelect(letter)` — passes single letter (line 45)
- **No `questionType` prop** in function signature (line 17-24)

**Evidence:**
```javascript
// src/apBoost/components/AnswerInput.jsx:17-24
export default function AnswerInput({
  question,
  selectedAnswer,
  onSelect,
  disabled = false,
  strikethroughs = new Set(),
  onStrikethrough,
}) {
```

```javascript
// src/apBoost/components/AnswerInput.jsx:36
const isSelected = selectedAnswer === letter  // ← String comparison only
```

```javascript
// src/apBoost/components/AnswerInput.jsx:45
onClick={() => !disabled && onSelect(letter)}  // ← Passes single letter string
```

### Multi-Select UI Affordances

**NOT FOUND** — Evidence of absence:

1. No checkbox visual in AnswerInput (only radio-style selection indicator)
2. No array comparison in `isSelected` logic
3. No toggle behavior (clicking always replaces, never toggles)
4. No `questionType` prop to trigger different behavior

---

## 5) Must-Answer Questions

### Q1: Where is `QUESTION_TYPE.MCQ_MULTI` defined, and what are all question types?

**ANSWER:**
- **Location:** `src/apBoost/utils/apTypes.js:6-12`
- **All Types:** MCQ, MCQ_MULTI, FRQ, SAQ, DBQ

**Evidence:**
```javascript
export const QUESTION_TYPE = {
  MCQ: 'MCQ',
  MCQ_MULTI: 'MCQ_MULTI',
  FRQ: 'FRQ',
  SAQ: 'SAQ',
  DBQ: 'DBQ',
}
```

---

### Q2: What is the exact shape of `currentAnswer` for MCQ questions today?

**ANSWER:** String (single letter like `"A"`, `"B"`, etc.) or `null`

**Location:** `src/apBoost/hooks/useTestSession.js:311-325`

**Evidence:**
```javascript
// src/apBoost/hooks/useTestSession.js:311-325
const currentAnswer = useMemo(() => {
  const questionId = position.questionId
  if (!questionId) return null

  const answer = answers.get(questionId)
  if (!answer) return null

  // For FRQ with sub-questions, answer is an object { a: "...", b: "...", c: "..." }
  if (isFRQQuestion && position.subQuestionLabel && typeof answer === 'object') {
    return answer[position.subQuestionLabel] || null
  }

  return answer  // ← MCQ: returns stored value directly (string)
}, [answers, position.questionId, position.subQuestionLabel, isFRQQuestion])
```

---

### Q3: Does `useTestSession` accept and persist non-string answers for non-FRQ questions?

**ANSWER:** **Technically yes**, but practically no.

**Location:** `src/apBoost/hooks/useTestSession.js:328-358`

**Evidence:**
```javascript
// src/apBoost/hooks/useTestSession.js:343-344
} else {
  next.set(questionId, answer)  // ← No type check, any value accepted
}
```

The code does NOT validate that `answer` is a string. However, the UI (AnswerInput) only ever calls `onSelect(letter)` with a single string, so in practice only strings are stored for MCQ.

---

### Q4: Where does the app persist answers beyond React state?

**ANSWER:**
1. **IndexedDB Queue:** `src/apBoost/hooks/useOfflineQueue.js:141-143` (temporary)
2. **Firestore:** `ap_session_state.answers.{questionId}` (durable)

**Field Path:** `answers.${questionId}`

**Evidence:**
```javascript
// src/apBoost/hooks/useOfflineQueue.js:206
updates[`answers.${item.payload.questionId}`] = item.payload.value

// src/apBoost/services/apSessionService.js:133-134
await updateDoc(doc(db, COLLECTIONS.SESSION_STATE, sessionId), {
  [`answers.${questionId}`]: answer,
```

---

### Q5: In `AnswerInput`, what comparison determines "selected" today?

**ANSWER:** String equality `selectedAnswer === letter`

**Location:** `src/apBoost/components/AnswerInput.jsx:36`

**Evidence:**
```javascript
const isSelected = selectedAnswer === letter
```

**No branch by `questionType` exists.** The component does not receive `questionType` as a prop and has no conditional logic based on question type.

---

### Q6: In `QuestionDisplay`, is there any text/hint logic based on question type (MCQ vs MCQ_MULTI)?

**ANSWER:** **No** — QuestionDisplay is fully generic for MCQ types.

**Location:** `src/apBoost/components/QuestionDisplay.jsx:77-89, 140-163`

**Evidence:** The only `questionType` check is for FRQ delegation:
```javascript
// src/apBoost/components/QuestionDisplay.jsx:77-89
const frqTypes = [QUESTION_TYPE.FRQ, QUESTION_TYPE.SAQ, QUESTION_TYPE.DBQ]
if (frqTypes.includes(question.questionType)) {
  return <FRQQuestionDisplay ... />
}
```

For MCQ/MCQ_MULTI, the same rendering path is used with no differentiation. No "Select all that apply" hint exists.

---

### Q7: In scoring, what logic determines correctness for MCQ, and does it handle arrays?

**ANSWER:** Single-value `includes()` check. **Does NOT handle arrays.**

**Location:** `src/apBoost/services/apScoringService.js:23-45`

**Evidence:**
```javascript
// src/apBoost/services/apScoringService.js:32-37
const studentAnswer = answers[questionId]
const correctAnswers = question.correctAnswers || []

if (correctAnswers.includes(studentAnswer)) {
  correct++
}
```

This checks if the single `studentAnswer` string is IN the `correctAnswers` array. For MCQ_MULTI with `correctAnswers: ["A", "C"]`:
- If student answers `"A"` (string), `["A", "C"].includes("A")` → `true` (gets full credit incorrectly)
- There is NO array comparison logic for MCQ_MULTI

---

### Q8: Where is `partialCredit` set for MCQ_MULTI creation, and is it read at runtime?

**ANSWER:**
- **Set:** `src/apBoost/pages/APQuestionEditor.jsx:248`
- **Read at Runtime:** **NO** — `partialCredit` is NEVER accessed in `apScoringService.js`

**Evidence (Set):**
```javascript
// src/apBoost/pages/APQuestionEditor.jsx:248
questionData.partialCredit = questionType === QUESTION_TYPE.MCQ_MULTI
```

**Evidence (Not Read):** Searched `apScoringService.js` — no reference to `partialCredit` or `question.partialCredit` in the scoring logic.

---

### Q9: Is `correctAnswers` always an array? Any validators/migrations?

**ANSWER:** Always stored as array. No runtime validators found.

**Location:** `src/apBoost/services/apQuestionService.js:174`

**Evidence:**
```javascript
correctAnswers: questionData.correctAnswers || [],
```

No migration or validation logic found. The code always defaults to empty array `[]` if undefined.

---

### Q10: Are there downstream consumers that assume `studentAnswer` is a string?

**ANSWER:** **Yes** — Multiple consumers would break with array values.

| File | Line | Code | Risk |
|------|------|------|------|
| `APReportCard.jsx` | 93 | `{result.studentAnswer \|\| '—'}` | Would render `[object Object]` or array literal |
| `generateReportPdf.js` | 171 | `doc.text(r.studentAnswer \|\| '—', ...)` | Same issue in PDF output |
| `apAnalyticsService.js` | 144 | `const answer = mcqResult.studentAnswer \|\| 'No Answer'` | Used as object key in distribution |
| `apScoringService.js` | 108 | `studentAnswer,` (in mcqResults) | Stored in Firestore, displayed later |

**Evidence:**
```javascript
// src/apBoost/pages/APReportCard.jsx:92-93
<td className="py-2 px-3 text-text-primary font-mono">
  {result.studentAnswer || '—'}
</td>

// src/apBoost/utils/generateReportPdf.js:171
doc.text(r.studentAnswer || '—', margin + 20, yPos)

// src/apBoost/services/apAnalyticsService.js:144
const answer = mcqResult.studentAnswer || 'No Answer'
```

---

### Q11: Are there PropTypes/TS type checks that constrain `selectedAnswer` to string?

**ANSWER:** **No** — No PropTypes or TypeScript found in apBoost components.

**Evidence:** Grep search for `PropTypes` in `src/apBoost` returned only audit documentation, not actual code.

---

### Q12: How would review mode / answer summary render arrays today?

**ANSWER:** ReviewScreen uses `.has()` on answers Map — works with any value type.

**Location:** `src/apBoost/components/ReviewScreen.jsx:47-49`

**Evidence:**
```javascript
// src/apBoost/components/ReviewScreen.jsx:47-49
const answeredCount = questions.filter(q => answers.has(q.id || q)).length
const unansweredCount = totalQuestions - answeredCount
const flaggedCount = questions.filter(q => flags.has(q.id || q)).length
```

This only checks if an answer EXISTS (Map.has), not its value. Would work fine with arrays.

**However, APReportCard (Q10) WOULD break** when displaying the actual answer value.

---

## Summary: Critical Gaps for MCQ_MULTI

| Component | Current State | Gap |
|-----------|---------------|-----|
| `AnswerInput.jsx` | Radio-style single select | Needs checkbox toggle + array state |
| `QuestionDisplay.jsx` | No MCQ_MULTI hint | Needs "Select all that apply" indicator |
| `useTestSession.js` | Stores any value (no validation) | Technically ready, but UI doesn't send arrays |
| `apScoringService.js` | `includes()` single value check | Needs array comparison + partial credit logic |
| `APReportCard.jsx` | Assumes string `studentAnswer` | Needs array formatting |
| `generateReportPdf.js` | Assumes string `studentAnswer` | Needs array formatting |
| `apAnalyticsService.js` | Uses answer as object key | Needs array handling in distribution |

---

## End of Report
