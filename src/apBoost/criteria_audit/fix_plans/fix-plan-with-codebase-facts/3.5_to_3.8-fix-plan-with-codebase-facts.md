# Section 3.5 to 3.8 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 3.5 to 3.8:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 3.5 to 3.8

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_3.5_to_3.8_criteria_audit.md

## Executive Summary
- Total Issues: 15
- ⚠️ Partial Implementations: 6
- ❌ Missing Features: 9 (1 access control + 8 index groups)
- ❓ Needs Investigation: 0
- Estimated Complexity: Medium

---

## Issue 1: frqUploadUrl Field Name Mismatch

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `frqUploadUrl` for student's scanned answer
- **Current State:** Uses `frqUploadedFiles` (array/object) instead of `frqUploadUrl` (string)

### Code Analysis
- **Relevant Files:**
  - [apScoringService.js:144](src/apBoost/services/apScoringService.js#L144) - stores frqUploadedFiles
  - [apScoringService.js:64](src/apBoost/services/apScoringService.js#L64) - JSDoc mentions frqUploadedFiles
- **Current Implementation:**
  ```javascript
  frqUploadedFiles: frqData?.frqUploadedFiles || null,
  ```
  The implementation stores uploaded files as an array/object, allowing multiple file uploads per submission.
- **Gap:** Spec requires single URL string `frqUploadUrl`, implementation uses array `frqUploadedFiles`
- **Dependencies:**
  - FRQ upload components that create the `frqData` object
  - Any grading UI that reads uploaded files for review

### Fix Plan

#### Option A: Rename to Match Spec (Breaking Change)
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Modify field name
**Details:**
- Line 144: Change `frqUploadedFiles` to `frqUploadUrl`
- Line 64: Update JSDoc comment
- Requires migration of existing data if any exists

#### Option B: Document Deviation (Recommended)
**File:** Update acceptance criteria documentation
**Action:** Document that `frqUploadedFiles` is intentional deviation
**Details:**
- Multiple file uploads provide better UX for handwritten work
- Document that this is an intentional enhancement
- Update spec to reflect actual implementation

### Verification Steps
1. Search codebase for all usages of `frqUploadedFiles`
2. Verify grading UI reads the field correctly
3. Test FRQ upload flow end-to-end

### Potential Risks
- If renaming: Breaking change for any existing test results with uploaded files
- Mitigation: Run migration script or support both field names during transition

---

## Issue 2: frqGradedPdfUrl Field Name Mismatch

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `frqGradedPdfUrl` for teacher's annotated PDF
- **Current State:** Uses `annotatedPdfUrl` instead of `frqGradedPdfUrl`

### Code Analysis
- **Relevant Files:**
  - [apScoringService.js:148](src/apBoost/services/apScoringService.js#L148) - initializes as null
  - [apGradingService.js:162](src/apBoost/services/apGradingService.js#L162) - parameter name
  - [apGradingService.js:177-178](src/apBoost/services/apGradingService.js#L177-L178) - updates field
- **Current Implementation:**
  ```javascript
  // In apScoringService.js:148
  annotatedPdfUrl: null, // Teacher's annotated PDF

  // In apGradingService.js:177-178
  if (annotatedPdfUrl) {
    updateData.annotatedPdfUrl = annotatedPdfUrl
  }
  ```
- **Gap:** Field named `annotatedPdfUrl` instead of spec's `frqGradedPdfUrl`
- **Dependencies:**
  - Grading UI components that display annotated PDFs
  - Student report card that shows graded feedback

### Fix Plan

#### Option A: Rename to Match Spec (Breaking Change)
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Modify field initialization
**Details:**
- Line 148: Change `annotatedPdfUrl: null` to `frqGradedPdfUrl: null`
- Remove the comment (field name is now self-documenting)

**File:** `src/apBoost/services/apGradingService.js`
**Action:** Update parameter and field references
**Details:**
- Line 162: Change parameter `annotatedPdfUrl` to `frqGradedPdfUrl`
- Line 177-178: Update field name in updateData

#### Option B: Document Deviation (Simpler)
**Action:** Update acceptance criteria documentation
**Details:**
- `annotatedPdfUrl` is semantically equivalent
- Document as intentional naming choice

### Verification Steps
1. Search for all usages of `annotatedPdfUrl`
2. Update grading UI if it reads this field
3. Test annotated PDF upload and retrieval flow

### Potential Risks
- Breaking change for existing graded results
- Mitigation: Add field alias or migration

---

## Issue 3: Class Subject Field Not Verified

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `name, subject, teacherId` required fields
- **Current State:** `subject` field not explicitly handled in service layer

### Code Analysis
- **Relevant Files:**
  - [apTeacherService.js:160-178](src/apBoost/services/apTeacherService.js#L160-L178) - getTeacherClasses
- **Current Implementation:**
  ```javascript
  const q = query(
    classesRef,
    where('teacherId', '==', teacherId),
    orderBy('name', 'asc')
  )
  ```
  Queries by teacherId, orders by name. Subject field may exist in data but isn't used.
- **Gap:** No createClass function exists; subject field not set or validated
- **Dependencies:** Need class creation functionality

### Fix Plan

#### Step 1: Create createClass Function
**File:** `src/apBoost/services/apTeacherService.js`
**Action:** Add new function
**Details:**
- Add after getTeacherClasses function (around line 178)
- Follow pattern from createTest function (lines 52-76)

```javascript
/**
 * Create a new class
 * @param {Object} classData - Class configuration { name, subject, teacherId }
 * @returns {Promise<string>} Created class ID
 */
export async function createClass(classData) {
  try {
    const classesRef = collection(db, COLLECTIONS.CLASSES)

    const newClass = {
      name: classData.name,
      subject: classData.subject || '',
      teacherId: classData.teacherId,
      studentIds: classData.studentIds || [],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    }

    const docRef = await addDoc(classesRef, newClass)
    return docRef.id
  } catch (error) {
    logError('apTeacherService.createClass', { classData }, error)
    throw error
  }
}
```

### Verification Steps
1. Test class creation with all required fields
2. Verify subject field is stored and retrievable
3. Test timestamps are properly set

### Potential Risks
- Low risk - adding new functionality
- Ensure UI exists to call this function

---

## Issue 4: Class createdAt/updatedAt Timestamps

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `createdAt` and `updatedAt` timestamps
- **Current State:** No createClass function, timestamps can't be set

### Code Analysis
- **Relevant Files:**
  - [apTeacherService.js](src/apBoost/services/apTeacherService.js) - no class creation function
- **Current Implementation:** getTeacherClasses reads existing classes but no creation logic
- **Gap:** Class creation not implemented, so timestamps cannot be set
- **Dependencies:** Requires Issue 3 fix (createClass function)

### Fix Plan

#### Step 1: Included in Issue 3 Fix
**Details:**
- The createClass function in Issue 3 includes `createdAt` and `updatedAt` fields
- Both use `serverTimestamp()` for consistency

#### Step 2: Add updateClass Function (Optional)
**File:** `src/apBoost/services/apTeacherService.js`
**Action:** Add update function
**Details:**
```javascript
/**
 * Update a class
 * @param {string} classId - Class document ID
 * @param {Object} updates - Fields to update
 * @returns {Promise<void>}
 */
export async function updateClass(classId, updates) {
  try {
    const classRef = doc(db, COLLECTIONS.CLASSES, classId)
    await updateDoc(classRef, {
      ...updates,
      updatedAt: serverTimestamp(),
    })
  } catch (error) {
    logError('apTeacherService.updateClass', { classId, updates }, error)
    throw error
  }
}
```

### Verification Steps
1. Test class creation sets both timestamps
2. Test class update modifies updatedAt only
3. Verify timestamps display correctly in UI

### Potential Risks
- Low risk - standard timestamp pattern

---

## Issue 5: Assignment classIds vs classId Schema Deviation

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `testId` and `classId` references
- **Current State:** Uses `classIds` (array) instead of `classId` (string)

### Code Analysis
- **Relevant Files:**
  - [apTeacherService.js:236](src/apBoost/services/apTeacherService.js#L236) - stores classIds array
  - [AssignTestModal.jsx:112](src/apBoost/components/teacher/AssignTestModal.jsx#L112) - creates array from Set
- **Current Implementation:**
  ```javascript
  classIds: assignmentData.classIds || [],
  ```
- **Gap:** Spec says single `classId`, implementation uses `classIds` array
- **Dependencies:** This allows assigning one test to multiple classes at once - MORE flexible

### Fix Plan

#### Recommendation: Document as Enhancement
**Action:** Update acceptance criteria documentation
**Details:**
- Current implementation is MORE flexible than spec
- Allows single assignment record for multi-class assignments
- Reduces database writes and simplifies management
- Update spec to reflect `classIds: string[]` pattern

### Verification Steps
1. Verify queries work with array field
2. Ensure grading/reports handle multi-class assignments
3. Document the schema in data model docs

### Potential Risks
- None - current implementation is superior to spec

---

## Issue 6: maxAttempts Default Value

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** `maxAttempts (default: 3)`
- **Current State:** Defaults to 1, not 3

### Code Analysis
- **Relevant Files:**
  - [AssignTestModal.jsx:48](src/apBoost/components/teacher/AssignTestModal.jsx#L48) - useState(1)
  - [apTeacherService.js:239](src/apBoost/services/apTeacherService.js#L239) - defaults to 1
- **Current Implementation:**
  ```javascript
  // AssignTestModal.jsx:48
  const [maxAttempts, setMaxAttempts] = useState(1)

  // apTeacherService.js:239
  maxAttempts: assignmentData.maxAttempts || 1,
  ```
- **Gap:** UI and service both default to 1, spec says 3
- **Dependencies:** Existing assignments would be unaffected (already have values)

### Fix Plan

#### Step 1: Update UI Default
**File:** `src/apBoost/components/teacher/AssignTestModal.jsx`
**Action:** Modify
**Details:**
- Line 48: Change `useState(1)` to `useState(3)`

#### Step 2: Update Service Default
**File:** `src/apBoost/services/apTeacherService.js`
**Action:** Modify
**Details:**
- Line 239: Change `assignmentData.maxAttempts || 1` to `assignmentData.maxAttempts || 3`

### Verification Steps
1. Open AssignTestModal and verify dropdown shows 3 selected by default
2. Create assignment without changing attempts, verify stores as 3
3. Verify existing assignments retain their values

### Potential Risks
- Low risk - only affects new assignments
- Teachers may prefer 1 as default - consider if this is intentional UX choice

---

## Issue 7: Student Access Control Not Implemented

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Only students in studentIds can access assigned tests
- **Current State:** No access control verification when starting test session

### Code Analysis
- **Relevant Files:**
  - [apTestService.js:20-88](src/apBoost/services/apTestService.js#L20-L88) - getAvailableTests
  - [apSessionService.js:30-76](src/apBoost/services/apSessionService.js#L30-L76) - createOrResumeSession
- **Current Implementation:**

  `getAvailableTests` (line 41-44) correctly filters by studentIds:
  ```javascript
  const assignmentsQuery = query(
    collection(db, COLLECTIONS.ASSIGNMENTS),
    where('studentIds', 'array-contains', userId)
  )
  ```

  However, `createOrResumeSession` (line 30) does NOT verify access:
  ```javascript
  export async function createOrResumeSession(testId, userId, assignmentId = null) {
    // No validation that userId is allowed to take this test!
  ```
- **Gap:** A user with a direct URL to `/ap/test/[testId]` could bypass the dashboard and access any test
- **Dependencies:** apSessionService.js, apTestService.js

### Fix Plan

#### Step 1: Add Access Verification Function
**File:** `src/apBoost/services/apTestService.js`
**Action:** Add new function
**Details:**
- Add after getAssignment function (around line 169)

```javascript
/**
 * Verify user has access to a test
 * Returns true if test is public or user is in assignment's studentIds
 * @param {string} testId - Test ID
 * @param {string} userId - User ID
 * @returns {Promise<boolean>} Whether user can access the test
 */
export async function canAccessTest(testId, userId) {
  try {
    // Check if test is public
    const testDoc = await getDoc(doc(db, COLLECTIONS.TESTS, testId))
    if (!testDoc.exists()) {
      return false
    }

    const testData = testDoc.data()
    if (testData.isPublic === true) {
      return true
    }

    // Check if user has an assignment for this test
    const assignment = await getAssignment(testId, userId)
    return assignment !== null
  } catch (error) {
    console.error('Error checking test access:', error)
    return false
  }
}
```

#### Step 2: Add Validation to Session Creation
**File:** `src/apBoost/services/apSessionService.js`
**Action:** Modify createOrResumeSession
**Details:**
- Add import at top: `import { canAccessTest } from './apTestService'`
- Add validation after line 31:

```javascript
export async function createOrResumeSession(testId, userId, assignmentId = null) {
  try {
    // Verify user has access to this test
    const hasAccess = await canAccessTest(testId, userId)
    if (!hasAccess) {
      throw new Error('Access denied: You are not assigned to this test')
    }

    // ... rest of function
```

### Verification Steps
1. Test that assigned students can access their tests
2. Test that non-assigned students get "Access denied" error
3. Test that public tests remain accessible to everyone
4. Test direct URL access is blocked for non-assigned users

### Potential Risks
- Breaking change if teachers have been sharing direct test URLs
- Mitigation: Add clear error message directing users to contact teacher
- Consider: Allow teachers to bypass check?

---

## Issue 8-15: Missing Firestore Indexes

### Audit Finding
- **Status:** ❌ Missing (All 13 specified indexes)
- **Criterion:** Various composite and single-field indexes for ap_* collections
- **Current State:** firestore.indexes.json only contains legacy "attempts" collection indexes

### Code Analysis
- **Relevant Files:**
  - [firestore.indexes.json](firestore.indexes.json) - current index config
  - [apSessionService.js:86-91](src/apBoost/services/apSessionService.js#L86-L91) - session queries
  - [apGradingService.js:52](src/apBoost/services/apGradingService.js#L52) - grading queries
  - [apTeacherService.js:163-167](src/apBoost/services/apTeacherService.js#L163-L167) - class queries
  - [apTeacherService.js:261-265](src/apBoost/services/apTeacherService.js#L261-L265) - assignment queries

### Fix Plan

#### Step 1: Update firestore.indexes.json
**File:** `firestore.indexes.json`
**Action:** Replace entire contents
**Details:**

```json
{
  "indexes": [
    {
      "collectionGroup": "ap_session_state",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "testId", "order": "ASCENDING" },
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_test_results",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "testId", "order": "ASCENDING" },
        { "fieldPath": "userId", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_test_results",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "testId", "order": "ASCENDING" },
        { "fieldPath": "completedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_test_results",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "gradingStatus", "order": "ASCENDING" },
        { "fieldPath": "completedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_test_results",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "isFirstAttempt", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_assignments",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "testId", "order": "ASCENDING" },
        { "fieldPath": "assignedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_classes",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "teacherId", "order": "ASCENDING" },
        { "fieldPath": "name", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_questions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "subject", "order": "ASCENDING" },
        { "fieldPath": "questionDomain", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_questions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "subject", "order": "ASCENDING" },
        { "fieldPath": "tags", "arrayConfig": "CONTAINS" }
      ]
    },
    {
      "collectionGroup": "ap_questions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "difficulty", "order": "ASCENDING" },
        { "fieldPath": "questionType", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "ap_stimuli",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "subject", "order": "ASCENDING" },
        { "fieldPath": "tags", "arrayConfig": "CONTAINS" }
      ]
    },
    {
      "collectionGroup": "ap_tests",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "createdBy", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": [
    {
      "collectionGroup": "ap_assignments",
      "fieldPath": "studentIds",
      "indexes": [
        { "order": "ASCENDING", "queryScope": "COLLECTION" },
        { "arrayConfig": "CONTAINS", "queryScope": "COLLECTION" }
      ]
    },
    {
      "collectionGroup": "ap_classes",
      "fieldPath": "studentIds",
      "indexes": [
        { "order": "ASCENDING", "queryScope": "COLLECTION" },
        { "arrayConfig": "CONTAINS", "queryScope": "COLLECTION" }
      ]
    }
  ]
}
```

#### Step 2: Deploy Indexes
**Action:** Run Firebase CLI
**Details:**
```bash
firebase deploy --only firestore:indexes
```

### Verification Steps
1. Run `firebase deploy --only firestore:indexes`
2. Verify in Firebase Console that indexes are building
3. Wait for indexes to complete (may take several minutes)
4. Test all queries that require these indexes:
   - Session queries (getActiveSession)
   - Grading queries (getPendingGrades)
   - Class queries (getTeacherClasses)
   - Assignment queries (getTestAssignments)
5. Verify no "missing index" errors in console

### Potential Risks
- Index building takes time (5-30 minutes depending on data size)
- Queries may fail until indexes complete
- Mitigation: Deploy during low-usage period

---

## Implementation Order

Recommended order to implement fixes (considering dependencies):

1. **Issue 8-15: Firestore Indexes** - Deploy first, as queries depend on these
2. **Issue 3: createClass Function** - Foundational, Issue 4 depends on this
3. **Issue 4: Class Timestamps** - Depends on Issue 3
4. **Issue 7: Access Control** - Critical security fix
5. **Issue 6: maxAttempts Default** - Simple fix, low risk
6. **Issue 1: frqUploadUrl** - Documentation or rename
7. **Issue 2: frqGradedPdfUrl** - Documentation or rename
8. **Issue 5: classIds Schema** - Documentation only (keep current implementation)

---

## Cross-Cutting Concerns

### Data Migration
If renaming fields (Issues 1-2), consider:
1. Adding migration script to update existing documents
2. Supporting both field names during transition period
3. Using Firestore functions to migrate on-read

### Error Handling
Issue 7 (Access Control) should return clear error messages:
- "Access denied: You are not assigned to this test"
- "Test not found"
- Direct users to contact their teacher

### Testing Requirements
All fixes should include:
1. Unit tests for new service functions
2. Integration tests for access control
3. Manual verification of query performance after index deployment

---

## Notes for Implementer

1. **Index Deployment is Critical** - Many queries will fail in production without proper indexes. Deploy these first and monitor for completion.

2. **Access Control is a Security Issue** - Issue 7 should be prioritized after indexes. Currently, any user can start a session for any test if they know the test ID.

3. **Field Renaming Decisions** - Issues 1-2 and 5 are naming discrepancies. Recommend documenting as intentional deviations rather than renaming, unless strict spec compliance is required.

4. **Default Value Change** - Issue 6 only affects new assignments. Confirm with product owner if defaulting to 3 attempts is correct behavior.

5. **Class Management** - No UI currently exists for class creation. Issue 3 provides the service function, but a UI component will also be needed.

---

*Fix plan completed on 2026-01-14*

---

## Part 2: Codebase Facts

# CODEBASE FACTS: Sections 3.5 to 3.8

**Generated:** 2026-01-14
**Inspected by:** Claude Repo Inspector
**Purpose:** Ground-truth codebase facts for fix plan validation

---

## 1) Canonical Data Schema / Source-of-Truth

**Found: Yes**

### Collection Names (from COLLECTIONS constant)

- Evidence: `src/apBoost/utils/apTypes.js:L90-L98`
```javascript
export const COLLECTIONS = {
  TESTS: 'ap_tests',
  QUESTIONS: 'ap_questions',
  STIMULI: 'ap_stimuli',
  SESSION_STATE: 'ap_session_state',
  TEST_RESULTS: 'ap_test_results',
  CLASSES: 'ap_classes',
  ASSIGNMENTS: 'ap_assignments',
}
```

### FRQ Result Document Schema (ap_test_results)

- Evidence: `src/apBoost/services/apScoringService.js:L127-L154`
```javascript
const resultData = {
  userId: session.userId,
  testId: session.testId,
  classId: session.classId || null,
  assignmentId: session.assignmentId || null,
  attemptNumber: session.attemptNumber,
  isFirstAttempt: session.attemptNumber === 1,
  sessionId: session.id,
  answers,
  score: totalScore,
  maxScore,
  percentage,
  apScore,
  sectionScores,
  mcqResults,
  // FRQ submission data
  frqSubmissionType: frqData?.frqSubmissionType || null,
  frqUploadedFiles: frqData?.frqUploadedFiles || null,  // <-- ARRAY, NOT frqUploadUrl
  frqAnswers: session.answers || {},
  frqMaxPoints: 0,
  frqScore: null,
  annotatedPdfUrl: null,  // <-- NOT frqGradedPdfUrl
  frqGrades: null,
  gradingStatus,
  startedAt: session.startedAt,
  completedAt: serverTimestamp(),
  gradedAt: null,
}
```

**Key Findings:**
- **`frqUploadedFiles`** (array/object) is used, NOT `frqUploadUrl` (string)
- **`annotatedPdfUrl`** is used, NOT `frqGradedPdfUrl`
- No read fallback or aliasing exists for either field
- These are intentional naming choices, not bugs

### Classes Collection Schema (ap_classes)

- **Found: Partial** - No `createClass` function exists. Schema inferred from read patterns.

- Evidence: `src/apBoost/services/apTeacherService.js:L160-L178`
```javascript
export async function getTeacherClasses(teacherId) {
  const classesRef = collection(db, COLLECTIONS.CLASSES)
  const q = query(
    classesRef,
    where('teacherId', '==', teacherId),
    orderBy('name', 'asc')
  )
  // ...
}
```

- Evidence: `src/apBoost/services/apTeacherService.js:L185-L195`
```javascript
export async function getClassStudents(classId) {
  // ...
  const classData = classSnap.data()
  const studentIds = classData.studentIds || []
  // ...
}
```

**Inferred Class Schema Fields:**
- `teacherId` - required (queried)
- `name` - required (ordered by)
- `studentIds` - array of user IDs
- `period` - optional (displayed in AssignTestModal)
- `createdAt` - **NOT CONFIRMED** - no write function exists
- `updatedAt` - **NOT CONFIRMED** - no write function exists
- `subject` - **NOT FOUND** in any code

### Assignments Collection Schema (ap_assignments)

- Evidence: `src/apBoost/services/apTeacherService.js:L230-L251`
```javascript
export async function createAssignment(assignmentData) {
  const newAssignment = {
    testId: assignmentData.testId,
    classIds: assignmentData.classIds || [],      // <-- USES classIds (PLURAL)
    studentIds: assignmentData.studentIds || [],
    dueDate: assignmentData.dueDate || null,
    maxAttempts: assignmentData.maxAttempts || 1, // <-- DEFAULT IS 1, not 3
    frqSubmissionType: assignmentData.frqSubmissionType || 'TYPED',
    assignedBy: assignmentData.assignedBy,
    assignedAt: serverTimestamp(),
  }
  const docRef = await addDoc(assignmentsRef, newAssignment)
  return docRef.id
}
```

**Key Findings:**
- Uses `classIds` (array), NOT `classId` (singular)
- Uses `studentIds` for denormalized student list
- `maxAttempts` defaults to `1` in service (line 239)
- `maxAttempts` defaults to `1` in UI (AssignTestModal line 48)

### Session State Schema (ap_session_state)

- Evidence: `src/apBoost/services/apSessionService.js:L47-L67`
```javascript
const sessionData = {
  userId,
  testId,
  assignmentId,  // <-- Links to assignment, used for access control
  sessionToken: generateSessionToken(),
  status: SESSION_STATUS.IN_PROGRESS,
  attemptNumber,
  currentSectionIndex: 0,
  currentQuestionIndex: 0,
  sectionTimeRemaining: {},
  answers: {},
  flaggedQuestions: [],
  annotations: {},
  strikethroughs: {},
  lastHeartbeat: serverTimestamp(),
  lastAction: serverTimestamp(),
  startedAt: serverTimestamp(),
  completedAt: null,
}
```

---

## 2) Write Paths

**Found: Yes**

### FRQ Submission Data Write Path

| Function | File | Operation | Fields Written |
|----------|------|-----------|----------------|
| `createTestResult` | `apScoringService.js:L67-L161` | `setDoc` | `frqSubmissionType`, `frqUploadedFiles`, `annotatedPdfUrl` (initialized to null) |

- Evidence: `src/apBoost/services/apScoringService.js:L143-L148`
```javascript
frqSubmissionType: frqData?.frqSubmissionType || null,
frqUploadedFiles: frqData?.frqUploadedFiles || null,
frqAnswers: session.answers || {},
frqMaxPoints: 0,
frqScore: null,
annotatedPdfUrl: null,
```

### Grading/Annotated PDF Write Path

| Function | File | Operation | Fields Written |
|----------|------|-----------|----------------|
| `saveGrade` | `apGradingService.js:L165-L206` | `updateDoc` | `frqGrades`, `gradingStatus`, `gradedBy`, `gradedAt`, `annotatedPdfUrl` (conditional), `frqScore`, `score`, `maxScore`, `percentage`, `apScore` |

- Evidence: `src/apBoost/services/apGradingService.js:L165-L179`
```javascript
export async function saveGrade(resultId, grades, status, teacherId, annotatedPdfUrl = null) {
  const updateData = {
    frqGrades: grades,
    gradingStatus: status,
    gradedBy: teacherId,
    gradedAt: serverTimestamp(),
  }

  if (annotatedPdfUrl) {
    updateData.annotatedPdfUrl = annotatedPdfUrl  // <-- Writes annotatedPdfUrl
  }
  // ...
}
```

### Class Creation Write Path

**NOT FOUND** - No `createClass` function exists in `apTeacherService.js`

- Evidence: Searched entire `src/apBoost` directory for `createClass`:
```
$ grep -rn "createClass" src/apBoost/services/
# No results in service files
```

- Evidence: `src/apBoost/services/apTeacherService.js` exports:
  - `getTeacherClasses` (read only)
  - `getClassStudents` (read only)
  - NO `createClass`, `updateClass`, or `deleteClass`

### Assignment Creation Write Path

| Function | File | Operation | Fields Written |
|----------|------|-----------|----------------|
| `createAssignment` | `apTeacherService.js:L230-L251` | `addDoc` | `testId`, `classIds`, `studentIds`, `dueDate`, `maxAttempts`, `frqSubmissionType`, `assignedBy`, `assignedAt` |

- Evidence: shown in Section 1 above

### Session Creation/Resume Write Path

| Function | File | Operation | Fields Written |
|----------|------|-----------|----------------|
| `createOrResumeSession` | `apSessionService.js:L30-L76` | `setDoc` | Full session state document |

- Evidence: `src/apBoost/services/apSessionService.js:L30-L76`
```javascript
export async function createOrResumeSession(testId, userId, assignmentId = null) {
  // Check for existing active session first
  const existingSession = await getActiveSession(testId, userId)
  if (existingSession) {
    return existingSession  // <-- Returns existing, no new creation
  }

  // Create new session
  await setDoc(doc(db, COLLECTIONS.SESSION_STATE, sessionId), sessionData)
  return { id: sessionId, ...sessionData }
}
```

**Access Control Note:**
- `createOrResumeSession` does NOT validate assignment membership
- It only passes `assignmentId` through if provided
- No call to `getAssignment` or assignment validation within this function

### Server-Side Write Paths (Cloud Functions)

- Evidence: `functions/index.js` - Only contains `gradeTypedTest` for vocabulary grading
- **NO AP-specific Cloud Functions found**
- All AP writes are client-side Firestore operations

---

## 3) Offline/Resilience Mechanics

**Found: Yes (Limited)**

### Offline Queue Implementation

- Evidence: `src/apBoost/hooks/useTestSession.js:L50`
```javascript
const { addToQueue, flushQueue, queueLength, isOnline, isFlushing } = useOfflineQueue(session?.id)
```

- Evidence: `src/apBoost/hooks/useOfflineQueue.js` (exists but not read in this inspection)

**Behavior:**
- Uses `addToQueue` for answer changes, navigation, timer sync, flag toggles
- `flushQueue` called before test submission (`submitTest`, line 406-408)
- Queue is per-session, not per-collection
- Does NOT appear to affect `frqUploadedFiles` or `annotatedPdfUrl` fields (these are set directly)

### No Conflict Resolution Found

- No idempotency keys or `lastModified` timestamps for FRQ fields
- No retry logic specific to the AP module (uses parent service retry from `db.js`)

---

## 4) UI/Flow Entry Points

**Found: Yes**

### FRQ Upload UI Components

| Component | File | Purpose |
|-----------|------|---------|
| `APTestSession` | `pages/APTestSession.jsx` | Hosts FRQ choice flow |
| `FRQHandwrittenMode` | `components/FRQHandwrittenMode.jsx` (imported L15) | Upload handwritten files |

- Evidence: `src/apBoost/pages/APTestSession.jsx:L182-L192`
```javascript
const handleSubmit = async () => {
  const frqData = frqSubmissionType === FRQ_SUBMISSION_TYPE.HANDWRITTEN
    ? { frqSubmissionType, frqUploadedFiles: uploadedFiles }  // <-- passes frqUploadedFiles
    : { frqSubmissionType: FRQ_SUBMISSION_TYPE.TYPED }

  const resultId = await submitTest(frqData)
  // ...
}
```

### Grading UI - Annotated PDF Upload

| Component | File | Purpose |
|-----------|------|---------|
| `GradingPanel` | `components/grading/GradingPanel.jsx` | Teacher grading with PDF upload |

- Evidence: `src/apBoost/components/grading/GradingPanel.jsx:L250,L267,L305`
```javascript
const [annotatedPdfUrl, setAnnotatedPdfUrl] = useState(null)
// ...
setAnnotatedPdfUrl(data.annotatedPdfUrl || null)  // Load existing
// ...
await saveGrade(resultId, grades, GRADING_STATUS.COMPLETE, teacherId, annotatedPdfUrl)
```

### Class Management UI

**NOT FOUND** - No dedicated class management page exists

- Evidence: `src/apBoost/routes.jsx` - No route matching `/ap/teacher/class*`
- Evidence: `src/apBoost/components/teacher/` contains only `AssignTestModal.jsx`
- Evidence: `src/apBoost/pages/` - No `APClassManager.jsx` or similar

Classes are displayed but not created/edited:
- `APTeacherDashboard` sidebar displays classes
- `AssignTestModal` lists classes for assignment selection
- No create/edit/delete class functionality

### Assignment Flow UI

| Component | File | Purpose |
|-----------|------|---------|
| `AssignTestModal` | `components/teacher/AssignTestModal.jsx` | Create test assignments |

- Evidence: `src/apBoost/components/teacher/AssignTestModal.jsx:L48`
```javascript
const [maxAttempts, setMaxAttempts] = useState(1)  // <-- Defaults to 1
```

- Evidence: `src/apBoost/components/teacher/AssignTestModal.jsx:L110-L118`
```javascript
const assignmentData = {
  testId: test.id,
  classIds: Array.from(selectedClassIds),  // <-- Uses classIds (plural)
  studentIds: Array.from(allStudentIds),
  dueDate: dueDate ? new Date(dueDate) : null,
  maxAttempts,  // <-- From state, default 1
  // ...
}
```

### Test Start Flow - Routing & Access Control

| Route | Component | Guard |
|-------|-----------|-------|
| `/ap/test/:testId` | `APTestSession` | `PrivateRoute` (auth only) |
| `/ap/test/:testId/assignment/:assignmentId` | `APTestSession` | `PrivateRoute` (auth only) |

- Evidence: `src/apBoost/routes.jsx:L25-L40`
```jsx
<Route
  path="/ap/test/:testId"
  element={
    <PrivateRoute>
      <APTestSession />
    </PrivateRoute>
  }
/>
<Route
  path="/ap/test/:testId/assignment/:assignmentId"
  element={
    <PrivateRoute>
      <APTestSession />
    </PrivateRoute>
  }
/>
```

**Access Control Analysis:**

1. **Route-level guard:** Only `PrivateRoute` (authentication check)
2. **No role check:** Teacher/student not distinguished at route level
3. **No assignment membership check:** User can navigate directly to any testId

- Evidence: `src/apBoost/hooks/useTestSession.js:L160-L206`
```javascript
async function loadTestAndSession() {
  // Load test with questions
  const testData = await getTestWithQuestions(testId)  // <-- No access check
  // ...
  // Check for existing session
  const existingSession = await getActiveSession(testId, user.uid)
  // ...
}
```

- Evidence: `src/apBoost/services/apSessionService.js:L30-L76`
```javascript
export async function createOrResumeSession(testId, userId, assignmentId = null) {
  // NO assignment membership validation
  // Just creates session if none exists
}
```

**Gap:** Direct URL navigation to `/ap/test/:testId` can bypass dashboard filtering. The `getAvailableTests` function filters by assignment, but nothing prevents direct navigation.

---

## 5) Must-Answer Questions

### Q1: Where is the canonical shape of an FRQ submission/result document defined?

**Answer:** `src/apBoost/services/apScoringService.js:L127-L154` (createTestResult function)

**Fields for uploaded student work:**
- `frqUploadedFiles` (array/object) - **YES, this is written**
- `frqUploadUrl` - **NOT USED anywhere in code**

Evidence: `src/apBoost/services/apScoringService.js:L144`
```javascript
frqUploadedFiles: frqData?.frqUploadedFiles || null,
```

### Q2: Where is the teacher's annotated/graded PDF URL stored and updated?

**Answer:** `src/apBoost/services/apGradingService.js:L165-L179` (saveGrade function)

**Field name used:** `annotatedPdfUrl` - **NOT `frqGradedPdfUrl`**

**No read fallback/aliasing exists.** The field is read directly:
- `GradingPanel.jsx:L267` - `setAnnotatedPdfUrl(data.annotatedPdfUrl || null)`
- `APReportCard.jsx:L355` - `const annotatedPdfUrl = result?.annotatedPdfUrl`

### Q3: Do any UI components or report views read these fields?

**Answer:** Yes

| Field | File | Line | Usage |
|-------|------|------|-------|
| `frqUploadedFiles` | `pages/APReportCard.jsx` | L354 | `const uploadedFiles = result?.frqUploadedFiles \|\| []` |
| `frqUploadedFiles` | `components/grading/GradingPanel.jsx` | L345 | `const uploadedFiles = result?.frqUploadedFiles \|\| []` |
| `annotatedPdfUrl` | `pages/APReportCard.jsx` | L355 | `const annotatedPdfUrl = result?.annotatedPdfUrl` |
| `annotatedPdfUrl` | `pages/APReportCard.jsx` | L206,L236,L246,L474 | Passed to HandwrittenFilesSection |
| `annotatedPdfUrl` | `components/grading/GradingPanel.jsx` | L250,L267,L305,L427,L431 | State and display |
| `frqUploadUrl` | **NOWHERE** | N/A | Not used in any code |
| `frqGradedPdfUrl` | **NOWHERE** | N/A | Not used in any code |

### Q4: Is there any function that creates classes?

**Answer:** NOT FOUND

- No `createClass` function exists in `apTeacherService.js`
- No class creation UI exists
- Only `getTeacherClasses` (read) and `getClassStudents` (read) exist

**Nearest related functionality:**
- `apTeacherService.js:L160-L178` - `getTeacherClasses(teacherId)` reads existing classes
- `apTeacherService.js:L185-L223` - `getClassStudents(classId)` reads students in a class

**Evidence of absence:** Full function exports from `apTeacherService.js`:
- `getTeacherTests`, `createTest`, `updateTest`, `deleteTest`, `getTestById`
- `getTeacherClasses`, `getClassStudents`
- `createAssignment`, `getTestAssignments`
- `getPendingGradingCount`, `getPendingGradingList`
- `publishTest`, `unpublishTest`
- **NO class write functions**

### Q5: For assignments, is `classIds` the only persisted field or does `classId` exist?

**Answer:** `classIds` (plural, array) is the ONLY field used

**Write location:** `src/apBoost/services/apTeacherService.js:L236`
```javascript
classIds: assignmentData.classIds || [],
```

**Read locations:**
- NOT directly queried (assignments are looked up by `testId` and `studentIds`)
- `studentIds` is the denormalized list used for filtering

**`classId` singular is NOT used in assignments.** It IS used in:
- `ap_test_results` schema (single classId for the result)
- `ap_session_state` schema (session.classId)
- Grading filter queries

### Q6: What is the default for `maxAttempts` in BOTH UI and service?

**Answer:** Default is `1` in BOTH places

**UI default:** `src/apBoost/components/teacher/AssignTestModal.jsx:L48`
```javascript
const [maxAttempts, setMaxAttempts] = useState(1)
```

**Service default:** `src/apBoost/services/apTeacherService.js:L239`
```javascript
maxAttempts: assignmentData.maxAttempts || 1,
```

**No normalization for "0":** The `|| 1` fallback would treat `0` as falsy and default to `1`.

### Q7: Is student access control enforced when calling `createOrResumeSession`?

**Answer:** NO - not enforced in `createOrResumeSession`

**Client-side gating:** Only `getAvailableTests` filters by assignment
- Evidence: `src/apBoost/services/apTestService.js:L41-L44`
```javascript
const assignmentsQuery = query(
  collection(db, COLLECTIONS.ASSIGNMENTS),
  where('studentIds', 'array-contains', userId)
)
```

**Direct URL bypass is possible:**
- Routes `/ap/test/:testId` and `/ap/test/:testId/assignment/:assignmentId` only check authentication
- `useTestSession` hook calls `getTestWithQuestions(testId)` without assignment check
- `createOrResumeSession` accepts any `testId` and `userId` combination

**Evidence:** `src/apBoost/hooks/useTestSession.js:L168-L173`
```javascript
// Load test with questions
const testData = await getTestWithQuestions(testId)  // <-- No assignment check
if (!testData) {
  throw new Error('Test not found')
}
setTest(testData)
```

### Q8: Are there Firestore Security Rules enforcing assignment membership?

**Answer:** NO - No AP-specific rules exist

**Evidence:** `firestore.rules` (full file reviewed)
- Rules exist for: `users`, `classes`, `lists`, `attempts`, `system_logs`
- NO rules for: `ap_tests`, `ap_questions`, `ap_stimuli`, `ap_session_state`, `ap_test_results`, `ap_classes`, `ap_assignments`

**AP collections have NO security rules defined.** Default behavior is deny all (unless a parent match exists, which doesn't apply here).

### Q9: What composite indexes are defined in `firestore.indexes.json`?

**Answer:** Only indexes for `attempts` collection (VocaBoost, not AP)

**Evidence:** `firestore.indexes.json:L1-L37`
```json
{
  "indexes": [
    {
      "collectionGroup": "attempts",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "teacherId", "order": "ASCENDING" },
        { "fieldPath": "submittedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "attempts",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "teacherId", "order": "ASCENDING" },
        { "fieldPath": "classId", "order": "ASCENDING" },
        { "fieldPath": "submittedAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**NO AP indexes defined.** The following queries may fail or be slow:

| Service | Query Pattern | Needs Index? |
|---------|---------------|--------------|
| `apTeacherService.getTeacherTests` | `where('createdBy') + orderBy('createdAt')` | YES |
| `apTeacherService.getTeacherClasses` | `where('teacherId') + orderBy('name')` | YES |
| `apTeacherService.getTestAssignments` | `where('testId') + orderBy('assignedAt')` | YES |
| `apGradingService.getPendingGrades` | `where('gradingStatus') + where('testId') + orderBy('completedAt')` | YES |
| `apSessionService.getActiveSession` | `where('testId') + where('userId') + where('status')` | YES |
| `apQuestionService.getQuestions` | Multiple where + orderBy | YES |

### Q10: Are there runtime "missing index" error handlers?

**Answer:** NOT FOUND

- No `failed-precondition` catch blocks in AP services
- No FirebaseError type checking in AP services
- Errors are logged generically via `logError` utility

**Evidence:** Search result for "failed-precondition" in `src/apBoost/`:
```
# Only found in fix plan documentation, not in actual code
```

---

## Summary of Critical Gaps

1. **Field Naming:** Uses `frqUploadedFiles` and `annotatedPdfUrl` instead of spec's `frqUploadUrl` and `frqGradedPdfUrl`

2. **No Class Creation:** `createClass` function missing; no UI for class management

3. **maxAttempts Default:** Defaults to `1`, spec says `3`

4. **No Assignment Access Control:** Direct URL navigation can bypass dashboard filtering; no server-side enforcement

5. **No Firestore Rules for AP:** All AP collections lack security rules

6. **No Composite Indexes for AP:** Query patterns may fail without proper indexes
