# Section 19.1 to 19.10 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 19.1 to 19.10:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 19.1 to 19.10 (Utilities Detailed)

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_19.1_to_19.10_criteria_audit.md

## Executive Summary
- Total Issues: 11
- ⚠️ Partial Implementations: 6
- ❌ Missing Features: 5
- ❓ Needs Investigation: 0
- Estimated Complexity: Medium

---

## Issue 1: Subject Constants File Location

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Subject constants for AP subjects should be in `apTypes.js`
- **Current State:** Subject constants are defined in `apTestConfig.js:5-66` instead of `apTypes.js`

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/apTestConfig.js` (lines 5-66) - Contains `AP_SUBJECTS` object
  - `src/apBoost/utils/apTypes.js` (lines 1-99) - Type constants file
- **Current Implementation:** `AP_SUBJECTS` object with id, name, shortName, and color properties is in `apTestConfig.js`
- **Gap:** Criteria specifies subject constants should be in `apTypes.js`
- **Dependencies:** Components importing from `apTestConfig.js` for subject data

### Fix Plan

#### Step 1: Export Subject IDs from apTypes.js
**File:** `src/apBoost/utils/apTypes.js`
**Action:** Add subject ID constants
**Details:**
- Add `AP_SUBJECT` constant object after line 75 (after `DIFFICULTY`):
```javascript
// AP Subjects (IDs only - full config in apTestConfig.js)
export const AP_SUBJECT = {
  US_HISTORY: 'AP_US_HISTORY',
  WORLD_HISTORY: 'AP_WORLD_HISTORY',
  EURO_HISTORY: 'AP_EURO_HISTORY',
  LANG: 'AP_LANG',
  LIT: 'AP_LIT',
  GOV: 'AP_GOV',
  PSYCH: 'AP_PSYCH',
  BIO: 'AP_BIO',
  CHEM: 'AP_CHEM',
  PHYSICS: 'AP_PHYSICS',
}
```

#### Step 2: Update apTestConfig.js to reference apTypes.js
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Import and use constants from apTypes
**Details:**
- Import `AP_SUBJECT` from `./apTypes`
- Update `AP_SUBJECTS` to use the constants for IDs

### Verification Steps
1. Verify `AP_SUBJECT` constants are exported from `apTypes.js`
2. Verify no circular import issues
3. Test that existing code using `AP_SUBJECTS` still works

### Potential Risks
- **Circular imports:** If `apTestConfig.js` imports from `apTypes.js` and vice versa - Mitigation: Keep subject IDs simple strings in `apTypes.js`
- **Breaking changes:** Components may expect specific import paths - Mitigation: Keep `AP_SUBJECTS` in `apTestConfig.js` but add subject ID constants to `apTypes.js`

---

## Issue 2: Subject Configurations Missing Default Time Limits

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Subject configurations should include default time limits
- **Current State:** `AP_SUBJECTS` has id, name, shortName, color - but NO default time limits

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/apTestConfig.js` (lines 5-66) - Subject config object
- **Current Implementation:** Each subject has: `{ id, name, shortName, color }`
- **Gap:** Missing `defaultTimeLimits` property for each subject (typically MCQ section time, FRQ section time)
- **Dependencies:** Timer logic in `useTestSession.js`, test creation forms

### Fix Plan

#### Step 1: Add default time limits to each subject
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Modify AP_SUBJECTS entries
**Details:**
- Add `defaultTimeLimits` property to each subject:
```javascript
AP_US_HISTORY: {
  id: 'AP_US_HISTORY',
  name: 'AP United States History',
  shortName: 'APUSH',
  color: '#1a365d',
  defaultTimeLimits: {
    mcqMinutes: 55,    // Per actual AP APUSH exam
    frqMinutes: 100,   // SAQs + DBQ + LEQ
  },
},
```
- Research actual AP exam times for each subject:
  - AP US History: 55 min MCQ, 100 min FRQ
  - AP World History: 55 min MCQ, 100 min FRQ
  - AP Euro History: 55 min MCQ, 100 min FRQ
  - AP Lang: 60 min MCQ, 135 min FRQ
  - AP Lit: 60 min MCQ, 120 min FRQ
  - AP Gov: 80 min MCQ, 100 min FRQ
  - AP Psych: 70 min MCQ (no FRQ on AP Psych)
  - AP Bio: 90 min MCQ, 90 min FRQ
  - AP Chem: 90 min MCQ, 105 min FRQ
  - AP Physics: 90 min MCQ, 90 min FRQ

#### Step 2: Add helper function to get default time
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Add new function after `calculateTotalTime`
**Details:**
```javascript
/**
 * Get default time limits for a subject
 * @param {string} subjectId - Subject ID
 * @returns {Object} { mcqMinutes, frqMinutes }
 */
export function getSubjectDefaultTimeLimits(subjectId) {
  const subject = AP_SUBJECTS[subjectId]
  return subject?.defaultTimeLimits || { mcqMinutes: 45, frqMinutes: 60 }
}
```

### Verification Steps
1. Verify each subject has `defaultTimeLimits` property
2. Test `getSubjectDefaultTimeLimits()` returns correct values
3. Verify test creation can use these defaults

### Potential Risks
- **Incorrect time limits:** Must research actual AP exam times - Mitigation: Document sources
- **Low risk:** Additive change, doesn't break existing code

---

## Issue 3: Default Score Ranges in Wrong File

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Default score ranges for AP 1-5 conversion should be in `apTestConfig.js`
- **Current State:** `DEFAULT_SCORE_RANGES` is defined in `apTypes.js:81-87` instead of `apTestConfig.js`

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/apTypes.js` (lines 81-87) - Contains `DEFAULT_SCORE_RANGES`
  - `src/apBoost/utils/apTestConfig.js` - Configuration file where it should be
- **Current Implementation:** Score ranges in `apTypes.js`:
  ```javascript
  export const DEFAULT_SCORE_RANGES = {
    ap5: { min: 80, max: 100 },
    ap4: { min: 65, max: 79 },
    ap3: { min: 50, max: 64 },
    ap2: { min: 35, max: 49 },
    ap1: { min: 0, max: 34 },
  }
  ```
- **Gap:** Configuration data should be in config file, not types file
- **Dependencies:** `apScoringService.js` likely imports this

### Fix Plan

#### Step 1: Move DEFAULT_SCORE_RANGES to apTestConfig.js
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Add score ranges constant
**Details:**
- Add after `getAllSubjects()` function (around line 85):
```javascript
// Default score ranges for AP 1-5 conversion
export const DEFAULT_SCORE_RANGES = {
  ap5: { min: 80, max: 100 },
  ap4: { min: 65, max: 79 },
  ap3: { min: 50, max: 64 },
  ap2: { min: 35, max: 49 },
  ap1: { min: 0, max: 34 },
}
```

#### Step 2: Update apTypes.js
**File:** `src/apBoost/utils/apTypes.js`
**Action:** Remove and re-export
**Details:**
- Remove lines 80-87 (the DEFAULT_SCORE_RANGES definition)
- Add re-export for backward compatibility:
```javascript
// Re-export from apTestConfig for backward compatibility
export { DEFAULT_SCORE_RANGES } from './apTestConfig'
```

#### Step 3: Update imports in consuming files
**File:** Any file importing `DEFAULT_SCORE_RANGES` from `apTypes.js`
**Action:** Update import path (or keep as-is if re-export works)
**Details:**
- Search for: `import { DEFAULT_SCORE_RANGES } from`
- Verify imports work with re-export

### Verification Steps
1. Verify `DEFAULT_SCORE_RANGES` exports from both files
2. Test scoring service still calculates AP scores correctly
3. No import errors in consuming files

### Potential Risks
- **Breaking imports:** Existing code may import from apTypes - Mitigation: Re-export for compatibility
- **Low risk:** Simple move with backward compatibility

---

## Issue 4: logError sessionId/userId Handling

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Includes sessionId and userId if available
- **Current State:** Context object is passed through, but sessionId/userId not explicitly extracted/handled

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/logError.js` (lines 14-34) - Main logError function
- **Current Implementation:**
  ```javascript
  const errorInfo = {
    function: functionName,
    context,  // Just stores raw context object
    message: error?.message || String(error || 'Unknown error'),
    ...
  }
  ```
- **Gap:** sessionId and userId should be extracted to top-level for easier filtering in error tracking systems
- **Dependencies:** All error logging calls pass context with sessionId/userId

### Fix Plan

#### Step 1: Extract sessionId and userId to top level
**File:** `src/apBoost/utils/logError.js`
**Action:** Modify errorInfo construction
**Details:**
- Update lines 15-23 to explicitly extract key identifiers:
```javascript
export function logError(functionName, context = {}, error = null) {
  // Extract key identifiers for top-level visibility
  const { sessionId, userId, ...restContext } = context

  const errorInfo = {
    function: functionName,
    // Top-level identifiers for filtering/grouping in error tracking
    sessionId: sessionId || null,
    userId: userId || null,
    // Full context object
    context: restContext,
    message: error?.message || String(error || 'Unknown error'),
    code: error?.code || null,
    stack: error?.stack || null,
    timestamp: new Date().toISOString(),
    userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'N/A',
  }
  ...
}
```

#### Step 2: Document expected context properties
**File:** `src/apBoost/utils/logError.js`
**Action:** Update JSDoc
**Details:**
- Update the `@param {Object} context` documentation:
```javascript
/**
 * Log an error with context information
 * @param {string} functionName - Name of the function where error occurred
 * @param {Object} context - Additional context
 * @param {string} [context.sessionId] - Session ID if in test session
 * @param {string} [context.userId] - User ID if authenticated
 * @param {Error|string} error - The error object or message
 */
```

### Verification Steps
1. Log an error with sessionId/userId in context
2. Verify sessionId/userId appear at top level in console output
3. Verify remaining context still included

### Potential Risks
- **Low risk:** Non-breaking enhancement, just adds structured extraction

---

## Issue 5: generateAnswerSheetPdf Missing AP Logo

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Includes AP logo, header with test/student info
- **Current State:** Has header with title, test name, student name - but NO AP logo

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/generateAnswerSheetPdf.js` (lines 62-97) - Header section
  - `public/apBoost/ap_logo.png` - Logo file EXISTS (100x100 approx)
  - `public/apBoost/ap_logo_small.png` - Smaller version EXISTS
- **Current Implementation:** Title "ANSWER SHEET" centered, test title, student info fields
- **Gap:** No AP logo included in header
- **Dependencies:** jsPDF `addImage()` method, must load image as base64 or URL

### Fix Plan

#### Step 1: Add logo embedding function
**File:** `src/apBoost/utils/generateAnswerSheetPdf.js`
**Action:** Add helper to load and embed logo
**Details:**
- Add helper function before `generateAnswerSheetPdf`:
```javascript
/**
 * Load image as base64 for PDF embedding
 * @param {string} src - Image source path
 * @returns {Promise<string>} Base64 data URL
 */
async function loadImageAsBase64(src) {
  return new Promise((resolve, reject) => {
    const img = new Image()
    img.crossOrigin = 'anonymous'
    img.onload = () => {
      const canvas = document.createElement('canvas')
      canvas.width = img.width
      canvas.height = img.height
      const ctx = canvas.getContext('2d')
      ctx.drawImage(img, 0, 0)
      resolve(canvas.toDataURL('image/png'))
    }
    img.onerror = reject
    img.src = src
  })
}
```

#### Step 2: Add logo to header
**File:** `src/apBoost/utils/generateAnswerSheetPdf.js`
**Action:** Modify header section (around line 62)
**Details:**
- Add logo loading at start of function:
```javascript
// Load AP logo
let logoData = null
try {
  logoData = await loadImageAsBase64('/apBoost/ap_logo_small.png')
} catch (e) {
  console.warn('Could not load AP logo for PDF:', e)
}
```
- Insert logo before title (around line 65):
```javascript
// Add AP logo if loaded
if (logoData) {
  const logoWidth = 15  // mm
  const logoHeight = 15 // mm (maintain aspect ratio)
  doc.addImage(logoData, 'PNG', margin, yPos - 5, logoWidth, logoHeight)
  yPos += logoHeight + 5
}

// Title (shift right if logo present)
doc.setFontSize(18)
doc.setFont('helvetica', 'bold')
```

### Verification Steps
1. Generate PDF and verify logo appears in header
2. Verify PDF still generates if logo fails to load (graceful degradation)
3. Check logo positioning and sizing

### Potential Risks
- **CORS issues:** Loading from public folder should work, but test in production - Mitigation: Try/catch with fallback
- **Performance:** Async image loading adds latency - Mitigation: Logo is small, impact minimal

---

## Issue 6: generateReportPdf Returns jsPDF Instead of Blob

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Returns Blob for download
- **Current State:** Returns jsPDF document object (line 235: `return doc`), not Blob

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/generateReportPdf.js` (line 235) - Returns `doc`
  - `downloadReportPdf()` function (lines 244-248) - Uses `doc.save()`
- **Current Implementation:** Returns raw jsPDF doc, `downloadReportPdf` calls `doc.save()`
- **Gap:** Spec says return Blob; current approach works but doesn't match spec
- **Dependencies:** Any code calling `generateReportPdf()` directly

### Fix Plan

#### Step 1: Change return type to Blob
**File:** `src/apBoost/utils/generateReportPdf.js`
**Action:** Modify return statement
**Details:**
- Change line 235 from:
```javascript
return doc
```
- To:
```javascript
return doc.output('blob')
```

#### Step 2: Update downloadReportPdf to use Blob
**File:** `src/apBoost/utils/generateReportPdf.js`
**Action:** Modify download function
**Details:**
- Update `downloadReportPdf` (lines 244-248):
```javascript
export async function downloadReportPdf(result, test, student) {
  const blob = await generateReportPdf(result, test, student)

  // Create download link
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `AP_Report_${student?.name?.replace(/\s+/g, '_') || 'Student'}_${new Date().toISOString().split('T')[0]}.pdf`
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
}
```

#### Step 3: Update JSDoc return type
**File:** `src/apBoost/utils/generateReportPdf.js`
**Action:** Update function documentation
**Details:**
- Change line 12 from `@returns {jsPDF}` to `@returns {Promise<Blob>}`

### Verification Steps
1. Verify `generateReportPdf()` returns a Blob
2. Verify `downloadReportPdf()` still works
3. Test PDF content is correct after change

### Potential Risks
- **Breaking changes:** If any code expects jsPDF doc object - Mitigation: Search codebase for direct calls
- **Low risk:** `downloadReportPdf` is likely the only consumer

---

## Issue 7: generateQuestionsPdf Returns jsPDF Instead of Blob

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Returns Blob for download
- **Current State:** Returns jsPDF document object (line 262: `return doc`), not Blob

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/generateQuestionsPdf.js` (line 262) - Returns `doc`
  - `downloadQuestionsPdf()` function (lines 271-275) - Uses `doc.save()`
- **Current Implementation:** Same pattern as `generateReportPdf`
- **Gap:** Spec says return Blob
- **Dependencies:** Any code calling `generateQuestionsPdf()` directly

### Fix Plan

#### Step 1: Change return type to Blob
**File:** `src/apBoost/utils/generateQuestionsPdf.js`
**Action:** Modify return statement
**Details:**
- Change line 262 from:
```javascript
return doc
```
- To:
```javascript
return doc.output('blob')
```

#### Step 2: Update downloadQuestionsPdf to use Blob
**File:** `src/apBoost/utils/generateQuestionsPdf.js`
**Action:** Modify download function
**Details:**
- Update `downloadQuestionsPdf` (lines 271-275):
```javascript
export async function downloadQuestionsPdf(test, questions, options = {}) {
  const blob = await generateQuestionsPdf(test, questions, options)

  // Create download link
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `${test?.title?.replace(/\s+/g, '_') || 'Questions'}_${options.includeAnswers ? 'Teacher' : 'Student'}.pdf`
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
}
```

#### Step 3: Update JSDoc return type
**File:** `src/apBoost/utils/generateQuestionsPdf.js`
**Action:** Update function documentation
**Details:**
- Change line 13 `@returns {jsPDF}` to `@returns {Promise<Blob>}`

### Verification Steps
1. Verify `generateQuestionsPdf()` returns a Blob
2. Verify `downloadQuestionsPdf()` still works
3. Test both teacher and student editions

### Potential Risks
- **Same as Issue 6:** Low risk, only download helper uses it

---

## Issue 8: Section Type Configurations Missing

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Section type configurations in `apTestConfig.js`
- **Current State:** `SECTION_TYPE` constants exist in `apTypes.js:27-31` but no detailed configurations

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/apTypes.js` (lines 27-31) - Has `SECTION_TYPE` enum: MCQ, FRQ, MIXED
  - `src/apBoost/utils/apTestConfig.js` - Should have section configs
- **Current Implementation:** Only enum values exist, no configuration data
- **Gap:** Need section type configs with default time limits, question counts, etc.
- **Dependencies:** Test creation, section display, timer initialization

### Fix Plan

#### Step 1: Add section type configurations
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Add new configuration object
**Details:**
- Add after `DEFAULT_SCORE_RANGES`:
```javascript
/**
 * Section type configurations
 * Default settings for each section type
 */
export const SECTION_TYPE_CONFIG = {
  MCQ: {
    id: 'MCQ',
    name: 'Multiple Choice',
    description: 'Multiple choice questions',
    defaultTimeMinutes: 45,
    defaultQuestionCount: 55,
    allowSkipping: true,
    showTimer: true,
    autoSubmitOnExpire: true,
  },
  FRQ: {
    id: 'FRQ',
    name: 'Free Response',
    description: 'Free response questions including SAQ, DBQ, LEQ',
    defaultTimeMinutes: 60,
    defaultQuestionCount: 4,
    allowSkipping: true,
    showTimer: true,
    autoSubmitOnExpire: true,
  },
  MIXED: {
    id: 'MIXED',
    name: 'Mixed',
    description: 'Combination of MCQ and FRQ questions',
    defaultTimeMinutes: 45,
    defaultQuestionCount: 20,
    allowSkipping: true,
    showTimer: true,
    autoSubmitOnExpire: true,
  },
}
```

#### Step 2: Add helper function
**File:** `src/apBoost/utils/apTestConfig.js`
**Action:** Add getter function
**Details:**
```javascript
/**
 * Get section type configuration
 * @param {string} sectionType - Section type (MCQ, FRQ, MIXED)
 * @returns {Object} Section configuration
 */
export function getSectionTypeConfig(sectionType) {
  return SECTION_TYPE_CONFIG[sectionType] || SECTION_TYPE_CONFIG.MIXED
}
```

### Verification Steps
1. Verify `SECTION_TYPE_CONFIG` exports correctly
2. Test `getSectionTypeConfig()` returns correct defaults
3. Verify test creation can use these configs

### Potential Risks
- **Low risk:** Additive feature, doesn't break existing code

---

## Issue 9: validateSession.js Missing (Critical)

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** `validateSessionData(data)` function that checks all required session fields and returns validation result with errors
- **Current State:** No `validateSession.js` file exists in `src/apBoost/utils/`

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/services/apSessionService.js` - Creates/manages session data
  - `src/apBoost/hooks/useTestSession.js` - Uses session data
- **Current Implementation:** Session structure from `apSessionService.js:48-67`:
  ```javascript
  const sessionData = {
    userId,
    testId,
    assignmentId,
    sessionToken,
    status,
    attemptNumber,
    currentSectionIndex,
    currentQuestionIndex,
    sectionTimeRemaining: {},
    answers: {},
    flaggedQuestions: [],
    annotations: {},
    strikethroughs: {},
    lastHeartbeat,
    lastAction,
    startedAt,
    completedAt,
  }
  ```
- **Gap:** No validation utility to check session data integrity
- **Dependencies:** Session recovery, data syncing, conflict resolution

### Fix Plan

#### Step 1: Create validateSession.js
**File:** `src/apBoost/utils/validateSession.js` (NEW FILE)
**Action:** Create new utility file
**Details:**
```javascript
/**
 * Session Data Validation Utility
 * Validates session data structure and integrity
 */

import { SESSION_STATUS } from './apTypes'

/**
 * Required fields for a valid session
 */
const REQUIRED_FIELDS = [
  'userId',
  'testId',
  'status',
  'currentSectionIndex',
  'currentQuestionIndex',
]

/**
 * Optional fields with default values
 */
const OPTIONAL_FIELDS = {
  assignmentId: null,
  sessionToken: null,
  attemptNumber: 1,
  sectionTimeRemaining: {},
  answers: {},
  flaggedQuestions: [],
  annotations: {},
  strikethroughs: {},
  lastHeartbeat: null,
  lastAction: null,
  startedAt: null,
  completedAt: null,
}

/**
 * Validate session data
 * @param {Object} data - Session data to validate
 * @returns {Object} { valid: boolean, errors: string[], warnings: string[], sanitized: Object }
 */
export function validateSessionData(data) {
  const errors = []
  const warnings = []

  if (!data || typeof data !== 'object') {
    return {
      valid: false,
      errors: ['Session data is null or not an object'],
      warnings: [],
      sanitized: null,
    }
  }

  // Check required fields
  for (const field of REQUIRED_FIELDS) {
    if (data[field] === undefined || data[field] === null) {
      errors.push(`Missing required field: ${field}`)
    }
  }

  // Validate specific field types
  if (data.userId && typeof data.userId !== 'string') {
    errors.push('userId must be a string')
  }

  if (data.testId && typeof data.testId !== 'string') {
    errors.push('testId must be a string')
  }

  if (data.status && !Object.values(SESSION_STATUS).includes(data.status)) {
    errors.push(`Invalid status: ${data.status}. Must be one of: ${Object.values(SESSION_STATUS).join(', ')}`)
  }

  if (data.currentSectionIndex !== undefined && (typeof data.currentSectionIndex !== 'number' || data.currentSectionIndex < 0)) {
    errors.push('currentSectionIndex must be a non-negative number')
  }

  if (data.currentQuestionIndex !== undefined && (typeof data.currentQuestionIndex !== 'number' || data.currentQuestionIndex < 0)) {
    errors.push('currentQuestionIndex must be a non-negative number')
  }

  if (data.answers && typeof data.answers !== 'object') {
    errors.push('answers must be an object')
  }

  if (data.flaggedQuestions && !Array.isArray(data.flaggedQuestions)) {
    errors.push('flaggedQuestions must be an array')
  }

  // Warnings for optional but expected fields
  if (!data.sessionToken) {
    warnings.push('sessionToken is missing - duplicate tab detection may not work')
  }

  if (!data.startedAt) {
    warnings.push('startedAt timestamp is missing')
  }

  // Create sanitized version with defaults
  const sanitized = errors.length === 0 ? {
    ...OPTIONAL_FIELDS,
    ...data,
    // Ensure arrays and objects exist
    answers: data.answers || {},
    flaggedQuestions: data.flaggedQuestions || [],
    sectionTimeRemaining: data.sectionTimeRemaining || {},
    annotations: data.annotations || {},
    strikethroughs: data.strikethroughs || {},
  } : null

  return {
    valid: errors.length === 0,
    errors,
    warnings,
    sanitized,
  }
}

/**
 * Validate session for resume (additional checks)
 * @param {Object} session - Session data
 * @param {string} expectedUserId - Expected user ID
 * @param {string} expectedTestId - Expected test ID
 * @returns {Object} { valid: boolean, errors: string[] }
 */
export function validateSessionForResume(session, expectedUserId, expectedTestId) {
  const baseValidation = validateSessionData(session)
  const errors = [...baseValidation.errors]

  if (baseValidation.valid) {
    // Check user match
    if (session.userId !== expectedUserId) {
      errors.push('Session belongs to a different user')
    }

    // Check test match
    if (session.testId !== expectedTestId) {
      errors.push('Session is for a different test')
    }

    // Check status allows resume
    if (session.status === SESSION_STATUS.COMPLETED) {
      errors.push('Session is already completed and cannot be resumed')
    }
  }

  return {
    valid: errors.length === 0,
    errors,
  }
}

/**
 * Check if session data is stale
 * @param {Object} session - Session data
 * @param {number} maxAgeMs - Maximum age in milliseconds (default: 24 hours)
 * @returns {boolean} True if session is stale
 */
export function isSessionStale(session, maxAgeMs = 24 * 60 * 60 * 1000) {
  if (!session?.lastAction) return false

  const lastActionTime = session.lastAction?.toDate?.() || session.lastAction
  if (!(lastActionTime instanceof Date)) return false

  const age = Date.now() - lastActionTime.getTime()
  return age > maxAgeMs
}

export default validateSessionData
```

### Verification Steps
1. Import `validateSessionData` in useTestSession.js
2. Test validation with valid session data
3. Test validation with missing required fields
4. Test validation with invalid field types
5. Verify sanitized output fills defaults

### Potential Risks
- **Low risk:** New utility, doesn't change existing behavior until integrated

---

## Issue 10: HEIC to JPEG Conversion Missing

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Converts HEIC to JPEG if needed
- **Current State:** HEIC is listed as supported format but no conversion logic exists

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/services/apStorageService.js` (line 16) - Lists 'image/heic' as supported
  - No conversion code exists in codebase
- **Current Implementation:** HEIC files are uploaded as-is
- **Gap:** HEIC format not supported by most browsers; needs conversion for display
- **Dependencies:** File upload flow, FileUpload.jsx component

### Fix Plan

#### Step 1: Install heic2any library
**File:** `package.json`
**Action:** Add dependency
**Details:**
```bash
npm install heic2any
```
- `heic2any` is the standard library for HEIC to JPEG/PNG conversion in browser

#### Step 2: Add HEIC conversion utility
**File:** `src/apBoost/utils/imageProcessing.js` (NEW FILE)
**Action:** Create new utility file
**Details:**
```javascript
/**
 * Image Processing Utilities for FRQ Uploads
 */

/**
 * Check if file is HEIC format
 * @param {File} file - File to check
 * @returns {boolean}
 */
export function isHEIC(file) {
  return file.type === 'image/heic' ||
         file.type === 'image/heif' ||
         file.name.toLowerCase().endsWith('.heic') ||
         file.name.toLowerCase().endsWith('.heif')
}

/**
 * Convert HEIC file to JPEG
 * @param {File} file - HEIC file
 * @returns {Promise<File>} Converted JPEG file
 */
export async function convertHEICtoJPEG(file) {
  if (!isHEIC(file)) {
    return file
  }

  try {
    // Dynamic import to reduce bundle size
    const heic2any = (await import('heic2any')).default

    const convertedBlob = await heic2any({
      blob: file,
      toType: 'image/jpeg',
      quality: 0.9,
    })

    // Handle case where heic2any returns array
    const resultBlob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob

    // Create new File with .jpg extension
    const newName = file.name.replace(/\.heic$/i, '.jpg').replace(/\.heif$/i, '.jpg')
    return new File([resultBlob], newName, { type: 'image/jpeg' })
  } catch (error) {
    console.error('HEIC conversion failed:', error)
    throw new Error('Failed to convert HEIC image. Please convert to JPEG manually.')
  }
}

/**
 * Process file for upload (convert if needed)
 * @param {File} file - File to process
 * @returns {Promise<File>} Processed file
 */
export async function processFileForUpload(file) {
  // Convert HEIC to JPEG
  if (isHEIC(file)) {
    return convertHEICtoJPEG(file)
  }

  return file
}
```

#### Step 3: Integrate in apStorageService.js
**File:** `src/apBoost/services/apStorageService.js`
**Action:** Add conversion step in upload flow
**Details:**
- Import the utility:
```javascript
import { processFileForUpload } from '../utils/imageProcessing'
```
- Modify `uploadFRQAnswerSheet` (around line 93):
```javascript
for (const file of files) {
  // Process file (convert HEIC if needed)
  const processedFile = await processFileForUpload(file)

  // Generate unique filename
  const timestamp = Date.now()
  const ext = processedFile.name.split('.').pop() || 'jpg'
  ...
}
```

### Verification Steps
1. Upload a HEIC file from iPhone
2. Verify it converts to JPEG before upload
3. Verify converted image displays correctly
4. Test error handling when conversion fails

### Potential Risks
- **Bundle size:** heic2any is ~1MB - Mitigation: Dynamic import
- **Conversion time:** HEIC conversion can take 2-5 seconds - Mitigation: Show progress indicator
- **Conversion failures:** Some HEIC variants may not convert - Mitigation: Error handling with user message

---

## Issue 11: Image Compression Missing

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Compresses images if needed
- **Current State:** No image compression logic exists

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/services/apStorageService.js` - File upload with 10MB limit
  - No compression code exists
- **Current Implementation:** Images uploaded at original size
- **Gap:** Large images may fail upload or be slow; compression would improve UX
- **Dependencies:** File upload flow

### Fix Plan

#### Step 1: Add compression to imageProcessing.js
**File:** `src/apBoost/utils/imageProcessing.js`
**Action:** Add compression function
**Details:**
- Add after `processFileForUpload`:
```javascript
/**
 * Compress an image file
 * @param {File} file - Image file to compress
 * @param {Object} options - Compression options
 * @param {number} options.maxWidth - Max width in pixels (default: 2000)
 * @param {number} options.maxHeight - Max height in pixels (default: 2000)
 * @param {number} options.quality - JPEG quality 0-1 (default: 0.85)
 * @param {number} options.maxSizeMB - Target max size in MB (default: 2)
 * @returns {Promise<File>} Compressed file
 */
export async function compressImage(file, options = {}) {
  const {
    maxWidth = 2000,
    maxHeight = 2000,
    quality = 0.85,
    maxSizeMB = 2,
  } = options

  // Skip if not an image or already small enough
  if (!file.type.startsWith('image/') || file.type === 'application/pdf') {
    return file
  }

  const maxSizeBytes = maxSizeMB * 1024 * 1024
  if (file.size <= maxSizeBytes) {
    return file // Already small enough
  }

  return new Promise((resolve, reject) => {
    const img = new Image()
    img.onload = () => {
      try {
        // Calculate new dimensions
        let { width, height } = img

        if (width > maxWidth) {
          height = (height * maxWidth) / width
          width = maxWidth
        }
        if (height > maxHeight) {
          width = (width * maxHeight) / height
          height = maxHeight
        }

        // Draw to canvas
        const canvas = document.createElement('canvas')
        canvas.width = width
        canvas.height = height
        const ctx = canvas.getContext('2d')
        ctx.drawImage(img, 0, 0, width, height)

        // Convert to blob
        canvas.toBlob(
          (blob) => {
            if (!blob) {
              reject(new Error('Compression failed'))
              return
            }

            // Create new file
            const compressedFile = new File(
              [blob],
              file.name,
              { type: 'image/jpeg' }
            )

            resolve(compressedFile)
          },
          'image/jpeg',
          quality
        )
      } catch (error) {
        reject(error)
      }
    }

    img.onerror = () => reject(new Error('Failed to load image for compression'))
    img.src = URL.createObjectURL(file)
  })
}
```

#### Step 2: Update processFileForUpload
**File:** `src/apBoost/utils/imageProcessing.js`
**Action:** Add compression step
**Details:**
```javascript
export async function processFileForUpload(file, options = {}) {
  let processedFile = file

  // Convert HEIC to JPEG
  if (isHEIC(file)) {
    processedFile = await convertHEICtoJPEG(file)
  }

  // Compress if image and large
  if (processedFile.type.startsWith('image/') && processedFile.type !== 'application/pdf') {
    processedFile = await compressImage(processedFile, options)
  }

  return processedFile
}
```

### Verification Steps
1. Upload a large image (>5MB)
2. Verify compression reduces file size
3. Verify image quality is acceptable
4. Test compression doesn't affect PDFs

### Potential Risks
- **Quality loss:** Compression reduces quality - Mitigation: Configurable quality setting, default 0.85
- **Memory usage:** Large images load into memory - Mitigation: Max dimensions limit
- **Low risk:** Graceful fallback to original file

---

## Implementation Order

Recommended order to implement fixes (considering dependencies):

1. **Issue 9: validateSession.js** - Foundation utility for session integrity; other session fixes may use this
2. **Issue 8: Section Type Configurations** - Standalone config, no dependencies
3. **Issue 2: Subject Default Time Limits** - Standalone config addition
4. **Issue 3: Move Score Ranges** - Simple reorganization
5. **Issue 1: Subject Constants Location** - File organization
6. **Issue 4: logError Enhancement** - Small improvement, standalone
7. **Issue 10: HEIC Conversion** - Create new imageProcessing.js
8. **Issue 11: Image Compression** - Build on imageProcessing.js
9. **Issue 5: Answer Sheet PDF Logo** - Standalone PDF enhancement
10. **Issue 6: Report PDF Return Blob** - Simple change
11. **Issue 7: Questions PDF Return Blob** - Simple change, same pattern as #6

---

## Cross-Cutting Concerns

### New Utility File: imageProcessing.js
Issues 10 and 11 both require creating `src/apBoost/utils/imageProcessing.js`. Implement both in same file:
- `isHEIC(file)`
- `convertHEICtoJPEG(file)`
- `compressImage(file, options)`
- `processFileForUpload(file, options)` - combines both

### PDF Generation Pattern
Issues 5, 6, 7 all relate to PDF generation utilities. Ensure consistent patterns:
- All generators return `Promise<Blob>`
- All have matching `download*Pdf()` helper
- All handle errors gracefully

---

## Notes for Implementer

1. **Testing HEIC conversion** - Requires actual HEIC file from iPhone/iPad; can't easily test in dev
2. **Logo file exists** - `/public/apBoost/ap_logo_small.png` already exists, just needs embedding
3. **heic2any bundle** - Use dynamic import to avoid bloating main bundle
4. **Validation utility** - Consider using in session recovery flow after implementation
5. **Re-exports for backward compatibility** - When moving constants between files, add re-exports to prevent breaking changes

---

## Part 2: Codebase Facts

# CODEBASE FACTS: Sections 19.1 to 19.10 (Utilities Detailed)

**CHUNK_ID:** `UNK__19.1_to_19.10`
**Generated:** 2026-01-14
**Inspector:** Claude Code

---

## 1) Canonical Data Schema / Source-of-Truth

### AP_SUBJECTS Configuration
**Found: Yes**

- **Location:** `src/apBoost/utils/apTestConfig.js:5-66`
- **Shape:** Object with subject ID keys, each containing:
  - `id: string` - Subject identifier (e.g., `'AP_US_HISTORY'`)
  - `name: string` - Full display name (e.g., `'AP United States History'`)
  - `shortName: string` - Abbreviated name (e.g., `'APUSH'`)
  - `color: string` - Hex color code (e.g., `'#1a365d'`)
- **NO default time limits present**
- **10 subjects defined:** AP_US_HISTORY, AP_WORLD_HISTORY, AP_EURO_HISTORY, AP_LANG, AP_LIT, AP_GOV, AP_PSYCH, AP_BIO, AP_CHEM, AP_PHYSICS

**Evidence:** `src/apBoost/utils/apTestConfig.js:5-24`
```javascript
export const AP_SUBJECTS = {
  AP_US_HISTORY: {
    id: 'AP_US_HISTORY',
    name: 'AP United States History',
    shortName: 'APUSH',
    color: '#1a365d', // Navy blue
  },
  AP_WORLD_HISTORY: {
    id: 'AP_WORLD_HISTORY',
    name: 'AP World History',
    shortName: 'World',
    color: '#2d3748', // Dark gray
  },
  // ... 8 more subjects
}
```

### Subject ID Constants / Enum
**Found: No**

- No `AP_SUBJECT` enum or subject ID constants exist in `apTypes.js`
- Subject identifiers are only stored as string keys within `AP_SUBJECTS` object

**Evidence:** `src/apBoost/utils/apTypes.js:1-99` - No subject-related exports besides type enums

### DEFAULT_SCORE_RANGES
**Found: Yes**

- **Location:** `src/apBoost/utils/apTypes.js:81-87`
- **NOT in apTestConfig.js** (per fix plan, should be moved)
- **Shape:**
```javascript
export const DEFAULT_SCORE_RANGES = {
  ap5: { min: 80, max: 100 },
  ap4: { min: 65, max: 79 },
  ap3: { min: 50, max: 64 },
  ap2: { min: 35, max: 49 },
  ap1: { min: 0, max: 34 },
}
```

**Evidence:** `src/apBoost/utils/apTypes.js:81-87`

### SECTION_TYPE Constants
**Found: Yes**

- **Location:** `src/apBoost/utils/apTypes.js:27-31`
- **Shape:** Simple enum only
```javascript
export const SECTION_TYPE = {
  MCQ: 'MCQ',
  FRQ: 'FRQ',
  MIXED: 'MIXED',
}
```
- **No SECTION_TYPE_CONFIG or getSectionTypeConfig()** exists currently

**Evidence:** `src/apBoost/utils/apTypes.js:27-31`

### Session Data Schema
**Found: Yes**

- **Creation Location:** `src/apBoost/services/apSessionService.js:48-67`
- **Schema Shape:**
```javascript
{
  userId: string,
  testId: string,
  assignmentId: string | null,
  sessionToken: string,
  status: SESSION_STATUS.IN_PROGRESS,
  attemptNumber: number,
  currentSectionIndex: number,
  currentQuestionIndex: number,
  sectionTimeRemaining: {},
  answers: {},
  flaggedQuestions: [],
  annotations: {},
  strikethroughs: {},
  lastHeartbeat: serverTimestamp(),
  lastAction: serverTimestamp(),
  startedAt: serverTimestamp(),
  completedAt: null,
}
```

**Evidence:** `src/apBoost/services/apSessionService.js:48-67`

### PDF Utility Function Signatures
**Found: Yes**

| Function | File | Return Type |
|----------|------|-------------|
| `generateAnswerSheetPdf(test, student, frqQuestions)` | `generateAnswerSheetPdf.js:10` | `Blob` |
| `downloadAnswerSheetPdf(test, student, frqQuestions)` | `generateAnswerSheetPdf.js:244` | `void` (triggers download) |
| `generateReportPdf(result, test, student)` | `generateReportPdf.js:14` | `jsPDF` instance |
| `downloadReportPdf(result, test, student)` | `generateReportPdf.js:244` | `void` (uses `doc.save()`) |
| `generateQuestionsPdf(test, questions, options)` | `generateQuestionsPdf.js:14` | `jsPDF` instance |
| `downloadQuestionsPdf(test, questions, options)` | `generateQuestionsPdf.js:271` | `void` (uses `doc.save()`) |

---

## 2) Write Paths

### PDF Downloads

| What | Who Calls | Where It Goes |
|------|-----------|---------------|
| Answer sheet PDF Blob | `downloadAnswerSheetPdf()` | Browser download via `URL.createObjectURL()` |
| Report PDF | `downloadReportPdf()` | Browser download via `doc.save()` |
| Questions PDF | `downloadQuestionsPdf()` | Browser download via `doc.save()` |

**Evidence:** `src/apBoost/utils/generateAnswerSheetPdf.js:248-255`
```javascript
const url = URL.createObjectURL(blob)
const link = document.createElement('a')
link.href = url
link.download = `answer_sheet_${test.title?.replace(/[^a-z0-9]/gi, '_') || 'test'}.pdf`
document.body.appendChild(link)
link.click()
```

**Evidence:** `src/apBoost/utils/generateReportPdf.js:247`
```javascript
doc.save(filename)
```

### FRQ File Uploads

| What | Who Calls | Where It Goes |
|------|-----------|---------------|
| FRQ answer sheet files | `FRQHandwrittenMode.jsx` -> `uploadFRQAnswerSheet()` | Firebase Storage: `ap_frq_uploads/{userId}/{resultId}/{filename}` |
| Graded PDF | `uploadGradedPdf()` | Firebase Storage: `ap_frq_graded/{resultId}/graded_{timestamp}.pdf` |

**Evidence:** `src/apBoost/services/apStorageService.js:100-101`
```javascript
const storagePath = `ap_frq_uploads/${userId}/${resultId}/${filename}`
const storageRef = ref(storage, storagePath)
```

### Error Logging Output

| What | Where It Goes |
|------|---------------|
| Error info object | Console only (`console.error`) |
| No Firestore/external | Comment mentions future: Sentry/LogRocket/Crashlytics |

**Evidence:** `src/apBoost/utils/logError.js:25-33`
```javascript
// Console output for development
console.error(`[APBoost:${functionName}]`, errorInfo)

// In production, could send to:
// - Sentry/LogRocket
// - Firebase Crashlytics
// - Custom error endpoint

return errorInfo
```

### Session Creation/Persistence

| What | Who Calls | Where It Goes |
|------|-----------|---------------|
| Session document | `createOrResumeSession()` | Firestore: `ap_session_state/{sessionId}` |
| Session updates | `updateSession()`, `saveAnswer()`, etc. | Firestore: `ap_session_state/{sessionId}` |
| Test result | `createTestResult()` | Firestore: `ap_test_results/{resultId}` |

**Evidence:** `src/apBoost/services/apSessionService.js:69`
```javascript
await setDoc(doc(db, COLLECTIONS.SESSION_STATE, sessionId), sessionData)
```

---

## 3) Offline/Resilience Mechanics

### Upload Resilience
**Found: Limited**

- No retry/queue mechanism in `apStorageService.js`
- Files uploaded via basic `uploadBytes()` - no resumable uploads

**Evidence:** `src/apBoost/services/apStorageService.js:104`
```javascript
const snapshot = await uploadBytes(storageRef, file, {
```

### Session Resilience
**Found: Yes**

- **Offline queue hook:** `useOfflineQueue.js` exists
- **Heartbeat monitoring:** `useHeartbeat.js` exists
- **Duplicate tab guard:** `useDuplicateTabGuard.js` exists
- **Queue integration:** `useTestSession.js` uses `addToQueue()` for answer/position sync

**Evidence:** `src/apBoost/hooks/useTestSession.js:50-52`
```javascript
const { addToQueue, flushQueue, queueLength, isOnline, isFlushing } = useOfflineQueue(session?.id)
const { instanceToken, isInvalidated, takeControl } = useDuplicateTabGuard(session?.id)
const { isConnected, failureCount, sessionTakenOver } = useHeartbeat(session?.id, instanceToken)
```

### Asset Loading Fallbacks
**Found: No**

- No fallback handling for logo load failures in PDF generation
- Logo is not currently embedded in PDFs (see section 5, Q7)

### HEIC Conversion Fallback
**Found: No**

- HEIC listed as supported but no conversion exists
- If conversion fails, user would get raw error

---

## 4) UI/Flow Entry Points

### PDF Generation/Download Entry Points

| Entry Point | File | Triggers |
|-------------|------|----------|
| "Download Answer Sheet PDF" button | `FRQHandwrittenMode.jsx:148` | `downloadAnswerSheetPdf()` |
| Report download (implied) | Component using `downloadReportPdf()` | Report PDF generation |
| Questions PDF (implied) | Teacher interface | `downloadQuestionsPdf()` |

**Evidence:** `src/apBoost/components/FRQHandwrittenMode.jsx:43-52`
```javascript
const handleDownloadPdf = useCallback(async () => {
  try {
    setError(null)
    await downloadAnswerSheetPdf(test, student, frqQuestions)
    setDownloadedPdf(true)
  } catch (err) {
    logError('FRQHandwrittenMode.downloadPdf', { testId: test?.id }, err)
    setError('Failed to generate answer sheet. Please try again.')
  }
}, [test, student, frqQuestions])
```

### FRQ Upload UI Entry Points

| Entry Point | File | Component |
|-------------|------|-----------|
| Handwritten FRQ upload flow | `FRQHandwrittenMode.jsx:221-232` | `<FileUpload>` with accept="image/jpeg,image/png,image/heic,image/webp,application/pdf" |
| Generic file upload | `FileUpload.jsx:119-170` | Drag-and-drop zone |

**Evidence:** `src/apBoost/components/FRQHandwrittenMode.jsx:221-232`
```javascript
<FileUpload
  accept="image/jpeg,image/png,image/heic,image/webp,application/pdf"
  multiple={true}
  maxSize={10 * 1024 * 1024}
  maxFiles={10}
  files={uploadedFiles}
  onUpload={handleUpload}
  onRemove={handleRemoveFile}
  isUploading={isUploading}
  uploadProgress={uploadProgress}
  disabled={disabled}
/>
```

### Subject Config Usage in UI

| Entry Point | File | Usage |
|-------------|------|-------|
| Test Editor subject dropdown | `APTestEditor.jsx:459` | `AP_SUBJECTS.map(s => ...)` (expects array) |
| Question Editor subject dropdown | `APQuestionEditor.jsx:342` | `AP_SUBJECTS.map(s => ...)` |
| Question Bank filter | `APQuestionBank.jsx:380` | `AP_SUBJECTS.map(s => ({ value: s.id, label: s.name }))` |

**Evidence:** `src/apBoost/pages/APTestEditor.jsx:7-8`
```javascript
import { SECTION_TYPE, DEFAULT_SCORE_RANGES, TEST_TYPE } from '../utils/apTypes'
import { AP_SUBJECTS } from '../utils/apTestConfig'
```

### Score Ranges Usage in UI

| Entry Point | File | Usage |
|-------------|------|-------|
| Test Editor score config | `APTestEditor.jsx:177-186` | Input fields for min/max with `DEFAULT_SCORE_RANGES` defaults |
| Scoring calculations | `apScoringService.js:53` | `calculateAPScore(percentage, scoreRanges = DEFAULT_SCORE_RANGES)` |

**Evidence:** `src/apBoost/pages/APTestEditor.jsx:214`
```javascript
const [scoreRanges, setScoreRanges] = useState(DEFAULT_SCORE_RANGES)
```

---

## 5) Must-Answer Questions

### Q1: Where is the canonical definition of AP subjects today?
**Answer:** `src/apBoost/utils/apTestConfig.js:5-66`

`AP_SUBJECTS` is an **object** (not array) with subject ID keys. Each entry has:
- `id: string`
- `name: string`
- `shortName: string`
- `color: string`

**Evidence:** `src/apBoost/utils/apTestConfig.js:5-66` (shown in section 1)

---

### Q2: Does apTypes.js export any subject identifiers (e.g., AP_SUBJECT)?
**Answer: No**

`apTypes.js` contains only type enums (QUESTION_TYPE, QUESTION_FORMAT, TEST_TYPE, SECTION_TYPE, SESSION_STATUS, GRADING_STATUS, etc.) and DEFAULT_SCORE_RANGES. No subject-related constants.

**Evidence:** `src/apBoost/utils/apTypes.js:1-99` - Full file contents show no AP_SUBJECT export

---

### Q3: Who imports/uses AP_SUBJECTS and how?
**Answer:** 3 direct consumers found

| File | Line | Usage |
|------|------|-------|
| `APTestEditor.jsx` | 8, 459 | Import + dropdown mapping (expects array via `.map()`) |
| `APQuestionEditor.jsx` | 7, 342 | Import + dropdown mapping |
| `APQuestionBank.jsx` | 7, 380 | Import + options mapping `s => ({ value: s.id, label: s.name })` |

**Critical Issue:** Consumers use `.map()` which expects an array, but `AP_SUBJECTS` is an object. They likely use `getAllSubjects()` or there's a bug.

**Evidence:** `src/apBoost/pages/APQuestionBank.jsx:7,380`
```javascript
import { AP_SUBJECTS } from '../utils/apTestConfig'
// ...
const subjectOptions = AP_SUBJECTS.map(s => ({ value: s.id, label: s.name }))
```

Also helper functions exist:
**Evidence:** `src/apBoost/utils/apTestConfig.js:83-85`
```javascript
export function getAllSubjects() {
  return Object.values(AP_SUBJECTS)
}
```

---

### Q4: Do subject configs include default time limit fields?
**Answer: No**

Subject configs only have: `id`, `name`, `shortName`, `color`

No `defaultTimeLimit` or similar field exists at subject level.

Section-level time limits exist in test documents (e.g., `section.timeLimit`) but not as subject defaults.

**Evidence:** `src/apBoost/utils/apTestConfig.js:5-66` shows no time fields
**Evidence:** `src/apBoost/hooks/useTestSession.js:133`
```javascript
return (currentSection.timeLimit || 45) * 60  // Default 45 min fallback
```

---

### Q5: Where is DEFAULT_SCORE_RANGES defined? Who uses it?
**Answer:**

**Definition:** `src/apBoost/utils/apTypes.js:81-87`

**Consumers:**
| File | Lines | Usage |
|------|-------|-------|
| `apScoringService.js` | 12, 53, 119 | Import + `calculateAPScore()` default param + `test.scoreRanges` fallback |
| `apTeacherService.js` | 19, 61 | Import + test creation fallback |
| `APTestEditor.jsx` | 7, 177, 186, 214, 243 | Import + state init + input defaults |

**Evidence:** `src/apBoost/services/apScoringService.js:53`
```javascript
export function calculateAPScore(percentage, scoreRanges = DEFAULT_SCORE_RANGES) {
```

**Evidence:** `src/apBoost/services/apTeacherService.js:61`
```javascript
scoreRanges: testData.scoreRanges || DEFAULT_SCORE_RANGES,
```

---

### Q6: What is the logError behavior/shape?
**Answer:**

**Function:** `src/apBoost/utils/logError.js:14-34`

**Signature:** `logError(functionName, context = {}, error = null)`

**Output Object Shape:**
```javascript
{
  function: functionName,        // string
  context: context,              // raw object passed in (NOT extracted)
  message: error?.message || String(error || 'Unknown error'),
  code: error?.code || null,
  stack: error?.stack || null,
  timestamp: new Date().toISOString(),
  userAgent: navigator.userAgent || 'N/A',
}
```

**Destination:** `console.error()` only (no Firestore, no external service)

**Does NOT extract sessionId/userId:** Context is stored as-is. The function name and context object are passed directly without field extraction.

**Evidence:** `src/apBoost/utils/logError.js:14-26`
```javascript
export function logError(functionName, context = {}, error = null) {
  const errorInfo = {
    function: functionName,
    context,  // <-- stored raw, not extracted
    message: error?.message || String(error || 'Unknown error'),
    code: error?.code || null,
    stack: error?.stack || null,
    timestamp: new Date().toISOString(),
    userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'N/A',
  }

  // Console output for development
  console.error(`[APBoost:${functionName}]`, errorInfo)
```

---

### Q7: Is there logo inclusion in generateAnswerSheetPdf.js?
**Answer: No**

No `addImage()`, base64 loading, or logo references exist in `generateAnswerSheetPdf.js`.

The header is plain text only.

**Evidence:** `src/apBoost/utils/generateAnswerSheetPdf.js:62-79`
```javascript
// ===== PAGE 1: Header =====

// Title
doc.setFontSize(18)
doc.setFont('helvetica', 'bold')
doc.text('ANSWER SHEET', pageWidth / 2, yPos, { align: 'center' })
yPos += 10

// Test title
doc.setFontSize(14)
doc.setFont('helvetica', 'normal')
doc.text(test.title || 'Practice Test', pageWidth / 2, yPos, { align: 'center' })
```

Logo files **do exist** at:
- `public/apBoost/ap_logo.png`
- `public/apBoost/ap_logo_small.png`
- (and other variants)

**Evidence:** `public/apBoost/` directory contains 9 logo files

---

### Q8: What do generateReportPdf and generateQuestionsPdf return?
**Answer:**

| Function | Returns | Download Method |
|----------|---------|-----------------|
| `generateReportPdf()` | `jsPDF` instance (line 235: `return doc`) | `downloadReportPdf()` uses `doc.save(filename)` |
| `generateQuestionsPdf()` | `jsPDF` instance (line 262: `return doc`) | `downloadQuestionsPdf()` uses `doc.save(filename)` |
| `generateAnswerSheetPdf()` | `Blob` (line 235: `return doc.output('blob')`) | `downloadAnswerSheetPdf()` uses `URL.createObjectURL()` |

**INCONSISTENCY:** Answer sheet returns Blob, others return jsPDF doc.

**Evidence:** `src/apBoost/utils/generateReportPdf.js:235`
```javascript
return doc
```

**Evidence:** `src/apBoost/utils/generateQuestionsPdf.js:262`
```javascript
return doc
```

**Evidence:** `src/apBoost/utils/generateAnswerSheetPdf.js:235`
```javascript
return doc.output('blob')
```

---

### Q9: Are there existing utilities for doc.output('blob'), doc.save(), or URL.createObjectURL?
**Answer: Yes**

| Pattern | File | Line |
|---------|------|------|
| `doc.output('blob')` | `generateAnswerSheetPdf.js` | 235 |
| `URL.createObjectURL(blob)` | `generateAnswerSheetPdf.js` | 248 |
| `doc.save(filename)` | `generateReportPdf.js` | 247 |
| `doc.save(filename)` | `generateQuestionsPdf.js` | 274 |

**Evidence:** See Q8 above

---

### Q10: Does SECTION_TYPE_CONFIG or getSectionTypeConfig() exist?
**Answer: No**

Only `SECTION_TYPE` enum exists at `src/apBoost/utils/apTypes.js:27-31`:
```javascript
export const SECTION_TYPE = {
  MCQ: 'MCQ',
  FRQ: 'FRQ',
  MIXED: 'MIXED',
}
```

No extended configuration object. No `getSectionTypeConfig()` function.

**Usage locations:**
- `apScoringService.js:91,122` - Section type checks
- `APTestEditor.jsx:73,77-79,273` - Dropdown options
- `seedTestData.js:32` - Seed data

**Evidence:** Full grep of `SECTION_TYPE_CONFIG` returns only fix plan documents, not actual code.

---

### Q11: Is there a validateSession.js or equivalent?
**Answer: No**

No `validateSession.js`, `validateSessionData()`, `validateSessionForResume()`, or `isSessionStale()` functions exist in actual code.

Searched patterns found only in fix plan/criteria audit markdown files, not in implementation.

**Evidence:** Glob search for `**/validateSession*.js` returned "No files found"

**Current session schema sources:**
- Creation: `src/apBoost/services/apSessionService.js:48-67`
- Restoration: `src/apBoost/hooks/useTestSession.js:177-195`

---

### Q12: FRQ upload flow - HEIC conversion and image compression?
**Answer:**

**Upload flow implementation:**
- **Service:** `src/apBoost/services/apStorageService.js:81-136` - `uploadFRQAnswerSheet()`
- **UI Component:** `src/apBoost/components/FRQHandwrittenMode.jsx` - Calls service via `handleUpload()`
- **Generic upload UI:** `src/apBoost/components/FileUpload.jsx` - Drag-drop zone

**HEIC Support:**
- **Accepted:** Yes, listed in `SUPPORTED_FORMATS` at `apStorageService.js:16`
- **Conversion:** **NO** - Files uploaded as-is without HEIC→JPEG conversion

**Evidence:** `src/apBoost/services/apStorageService.js:16`
```javascript
const SUPPORTED_FORMATS = ['image/jpeg', 'image/png', 'image/heic', 'image/webp', 'application/pdf']
```

**Image Compression:**
- **NOT FOUND** - No canvas-based compression, no `compressImage()`, no size threshold processing
- Files uploaded directly via `uploadBytes()` without pre-processing

**Evidence:** `src/apBoost/services/apStorageService.js:104-111`
```javascript
// Upload file
const snapshot = await uploadBytes(storageRef, file, {
  contentType: file.type,
  customMetadata: {
    originalName: file.name,
    uploadedBy: userId,
    resultId: resultId,
  }
})
```

**imageProcessing.js:** **NOT FOUND** - Glob search returned no matches

**heic2any library:** **NOT INSTALLED** - No import or usage in codebase

**Size thresholds:**
- Max per file: 10MB (`MAX_FILE_SIZE`)
- Max total: 50MB (`MAX_TOTAL_SIZE`)
- But no compression applied if under limits

**Evidence:** `src/apBoost/services/apStorageService.js:17-18`
```javascript
const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB per file
const MAX_TOTAL_SIZE = 50 * 1024 * 1024 // 50MB total
```

---

## Summary of Critical Gaps

1. **AP_SUBJECTS organization:** Object in apTestConfig.js, no ID constants in apTypes.js
2. **No default time limits:** Subject configs lack time fields
3. **DEFAULT_SCORE_RANGES location:** In apTypes.js, not apTestConfig.js
4. **logError does NOT extract sessionId/userId:** Stores context object as-is
5. **No logo in answer sheet PDF:** Header is plain text only
6. **PDF return type inconsistency:** Answer sheet returns Blob, others return jsPDF
7. **No SECTION_TYPE_CONFIG:** Only simple enum exists
8. **No validateSession utility:** Must be created
9. **No HEIC conversion:** Files uploaded as-is (browser compatibility issue)
10. **No image compression:** Direct upload without processing
