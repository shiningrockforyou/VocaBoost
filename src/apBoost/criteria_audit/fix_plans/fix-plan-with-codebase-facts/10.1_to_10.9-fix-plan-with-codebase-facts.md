# Section 10.1 to 10.9 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 10.1 to 10.9:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 10.1 to 10.9

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_10.1_to_10.9_criteria_audit.md

## Executive Summary
- Total Issues: 9
- ⚠️ Partial Implementations: 3
- ❌ Missing Features: 6
- ❓ Needs Investigation: 0
- Estimated Complexity: Low to Medium

The issues fall into three main categories:
1. **Missing PDF Download buttons** (2 issues) - PDF utility exists but not integrated
2. **Student Profile page** (6 issues) - Route and stub page completely missing
3. **UI refinements** (1 issue) - Icon vs text for Report Card link

---

## Issue 1: [Download PDF] Button Missing in MCQ Performance Grid

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** MCQ Performance Grid should have [Download PDF] button to export questions
- **Current State:** PDF generation utilities exist in `generateQuestionsPdf.js` but no button is integrated into the MCQ section of the analytics UI

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APExamAnalytics.jsx` (lines 303-348) - MCQ Section container
  - `src/apBoost/utils/generateQuestionsPdf.js` (lines 271-275) - `downloadQuestionsPdf()` function
  - `src/apBoost/components/analytics/PerformanceGrid.jsx` - MCQ grid component
- **Current Implementation:**
  - The MCQ section header (lines 305-330) contains the "Grid"/"Detailed" toggle buttons
  - `downloadQuestionsPdf(test, questions, options)` is available and exports a PDF with test questions
- **Gap:** No "Download PDF" button exists in the MCQ section header
- **Dependencies:**
  - Requires `test` and `questions` data already available in `APExamAnalytics`
  - `downloadQuestionsPdf` needs to be imported from utils

### Fix Plan

#### Step 1: Import the PDF utility in APExamAnalytics.jsx
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Add import at top of file: `import { downloadQuestionsPdf } from '../utils/generateQuestionsPdf'`
- Add this near existing imports around line 18

#### Step 2: Add handler function for MCQ PDF download
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Add a handler function after `handleQuestionClick` (around line 192):
```javascript
// Handle MCQ PDF download
const handleDownloadMcqPdf = async () => {
  if (!analytics?.test || !analytics?.questions) return
  try {
    // Filter to only MCQ questions from mcqPerformance keys
    const mcqQuestionIds = Object.keys(mcqPerformance || {})
    const mcqTest = {
      ...analytics.test,
      title: `${analytics.test.title} - MCQ Section`,
      sections: [{
        title: 'Multiple Choice',
        sectionType: 'MCQ',
        questionIds: mcqQuestionIds
      }]
    }
    await downloadQuestionsPdf(mcqTest, analytics.questions, { includeAnswers: true })
  } catch (err) {
    logError('APExamAnalytics.downloadMcqPdf', {}, err)
  }
}
```

#### Step 3: Add Download PDF button to MCQ section header
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- In the MCQ section header (around line 309), add a Download PDF button next to the Grid/Detailed toggle:
```jsx
<div className="flex items-center gap-2">
  <button
    onClick={handleDownloadMcqPdf}
    className="px-3 py-1 text-sm rounded-[--radius-button] border border-border-default text-text-secondary hover:bg-hover"
    title="Download MCQ questions as PDF"
  >
    Download PDF
  </button>
  {/* Existing Grid/Detailed buttons */}
  <button onClick={() => setMcqView('grid')} ...>Grid</button>
  <button onClick={() => setMcqView('detailed')} ...>Detailed</button>
</div>
```

### Verification Steps
1. Navigate to `/ap/teacher/analytics/:testId`
2. In the MCQ Performance section, verify "Download PDF" button appears
3. Click the button and verify a PDF downloads with MCQ questions
4. Verify PDF contains question text, choices, and correct answers

### Potential Risks
- None significant - additive change only
- PDF generation is async; may want to add loading state for large tests

---

## Issue 2: [Download PDF] Button Missing in FRQ Performance Grid

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** FRQ Performance Grid should have [Download PDF] button
- **Current State:** PDF generation utilities exist but no button in FRQ section

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APExamAnalytics.jsx` (lines 350-367) - FRQ Section container
  - `src/apBoost/utils/generateQuestionsPdf.js` - PDF generation with FRQ support (lines 184-198)
- **Current Implementation:**
  - The FRQ section has a header "Section 2: Free Response Performance" (line 353)
  - No download button exists
- **Gap:** No "Download PDF" button in FRQ section
- **Dependencies:** Same as MCQ - test and questions data available

### Fix Plan

#### Step 1: Add handler function for FRQ PDF download
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Add after the MCQ PDF handler:
```javascript
// Handle FRQ PDF download
const handleDownloadFrqPdf = async () => {
  if (!analytics?.test || !analytics?.questions) return
  try {
    const frqQuestionIds = Object.keys(frqPerformance || {})
    const frqTest = {
      ...analytics.test,
      title: `${analytics.test.title} - FRQ Section`,
      sections: [{
        title: 'Free Response',
        sectionType: 'FRQ',
        questionIds: frqQuestionIds
      }]
    }
    await downloadQuestionsPdf(frqTest, analytics.questions, { includeAnswers: true })
  } catch (err) {
    logError('APExamAnalytics.downloadFrqPdf', {}, err)
  }
}
```

#### Step 2: Modify FRQ section header to include Download PDF button
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Change FRQ section header from simple `<h2>` to flex container with button (around line 353):
```jsx
<div className="flex items-center justify-between mb-4">
  <h2 className="text-lg font-semibold text-text-primary">
    Section 2: Free Response Performance
  </h2>
  <button
    onClick={handleDownloadFrqPdf}
    className="px-3 py-1 text-sm rounded-[--radius-button] border border-border-default text-text-secondary hover:bg-hover"
    title="Download FRQ questions as PDF"
  >
    Download PDF
  </button>
</div>
```

### Verification Steps
1. Navigate to analytics page with FRQ questions
2. Verify "Download PDF" button appears in FRQ section header
3. Click and verify PDF downloads with FRQ questions and sub-question prompts
4. Verify PDF includes point values for each sub-question

### Potential Risks
- None - additive change only

---

## Issue 3: FRQ Rubric Modal Not Implemented

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Click sub-question square → Could show rubric (future feature)
- **Current State:** `onSubClick` prop is passed to FRQCard but no rubric modal is rendered

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/analytics/FRQCard.jsx` (line 66) - `onClick={() => onSubClick?.(label)}`
  - `src/apBoost/pages/APExamAnalytics.jsx` (lines 357-364) - FRQCard rendering without onSubClick handler
- **Current Implementation:**
  - FRQCard accepts `onSubClick` prop but it's not passed from parent
  - SubQuestionSquare component is clickable but click does nothing
- **Gap:** No handler passed, no modal created for rubric display
- **Dependencies:**
  - Would need access to rubric data from question structure
  - May need to fetch additional data or use existing question data

### Fix Plan

#### Step 1: Create FRQRubricModal component
**File:** `src/apBoost/components/analytics/FRQRubricModal.jsx` (NEW FILE)
**Action:** Create
**Details:**
- Create a simple modal similar to `QuestionDetailModal.jsx` pattern:
```jsx
/**
 * FRQRubricModal - Shows rubric for FRQ sub-question
 * TODO: This is a placeholder for future rubric display feature
 */
export default function FRQRubricModal({
  question,
  questionNumber,
  subLabel,
  performance,
  onClose
}) {
  const subQuestion = question?.subQuestions?.find(sq => sq.label === subLabel)

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50" onClick={onClose}>
      <div
        className="bg-surface rounded-[--radius-card] shadow-theme-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto"
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-border-default">
          <h3 className="text-lg font-semibold text-text-primary">
            FRQ {questionNumber} - Part ({subLabel})
          </h3>
          <button onClick={onClose} className="text-text-muted hover:text-text-primary text-xl">
            ✕
          </button>
        </div>

        {/* Content */}
        <div className="p-4">
          {subQuestion ? (
            <>
              <div className="mb-4">
                <h4 className="text-sm font-medium text-text-secondary mb-1">Prompt</h4>
                <p className="text-text-primary">{subQuestion.prompt || 'No prompt available'}</p>
              </div>

              <div className="mb-4">
                <h4 className="text-sm font-medium text-text-secondary mb-1">Points</h4>
                <p className="text-text-primary">{subQuestion.points || 3} points</p>
              </div>

              <div className="mb-4">
                <h4 className="text-sm font-medium text-text-secondary mb-1">Average Score</h4>
                <p className="text-text-primary">{performance?.percentage || 0}%</p>
              </div>

              {/* TODO: Add rubric display when rubric data is available */}
              <div className="bg-info rounded-[--radius-card] p-4 mt-4">
                <p className="text-info-text text-sm">
                  Detailed rubric display coming soon. This will show scoring criteria and point breakdowns.
                </p>
              </div>
            </>
          ) : (
            <p className="text-text-muted">Sub-question data not available</p>
          )}
        </div>
      </div>
    </div>
  )
}
```

#### Step 2: Add state and handler in APExamAnalytics.jsx
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Add state for selected FRQ sub-question (near line 91):
```javascript
const [selectedFrqSub, setSelectedFrqSub] = useState(null) // { questionId, label }
```
- Add handler function:
```javascript
const handleFrqSubClick = (questionId, label) => {
  setSelectedFrqSub({ questionId, label })
}
```

#### Step 3: Pass handler to FRQCard components
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Update FRQCard rendering (around line 358):
```jsx
<FRQCard
  key={questionId}
  questionNumber={index + 1}
  question={questions[questionId]}
  performance={perf}
  onSubClick={(label) => handleFrqSubClick(questionId, label)}
/>
```

#### Step 4: Import and render modal
**File:** `src/apBoost/pages/APExamAnalytics.jsx`
**Action:** Modify
**Details:**
- Add import: `import FRQRubricModal from '../components/analytics/FRQRubricModal'`
- Add modal rendering after QuestionDetailModal (around line 391):
```jsx
{selectedFrqSub && (
  <FRQRubricModal
    question={questions[selectedFrqSub.questionId]}
    questionNumber={Object.keys(frqPerformance || {}).indexOf(selectedFrqSub.questionId) + 1}
    subLabel={selectedFrqSub.label}
    performance={frqPerformance[selectedFrqSub.questionId]?.subQuestions?.[selectedFrqSub.label]}
    onClose={() => setSelectedFrqSub(null)}
  />
)}
```

### Verification Steps
1. Navigate to analytics page with FRQ questions
2. Click on a sub-question square (a, b, c, etc.)
3. Verify modal opens with sub-question information
4. Verify modal shows prompt, points, and average score
5. Verify "coming soon" note for rubric is displayed
6. Verify clicking X or outside modal closes it

### Potential Risks
- Low risk - additive feature with graceful fallback
- Future work needed to add actual rubric data when available

---

## Issue 4: "View Report" Text Instead of Icon

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Student table should have Report Card icon column with clickable icon
- **Current State:** Uses "View Report" text link instead of icon per spec

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/components/analytics/StudentResultsTable.jsx` (lines 138-140, 182-189)
- **Current Implementation:**
  - Column header shows "Actions" (line 138-140)
  - Cell content shows "View Report" text link (lines 183-188)
- **Gap:** Should use icon instead of text, header could say "Report"
- **Dependencies:** None

### Fix Plan

#### Step 1: Update column header
**File:** `src/apBoost/components/analytics/StudentResultsTable.jsx`
**Action:** Modify
**Details:**
- Change header from "Actions" to simpler format (around line 138):
```jsx
<th className="text-center py-3 px-4 text-text-secondary font-medium w-16">
  Report
</th>
```

#### Step 2: Replace text link with icon button
**File:** `src/apBoost/components/analytics/StudentResultsTable.jsx`
**Action:** Modify
**Details:**
- Replace the "View Report" link (lines 182-189) with an icon:
```jsx
<td className="py-3 px-4 text-center">
  <Link
    to={`/ap/results/${result.id}`}
    className="inline-flex items-center justify-center w-8 h-8 rounded-[--radius-button] hover:bg-hover text-text-secondary hover:text-text-primary transition-colors"
    title="View Report Card"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className="w-5 h-5"
    >
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
      <polyline points="14 2 14 8 20 8" />
      <line x1="16" y1="13" x2="8" y2="13" />
      <line x1="16" y1="17" x2="8" y2="17" />
      <polyline points="10 9 9 9 8 9" />
    </svg>
  </Link>
</td>
```

Note: Using an SVG document icon rather than emoji for better cross-platform consistency. The icon represents a document/report card.

### Verification Steps
1. Navigate to analytics page
2. Scroll to student results table
3. Verify "Report" column header appears
4. Verify document icon appears instead of "View Report" text
5. Verify hover states work on icon
6. Click icon and verify navigation to report card page

### Potential Risks
- Very low - pure UI change
- SVG icon should be tested across browsers

---

## Issue 5: Student Profile Route Missing

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Route /ap/teacher/student/:userId should exist
- **Current State:** Route is not defined in routes.jsx, navigation exists in APExamAnalytics but leads nowhere

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/routes.jsx` - Route definitions (ends at line 107, no student profile route)
  - `src/apBoost/pages/APExamAnalytics.jsx` (lines 195-197) - Navigation to `/ap/teacher/student/${userId}`
- **Current Implementation:**
  - `handleStudentClick` navigates to `/ap/teacher/student/${userId}` but no route exists
  - Other teacher routes follow pattern: `/ap/teacher/...`
- **Gap:** Route definition missing
- **Dependencies:** Requires APStudentProfile page component (Issue 6)

### Fix Plan

#### Step 1: Add route after APExamAnalytics route
**File:** `src/apBoost/routes.jsx`
**Action:** Modify
**Details:**
- Add import for APStudentProfile (after line 11):
```javascript
import APStudentProfile from './pages/APStudentProfile'
```
- Add route after the analytics route (after line 106):
```jsx
<Route
  path="/ap/teacher/student/:userId"
  element={
    <PrivateRoute>
      <APStudentProfile />
    </PrivateRoute>
  }
/>
```

### Verification Steps
1. Navigate to analytics page
2. Click on a student name
3. Verify navigation to `/ap/teacher/student/:userId` works without 404

### Potential Risks
- Depends on APStudentProfile component existing (Issue 6)
- Must be done after or alongside Issue 6

---

## Issue 6: APStudentProfile Stub Page Missing

### Audit Finding
- **Status:** ❌ Missing (6 related criteria)
- **Criterion:**
  - Placeholder/stub page with TODO note
  - Future features planned: Student's AP test history
  - Future features planned: Performance trends
  - Future features planned: Strengths/weaknesses by domain
  - Future features planned: Comparison to class average
- **Current State:** No APStudentProfile component exists

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/` - No APStudentProfile.jsx exists
  - `src/apBoost/pages/APTeacherDashboard.jsx` - Reference pattern for teacher page structure
  - `src/apBoost/components/APHeader.jsx` - Shared header component
- **Current Implementation:** No page exists
- **Gap:** Need to create complete stub page with planned feature documentation
- **Dependencies:**
  - Uses existing `APHeader` component
  - Uses existing `useAuth` context
  - Uses `react-router-dom` for params and navigation

### Fix Plan

#### Step 1: Create APStudentProfile.jsx stub page
**File:** `src/apBoost/pages/APStudentProfile.jsx` (NEW FILE)
**Action:** Create
**Details:**
```jsx
import { useParams, useNavigate, Link } from 'react-router-dom'
import { useAuth } from '../../contexts/AuthContext'
import APHeader from '../components/APHeader'

/**
 * APStudentProfile - Student profile page for teachers
 *
 * TODO: This is a stub page. Future features planned:
 * - Student's AP test history
 * - Performance trends over time
 * - Strengths/weaknesses by domain
 * - Comparison to class average
 */
export default function APStudentProfile() {
  const { userId } = useParams()
  const navigate = useNavigate()
  const { user } = useAuth()

  return (
    <div className="min-h-screen bg-base">
      <APHeader />

      <main className="max-w-4xl mx-auto px-4 py-8">
        {/* Back navigation */}
        <button
          onClick={() => navigate(-1)}
          className="text-text-muted hover:text-text-primary mb-6 flex items-center gap-1"
        >
          <span>←</span>
          <span>Back</span>
        </button>

        {/* Page header */}
        <div className="mb-8">
          <h1 className="text-2xl font-bold text-text-primary mb-2">
            Student Profile
          </h1>
          <p className="text-text-muted">
            Student ID: {userId}
          </p>
        </div>

        {/* Coming soon notice */}
        <div className="bg-surface rounded-[--radius-card] border border-border-default p-8">
          <div className="text-center">
            <div className="w-16 h-16 mx-auto mb-4 bg-muted rounded-full flex items-center justify-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                className="w-8 h-8 text-text-muted"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
            </div>

            <h2 className="text-xl font-semibold text-text-primary mb-2">
              Student Profile Coming Soon
            </h2>

            <p className="text-text-muted mb-6 max-w-md mx-auto">
              This page will provide detailed insights into individual student performance across AP tests.
            </p>

            {/* Planned features list */}
            <div className="bg-muted rounded-[--radius-card] p-6 text-left max-w-md mx-auto">
              <h3 className="text-sm font-medium text-text-secondary mb-3">
                Planned Features:
              </h3>
              <ul className="space-y-2 text-sm text-text-muted">
                <li className="flex items-start gap-2">
                  <span className="text-brand-primary mt-0.5">•</span>
                  <span>Student's AP test history with scores</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-brand-primary mt-0.5">•</span>
                  <span>Performance trends over time</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-brand-primary mt-0.5">•</span>
                  <span>Strengths and weaknesses by domain</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-brand-primary mt-0.5">•</span>
                  <span>Comparison to class average</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </main>
    </div>
  )
}
```

### Verification Steps
1. Complete Issue 5 (route addition) first
2. Navigate to analytics page
3. Click on any student name
4. Verify APStudentProfile page loads
5. Verify back button works
6. Verify all planned features are documented
7. Verify page styling matches other AP pages

### Potential Risks
- None - this is a stub page
- Future implementation will replace content but page structure is established

---

## Implementation Order

Recommended order to implement fixes (considering dependencies):

1. **Issue 6: APStudentProfile Stub Page** - Foundational; creates the page component needed by the route
2. **Issue 5: Student Profile Route** - Depends on Issue 6; adds the route definition
3. **Issue 1: MCQ Download PDF Button** - Independent; can be done in parallel with issues 3-4
4. **Issue 2: FRQ Download PDF Button** - Independent; similar to Issue 1
5. **Issue 3: FRQ Rubric Modal** - Independent; adds new component and integration
6. **Issue 4: Report Card Icon** - Independent; simple UI change

Issues 1, 2, 3, and 4 can be implemented in parallel after Issues 5 and 6 are complete.

## Cross-Cutting Concerns

### New Files to Create
1. `src/apBoost/pages/APStudentProfile.jsx` - Stub page for student profiles
2. `src/apBoost/components/analytics/FRQRubricModal.jsx` - Modal for FRQ sub-question details

### Files to Modify
1. `src/apBoost/routes.jsx` - Add student profile route
2. `src/apBoost/pages/APExamAnalytics.jsx` - Add PDF handlers, FRQ sub-click handler, modal state
3. `src/apBoost/components/analytics/StudentResultsTable.jsx` - Replace text with icon

### Design Patterns to Follow
- **Page structure**: Follow `APTeacherDashboard.jsx` pattern with `APHeader`, main content area
- **Modal structure**: Follow `QuestionDetailModal.jsx` pattern for new FRQ modal
- **Button styling**: Use existing button classes from `APExamAnalytics.jsx` Grid/Detailed toggles
- **Icon usage**: Use inline SVG for document icons (consistent with React approach, no emoji)

## Notes for Implementer

1. **PDF Download**: The `downloadQuestionsPdf` function is async but typically fast. Consider adding a loading indicator for large tests with many questions.

2. **FRQ Rubric Modal**: The current implementation is a placeholder. When rubric data becomes available in the question structure, update the modal to display actual scoring criteria.

3. **Student Profile**: This is intentionally a stub. The real implementation should:
   - Fetch student data from Firestore
   - Display test history from `ap_test_results` collection
   - Calculate performance trends using existing analytics utilities
   - Consider using charts library for trend visualization

4. **Icon Choice**: Using SVG instead of emoji for the report card icon ensures consistent rendering across platforms. If a specific icon library is added later, this can be updated.

5. **Testing**: All changes are additive and low-risk. Manual testing should verify:
   - PDF downloads work correctly
   - Navigation doesn't break existing flows
   - Modal open/close works properly
   - Responsive design is maintained

---

## Part 2: Codebase Facts

# CODEBASE_FACTS__UNK__10.1_to_10.9

**Generated:** 2026-01-14
**Chunk ID:** UNK__10.1_to_10.9
**Features in Scope:** Teacher analytics PDF download buttons, FRQ rubric click behavior, Student results table icon, APStudentProfile route

---

## 1) Canonical Data Schema / Source-of-Truth

**Found: Yes**

### Analytics Data Object Shape

The analytics data is returned from `getTestAnalytics()` in `src/apBoost/services/apAnalyticsService.js:23-80`:

```javascript
// Return shape (lines 67-75)
return {
  test,           // Test document from ap_tests collection
  questions,      // Map of { [questionId]: questionObject }
  results,        // Array of result documents from ap_test_results
  mcqPerformance, // { [questionId]: { questionId, questionNumber, correct, total, percentage } }
  frqPerformance, // { [questionId]: { questionId, questionText, totalPoints, totalMaxPoints, percentage, subQuestions: {...}, studentCount } }
  summary,        // { averageScore, averagePercentage, highestScore, lowestScore, apScoreDistribution }
  totalStudents,  // Number
}
```

### MCQ Performance Schema

From `calculateQuestionPerformance()` in `src/apBoost/services/apAnalyticsService.js:88-125`:

```javascript
// Performance object per MCQ question (lines 94-101)
performance[questionId] = {
  questionId,
  questionNumber: question.questionNumber || 0,
  correct: 0,
  total: 0,
  percentage: 0,
}
```

### FRQ Performance Schema

From `calculateFRQPerformance()` in `src/apBoost/services/apAnalyticsService.js:171-243`:

```javascript
// FRQ performance structure (lines 177-185)
performance[questionId] = {
  questionId,
  questionText: question.questionText,
  totalPoints: 0,
  totalMaxPoints: 0,
  percentage: 0,
  subQuestions: {},    // { [label]: { label, points, maxPoints, percentage, count } }
  studentCount: 0,
}

// Sub-question structure (lines 190-196)
performance[questionId].subQuestions[sq.label] = {
  label: sq.label,
  points: 0,
  maxPoints: sq.points || 3,
  percentage: 0,
  count: 0,
}
```

### Question Schema Fields

From `src/apBoost/utils/apTypes.js:6-12` and usage in PDF generator:

```javascript
// Question types
export const QUESTION_TYPE = {
  MCQ: 'MCQ',
  MCQ_MULTI: 'MCQ_MULTI',
  FRQ: 'FRQ',
  SAQ: 'SAQ',
  DBQ: 'DBQ',
}

// Question fields used (from generateQuestionsPdf.js):
// - questionText
// - questionType ('mcq', 'frq', 'saq', 'dbq')
// - choiceA, choiceB, choiceC, choiceD, choiceE
// - choiceCount
// - correctAnswers (array)
// - subQuestions (array of { label, prompt, points })
// - stimulus
// - questionDomain
// - explanation
```

### Collections

From `src/apBoost/utils/apTypes.js:90-98`:

```javascript
export const COLLECTIONS = {
  TESTS: 'ap_tests',
  QUESTIONS: 'ap_questions',
  STIMULI: 'ap_stimuli',
  SESSION_STATE: 'ap_session_state',
  TEST_RESULTS: 'ap_test_results',
  CLASSES: 'ap_classes',
  ASSIGNMENTS: 'ap_assignments',
}
```

---

## 2) Write Paths

**Found: No writes in analytics paths**

### Inspected Paths

1. **APExamAnalytics.jsx** - Searched for `updateDoc|setDoc|addDoc|deleteDoc`
   - **Result:** No matches found
   - The page is read-only; it only fetches data via `getTestAnalytics`, `getStudentResults`, etc.

2. **apAnalyticsService.js** - Searched for `updateDoc|setDoc|addDoc|deleteDoc`
   - **Result:** No matches found
   - Service only uses `getDoc`, `getDocs`, `query`, `where` (read operations)

3. **generateQuestionsPdf.js** - No Firestore imports
   - Uses `jsPDF` library to generate PDF client-side
   - `doc.save(filename)` triggers browser download, no server writes

4. **StudentResultsTable.jsx** - No Firestore imports
   - Uses `Link` for navigation and click handlers for callbacks

### Conclusion

**No writes found in inspected paths.** The analytics page and its components are entirely read-only. PDF downloads are generated client-side and saved locally via browser download.

---

## 3) Offline/Resilience Mechanics

**Not applicable for this chunk.**

Searched terms:
- `pdf save` - Only found `doc.save(filename)` in generateQuestionsPdf.js (browser download, not offline persistence)
- `retry` - Not present in analytics components
- `queue` - Not present in analytics components
- `offline` - Not present in analytics components
- `cache` - Not present in analytics components

The analytics page does not implement any offline/resilience patterns. It relies on live Firestore reads.

---

## 4) UI/Flow Entry Points

**Found: Yes**

### Teacher Analytics Route

**Route Definition:** `src/apBoost/routes.jsx:100-106`

```jsx
<Route
  path="/ap/teacher/analytics/:testId"
  element={
    <PrivateRoute>
      <APExamAnalytics />
    </PrivateRoute>
  }
/>
```

**Component:** `src/apBoost/pages/APExamAnalytics.jsx`

**Major UI Sections:**
- Summary Cards (lines 276-294)
- AP Score Distribution (lines 296-301)
- MCQ Section with Grid/Detailed toggle (lines 303-348)
- FRQ Section with FRQCard components (lines 350-367)
- Student Results Table (lines 369-378)
- QuestionDetailModal (lines 381-392)

### Student Click Navigation Target

**File:** `src/apBoost/pages/APExamAnalytics.jsx:195-197`

```javascript
const handleStudentClick = (userId) => {
  navigate(`/ap/teacher/student/${userId}`)
}
```

**Target Path:** `/ap/teacher/student/${userId}`

### Report Card Link

**File:** `src/apBoost/components/analytics/StudentResultsTable.jsx:183-189`

```jsx
<Link
  to={`/ap/results/${result.id}`}
  className="text-brand-primary hover:underline text-sm"
  title="View Report Card"
>
  View Report
</Link>
```

**Target Path:** `/ap/results/${resultId}`

---

## 5) Must-Answer Questions (from checklist)

### Question 1: Where is the teacher analytics page route defined?

**Found: Yes**

**Route:** `/ap/teacher/analytics/:testId`
**File:** `src/apBoost/routes.jsx:100-106`
**Component:** `APExamAnalytics` imported from `./pages/APExamAnalytics`

Evidence:
```jsx
// src/apBoost/routes.jsx:100-106
<Route
  path="/ap/teacher/analytics/:testId"
  element={
    <PrivateRoute>
      <APExamAnalytics />
    </PrivateRoute>
  }
/>
```

---

### Question 2: In APExamAnalytics.jsx, what is the runtime shape of analytics data?

**Found: Yes**

**Data Destructuring:** `src/apBoost/pages/APExamAnalytics.jsx:237`

```javascript
const { test, questions, mcqPerformance, frqPerformance, summary } = analytics || {}
```

**Data Loading:** Lines 116-120

```javascript
const analyticsData = await getTestAnalytics(testId, {
  classIds: allClassIds,
  studentIds: studentsData.map(s => s.id),
})
setAnalytics(analyticsData)
```

**mcqPerformance Shape:** (from apAnalyticsService.js:94-101)
```javascript
{
  [questionId]: {
    questionId: string,
    questionNumber: number,
    correct: number,
    total: number,
    percentage: number,
  }
}
```

**frqPerformance Shape:** (from apAnalyticsService.js:177-198)
```javascript
{
  [questionId]: {
    questionId: string,
    questionText: string,
    totalPoints: number,
    totalMaxPoints: number,
    percentage: number,
    subQuestions: {
      [label]: {
        label: string,
        points: number,
        maxPoints: number,
        percentage: number,
        count: number,
      }
    },
    studentCount: number,
  }
}
```

---

### Question 3: PDF utility existence and exports

**Found: Yes**

**File:** `src/apBoost/utils/generateQuestionsPdf.js`

**Exports:**
- `generateQuestionsPdf` (named export, lines 14-263)
- `downloadQuestionsPdf` (named export, lines 271-275)

**Function Signatures:**

```javascript
// Line 14
export async function generateQuestionsPdf(test, questions, options = {})

// Line 271
export async function downloadQuestionsPdf(test, questions, options = {})
```

**Options Supported:** (Line 15)
```javascript
const { includeAnswers = false, includeStimuli = true } = options
```

Evidence from file:
```javascript
// src/apBoost/utils/generateQuestionsPdf.js:7-12
/**
 * Generate a PDF of test questions
 * @param {Object} test - Test object with sections and questions
 * @param {Object} questions - Questions map
 * @param {Object} options - { includeAnswers: boolean, includeStimuli: boolean }
 * @returns {jsPDF} PDF document
 */
```

---

### Question 4: How are MCQ questions identified in analytics?

**Found: Yes**

MCQ questions are identified by iterating `mcqPerformance` keys.

**File:** `src/apBoost/pages/APExamAnalytics.jsx:131-135`

```javascript
// Pre-calculate distributions for MCQ
const dists = {}
for (const questionId of Object.keys(analyticsData.mcqPerformance || {})) {
  const { distribution } = calculateResponseDistribution(results, questionId)
  dists[questionId] = distribution
}
```

**MCQ identification in service:** `src/apBoost/services/apAnalyticsService.js:91-102`

```javascript
// Initialize performance for each MCQ question
for (const [questionId, question] of Object.entries(questions)) {
  if (question.questionType === 'mcq' || !question.questionType) {
    performance[questionId] = {
      questionId,
      questionNumber: question.questionNumber || 0,
      // ...
    }
  }
}
```

Question IDs are consistent between `mcqPerformance` and `analytics.questions` - they use the same Firestore document IDs.

---

### Question 5: FRQ questions + sub-questions structure

**Found: Yes**

**Question object subQuestions field:** Array of `{ label, prompt, points }`

Evidence from `src/apBoost/services/apAnalyticsService.js:187-198`:
```javascript
// Initialize sub-questions
if (question.subQuestions) {
  for (const sq of question.subQuestions) {
    performance[questionId].subQuestions[sq.label] = {
      label: sq.label,
      points: 0,
      maxPoints: sq.points || 3,
      percentage: 0,
      count: 0,
    }
  }
}
```

**Performance data per sub-question:** `{ label, points, maxPoints, percentage, count }`

Evidence from `src/apBoost/components/analytics/FRQCard.jsx:35-37`:
```javascript
const { percentage, subQuestions = {} } = performance
// ...
const subLabels = Object.keys(subQuestions).sort()
```

Sub-question data access in FRQCard (lines 59-67):
```javascript
{subLabels.map(label => {
  const subData = subQuestions[label] || {}
  return (
    <SubQuestionSquare
      key={label}
      label={label}
      percentage={subData.percentage || 0}
      onClick={() => onSubClick?.(label)}
    />
  )
})}
```

---

### Question 6: FRQCard click behavior

**Found: Yes**

**FRQCard accepts `onSubClick`:** `src/apBoost/components/analytics/FRQCard.jsx:29-34`

```jsx
export default function FRQCard({
  questionNumber,
  question,
  performance = {},
  onSubClick,  // <-- accepts handler
}) {
```

**SubQuestionSquare invokes `onSubClick`:** Lines 62-67

```jsx
<SubQuestionSquare
  key={label}
  label={label}
  percentage={subData.percentage || 0}
  onClick={() => onSubClick?.(label)}  // <-- invokes with label
/>
```

**Parent (APExamAnalytics.jsx) does NOT pass `onSubClick`:** Lines 357-364

```jsx
{Object.entries(frqPerformance).map(([questionId, perf], index) => (
  <FRQCard
    key={questionId}
    questionNumber={index + 1}
    question={questions[questionId]}
    performance={perf}
    // NOTE: onSubClick is NOT passed
  />
))}
```

**Conclusion:** The `onSubClick` prop exists and is called in FRQCard, but the parent component does not currently provide a handler.

---

### Question 7: Existing modal patterns

**Found: Yes**

**QuestionDetailModal exists:** `src/apBoost/components/analytics/QuestionDetailModal.jsx`

**Props:** (Lines 35-41)
```jsx
export default function QuestionDetailModal({
  question,
  questionNumber,
  distribution = {},
  totalResponses = 0,
  onClose,
}) {
```

**How it's opened/closed in APExamAnalytics.jsx:**

State storage (line 90):
```javascript
const [selectedQuestion, setSelectedQuestion] = useState(null)
```

Open handler (lines 189-192):
```javascript
const handleQuestionClick = (questionId) => {
  setSelectedQuestion(questionId)
}
```

Render condition (lines 382-392):
```jsx
{selectedQuestion && (
  <QuestionDetailModal
    question={questions[selectedQuestion]}
    questionNumber={
      Object.keys(mcqPerformance || {}).indexOf(selectedQuestion) + 1
    }
    distribution={distributions[selectedQuestion] || {}}
    totalResponses={analytics?.totalStudents || 0}
    onClose={() => setSelectedQuestion(null)}
  />
)}
```

**Other modal patterns:**
- `DuplicateTabModal.jsx` - Uses fixed positioning with backdrop (`fixed inset-0 z-50`)
- `AssignTestModal.jsx` - Uses backdrop + centered modal with `z-40`/`z-50` split

---

### Question 8: Error logging

**Found: Yes**

**logError is available in APExamAnalytics.jsx:** Line 18

```javascript
import { logError } from '../utils/logError'
```

**Usage in APExamAnalytics.jsx:**
- Line 137: `logError('APExamAnalytics.loadData', { testId }, err)`
- Line 182: `logError('APExamAnalytics.applyFilters', { testId }, err)`

**logError utility:** `src/apBoost/utils/logError.js:14-34`

```javascript
export function logError(functionName, context = {}, error = null) {
  const errorInfo = {
    function: functionName,
    context,
    message: error?.message || String(error || 'Unknown error'),
    code: error?.code || null,
    stack: error?.stack || null,
    timestamp: new Date().toISOString(),
    userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'N/A',
  }
  console.error(`[APBoost:${functionName}]`, errorInfo)
  return errorInfo
}
```

---

### Question 9: Student results table and "View Report" link

**Found: Yes**

**File:** `src/apBoost/components/analytics/StudentResultsTable.jsx`

**"View Report" link:** Lines 183-189

```jsx
<Link
  to={`/ap/results/${result.id}`}
  className="text-brand-primary hover:underline text-sm"
  title="View Report Card"
>
  View Report
</Link>
```

**Target path:** `/ap/results/${result.id}`

**Icon usage elsewhere in file:** None. The component uses text labels only ("View Report", sort arrows via text "↑"/"↓").

**Icon library available:** `lucide-react` is installed (`package.json:21`), but NOT currently imported in any apBoost files.

**Design token pattern for hover:** Uses `hover:underline` and `hover:bg-hover` classes (consistent with design token system).

---

### Question 10: Student profile navigation + route

**Found: Partial**

**Navigation target path:** `src/apBoost/pages/APExamAnalytics.jsx:195-197`

```javascript
const handleStudentClick = (userId) => {
  navigate(`/ap/teacher/student/${userId}`)
}
```

**Route definition:** **NOT FOUND**

Searched `src/apBoost/routes.jsx` - No route matching `/ap/teacher/student/:userId`.

**Closest teacher route pattern:** `src/apBoost/routes.jsx:59-66`

```jsx
<Route
  path="/ap/teacher/test/:testId/edit"
  element={
    <PrivateRoute>
      <APTestEditor />
    </PrivateRoute>
  }
/>
```

**PrivateRoute pattern:** All AP routes wrap their component with `<PrivateRoute>` from `src/components/PrivateRoute.jsx`.

---

### Question 11: APStudentProfile page

**Found: No**

**Search result:** `Glob pattern **/APStudentProfile*` returned "No files found"

**Grep result:** `APStudentProfile` only found in audit/fix plan documentation files, not in actual code.

**File does not exist:** `src/apBoost/pages/APStudentProfile.jsx` does NOT exist.

**Correct import paths from existing teacher page (APTeacherDashboard.jsx:1-6):**

```javascript
import { useState, useEffect } from 'react'
import { Link, useNavigate } from 'react-router-dom'
import { useAuth } from '../../contexts/AuthContext'
import APHeader from '../components/APHeader'
// ...services from '../services/apTeacherService'
import { logError } from '../utils/logError'
```

**Layout convention from APTeacherDashboard.jsx:**
```jsx
return (
  <div className="min-h-screen bg-base">
    <APHeader />
    <main className="max-w-6xl mx-auto px-4 py-8">
      {/* content */}
    </main>
  </div>
)
```

---

### Question 12: Are these changes read-only?

**Found: Yes - Confirmed read-only**

**Analytics page render:** Read-only (fetches via `getTestAnalytics`, `getStudentResults`)

**Download PDF:** Read-only (client-side PDF generation via jsPDF, no server calls)

**Student/report links:** Navigation only (uses `navigate()` and `<Link>`, no writes)

**Opening modals:** State changes only (`setSelectedQuestion(questionId)`)

**Searched for write operations:**
- `updateDoc|setDoc|addDoc|deleteDoc` in APExamAnalytics.jsx: No matches
- `updateDoc|setDoc|addDoc|deleteDoc` in apAnalyticsService.js: No matches
- No fetch/POST calls found in analytics components

**Conclusion:** All changes in scope are additive read-only operations. No Firestore writes, analytics tracking, or logging endpoints are triggered.

---

## Summary Table

| Item | Status | Location |
|------|--------|----------|
| Analytics route | ✅ Found | routes.jsx:100-106 |
| APExamAnalytics component | ✅ Found | pages/APExamAnalytics.jsx |
| downloadQuestionsPdf | ✅ Found | utils/generateQuestionsPdf.js:271 |
| mcqPerformance shape | ✅ Found | apAnalyticsService.js:94-101 |
| frqPerformance shape | ✅ Found | apAnalyticsService.js:177-198 |
| FRQCard onSubClick prop | ✅ Found | FRQCard.jsx:33 |
| FRQCard onSubClick handler passed | ❌ Missing | APExamAnalytics.jsx:357-364 |
| QuestionDetailModal | ✅ Found | analytics/QuestionDetailModal.jsx |
| FRQRubricModal | ❌ Not found | Does not exist |
| StudentResultsTable "View Report" | ✅ Found | StudentResultsTable.jsx:183-189 |
| /ap/teacher/student/:userId route | ❌ Not found | Not in routes.jsx |
| APStudentProfile page | ❌ Not found | Does not exist |
| lucide-react icons | ✅ Installed | package.json, not used in apBoost |
| Write operations in analytics | ❌ None | Read-only confirmed |
