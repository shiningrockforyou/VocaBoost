# Section 9.1 to 9.4 - Fix Plan with Codebase Facts

> **What is this file?**
> This document combines two resources for implementing criteria section 9.1 to 9.4:
> 1. **Fix Plan** - Step-by-step implementation instructions for code changes
> 2. **Codebase Facts** - Relevant code snippets, file paths, and existing patterns from the codebase
>
> Use the Fix Plan as your guide and reference the Codebase Facts for accurate file locations and code context.

---

## Part 1: Fix Plan

# Fix Plan: Sections 9.1 to 9.4 (Report Card)

**Planned by:** Claude Agent
**Date:** 2026-01-14
**Status:** COMPLETE
**Based on Audit:** section_9.1_to_9.4_criteria_audit.md

## Executive Summary
- Total Issues: 13
- ⚠️ Partial Implementations: 8
- ❌ Missing Features: 5
- ❓ Needs Investigation: 0
- Estimated Complexity: Medium

---

## Issue 1: Download Report PDF Button Missing

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** [Download Report PDF] button in Report Card UI
- **Current State:** The `generateReportPdf.js` utility is fully implemented with jsPDF but there is NO button in APReportCard.jsx to trigger the download.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/generateReportPdf.js` (lines 1-262) - Complete PDF generation utility
  - `src/apBoost/pages/APReportCard.jsx` (lines 497-505) - Actions section where button should go
- **Current Implementation:** The `downloadReportPdf(result, test, student)` function exists and is exported, but never imported or called in APReportCard.
- **Gap:** No import statement, no button UI, no click handler to trigger PDF download.
- **Dependencies:** None - utility is already complete.

### Fix Plan

#### Step 1: Add import for PDF utility
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify
**Details:**
- Add import at top of file (around line 7): `import { downloadReportPdf } from '../utils/generateReportPdf'`

#### Step 2: Add download button to Actions section
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (lines 497-505)
**Details:**
- Add a "Download Report PDF" button next to the "Back to Dashboard" link
- Button should call `downloadReportPdf(result, test, { name: user?.displayName || user?.email })`
- Style to match existing design tokens: `bg-brand-primary text-white px-6 py-2 rounded-[--radius-button]`

```jsx
{/* Actions */}
<div className="flex justify-center gap-4">
  <button
    onClick={() => downloadReportPdf(result, test, { name: user?.displayName || user?.email })}
    className="bg-brand-primary text-white px-6 py-2 rounded-[--radius-button] font-medium hover:opacity-90 transition-colors"
  >
    Download Report PDF
  </button>
  <Link
    to="/ap"
    className="bg-surface text-text-primary px-6 py-2 rounded-[--radius-button] border border-border-default hover:bg-hover transition-colors"
  >
    Back to Dashboard
  </Link>
</div>
```

### Verification Steps
1. Load any completed test result at /ap/results/:resultId
2. Click "Download Report PDF" button
3. Verify PDF downloads with proper filename format: `AP_Report_[StudentName]_[Date].pdf`
4. Open PDF and verify all sections render correctly

### Potential Risks
- None - utility already fully tested and used elsewhere

---

## Issue 2: Class Name Not Displayed in Header

### Audit Finding
- **Status:** ❌ Missing
- **Criterion:** Class name displayed in header section
- **Current State:** result.classId exists but is never used to fetch or display class name.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (lines 378-386) - Header section where class should be shown
  - `src/apBoost/services/apTeacherService.js` (lines 160-178) - Has getTeacherClasses but no getClassById
  - `src/apBoost/utils/apTypes.js` (line 96) - COLLECTIONS.CLASSES = 'ap_classes'
- **Current Implementation:** Header shows Student, Test, Subject, Date but NOT class name.
- **Gap:**
  1. No function to fetch a single class by ID
  2. No state to hold class name in APReportCard
  3. No display of class name in header
- **Dependencies:** New service function needed first.

### Fix Plan

#### Step 1: Add getClassById function to service
**File:** `src/apBoost/services/apTeacherService.js`
**Action:** Add new function (after getTeacherClasses around line 178)
**Details:**
- Follow existing pattern from getTestById (lines 136-153)

```javascript
/**
 * Get a single class by ID
 * @param {string} classId - Class document ID
 * @returns {Promise<Object|null>} Class object or null
 */
export async function getClassById(classId) {
  try {
    const classRef = doc(db, COLLECTIONS.CLASSES, classId)
    const classSnap = await getDoc(classRef)

    if (!classSnap.exists()) {
      return null
    }

    return {
      id: classSnap.id,
      ...classSnap.data()
    }
  } catch (error) {
    logError('apTeacherService.getClassById', { classId }, error)
    throw error
  }
}
```

#### Step 2: Import and use getClassById in APReportCard
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify
**Details:**
- Add import: `import { getClassById } from '../services/apTeacherService'`
- Add state: `const [className, setClassName] = useState(null)`
- In useEffect after loading result, fetch class if classId exists:

```javascript
// In useEffect loadResult function, after setResult(resultData):
if (resultData.classId) {
  try {
    const classData = await getClassById(resultData.classId)
    setClassName(classData?.name || null)
  } catch {
    // Ignore class fetch errors - not critical
  }
}
```

#### Step 3: Display class name in header
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (lines 378-386)
**Details:**
- Add class name row after Student row, conditionally render if className exists:

```jsx
<div>
  <p>Student: {user?.displayName || user?.email || 'Student'}</p>
  {className && <p>Class: {className}</p>}
  <p>Test: {test?.title || 'AP Practice Exam'}</p>
</div>
```

### Verification Steps
1. Create a test result with a valid classId
2. Load the report card at /ap/results/:resultId
3. Verify class name appears in header (if classId was set)
4. Verify no errors for results without classId

### Potential Risks
- Results without classId: Handle gracefully with conditional render
- Non-existent classId: getClassById returns null, no crash

---

## Issue 3: MCQ Table Missing Domain and Topic Columns

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** MCQ table columns: Q#, Answer, Response, Domain, Topic, Result
- **Current State:** Only shows Q#, Correct, Your Answer, Result. Domain and Topic are missing.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (lines 73-109) - MCQResultsTable component
  - `src/apBoost/services/apScoringService.js` (lines 97-112) - Creates mcqResults array
  - `src/apBoost/services/apQuestionService.js` (lines 164-165) - Questions have questionDomain, questionTopic fields
- **Current Implementation:** mcqResults only includes: questionId, studentAnswer, correctAnswer, correct
- **Gap:**
  1. mcqResults needs questionDomain and questionTopic fields
  2. MCQResultsTable needs to render Domain and Topic columns
- **Dependencies:** Must modify scoring service first to include metadata.

### Fix Plan

#### Step 1: Expand mcqResults to include domain/topic in scoring service
**File:** `src/apBoost/services/apScoringService.js`
**Action:** Modify (lines 106-111)
**Details:**
- Add questionDomain and questionTopic to each result object:

```javascript
mcqResults.push({
  questionId,
  studentAnswer,
  correctAnswer: correctAnswers[0] || 'N/A',
  correct: isCorrect,
  questionDomain: question.questionDomain || '',
  questionTopic: question.questionTopic || '',
})
```

#### Step 2: Update MCQResultsTable to display Domain and Topic
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (lines 73-109)
**Details:**
- Add Domain and Topic column headers (after Your Answer, before Result):

```jsx
<thead>
  <tr className="border-b border-border-default">
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Q#</th>
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Correct</th>
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Your Answer</th>
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Domain</th>
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Topic</th>
    <th className="text-left py-2 px-3 text-text-secondary font-medium">Result</th>
  </tr>
</thead>
```

- Add cells for Domain and Topic in each row:

```jsx
<td className="py-2 px-3 text-text-secondary text-sm">{result.questionDomain || '—'}</td>
<td className="py-2 px-3 text-text-secondary text-sm">{result.questionTopic || '—'}</td>
```

### Verification Steps
1. Complete a test and submit
2. View the report card
3. Verify MCQ table shows Domain and Topic columns
4. Verify data populates from question metadata

### Potential Risks
- **Existing results:** Old results won't have domain/topic in mcqResults. Table will show '—' which is acceptable.
- **Re-migration:** Could write a migration script to backfill existing results, but not critical.

---

## Issue 4: FRQ Results Missing Domain and Topic

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** FRQ column headers: Q#, Sub, Pts Max, Earned, Domain, Topic, Comment
- **Current State:** Card-based layout shows scores and comments but NO domain/topic.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (lines 156-200) - FRQGradedResults component
  - `src/apBoost/services/apGradingService.js` (lines 136-145) - Fetches frqQuestions but doesn't add to result
- **Current Implementation:** FRQ grades are stored in result.frqGrades but questions aren't loaded in report card.
- **Gap:** Need to fetch question metadata (domain/topic) for FRQ display.
- **Dependencies:** Could fetch questions on report card load OR enhance frqGrades to include metadata.

### Fix Plan

#### Step 1: Fetch FRQ questions in APReportCard for display
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify
**Details:**
- Add import: `import { getQuestion } from '../services/apTestService'`
- Add state: `const [frqQuestions, setFrqQuestions] = useState({})`
- In useEffect, after loading result, fetch FRQ questions:

```javascript
// After loading result and test:
if (resultData.frqGrades) {
  const questionsData = {}
  for (const questionId of Object.keys(resultData.frqGrades)) {
    try {
      const q = await getQuestion(questionId)
      if (q) questionsData[questionId] = q
    } catch {
      // Ignore individual question fetch errors
    }
  }
  setFrqQuestions(questionsData)
}
```

#### Step 2: Update FRQGradedResults to accept and display question metadata
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify FRQGradedResults component (lines 156-200)
**Details:**
- Add `questions` prop to FRQGradedResults
- Display domain/topic for each question:

```jsx
function FRQGradedResults({ frqGrades, questions = {} }) {
  // ... existing code ...
  {Object.entries(frqGrades).map(([questionId, grade], qIdx) => {
    const question = questions[questionId] || {}
    return (
      <div key={questionId} className="...">
        <div className="flex items-center justify-between mb-3">
          <div>
            <h4 className="text-text-primary font-medium">Question {qIdx + 1}</h4>
            {question.questionDomain && (
              <p className="text-text-secondary text-sm">
                {question.questionDomain}
                {question.questionTopic && ` - ${question.questionTopic}`}
              </p>
            )}
          </div>
          {/* existing score display */}
        </div>
        {/* rest of component */}
      </div>
    )
  })}
}
```

#### Step 3: Pass frqQuestions to FRQGradedResults
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (around line 465)
**Details:**

```jsx
<FRQGradedResults frqGrades={frqGrades} questions={frqQuestions} />
```

### Verification Steps
1. Complete a test with FRQ section and get it graded
2. View report card
3. Verify domain/topic appears under each FRQ question header

### Potential Risks
- Extra API calls: Fetching questions adds latency. Consider caching or batch fetch.
- Missing questions: Handle gracefully with empty object fallback.

---

## Issue 5: FRQ Summary Only Shows Raw Points

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** FRQ Summary: X/Y raw pts -> X/Y weighted (percentage)
- **Current State:** Only shows raw points (frqEarnedPoints/frqMaxPoints), no weighted display.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (lines 489-492) - FRQ points display
  - `src/apBoost/services/apScoringService.js` (lines 40-45) - Section has mcqMultiplier
- **Current Implementation:** Shows `Points: X/Y` for raw FRQ score
- **Gap:** If weighted multipliers exist, should show both raw and weighted. Need to check test sections for FRQ multiplier.
- **Dependencies:** Need test.sections data available in report card.

### Fix Plan

#### Step 1: Check for FRQ section weighting and display accordingly
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (lines 489-492)
**Details:**
- Calculate if FRQ has a multiplier from test.sections
- Show weighted points if different from raw:

```jsx
{/* FRQ Points */}
{(() => {
  // Find FRQ section multiplier
  const frqSection = test?.sections?.find(s => s.sectionType === 'FRQ' || s.sectionType === 'MIXED')
  const multiplier = frqSection?.frqMultiplier || 1
  const weighted = frqEarnedPoints * multiplier
  const maxWeighted = frqMaxPoints * multiplier
  const showWeighted = multiplier !== 1

  return (
    <div className="mt-4 pt-4 border-t border-border-default">
      <p className="text-text-secondary text-sm">
        Points: {isGradingComplete ? (
          <>
            {frqEarnedPoints}/{frqMaxPoints}
            {showWeighted && (
              <span className="text-text-muted"> → {weighted}/{maxWeighted} weighted</span>
            )}
            <span className="text-text-muted ml-2">
              ({frqMaxPoints > 0 ? Math.round((frqEarnedPoints / frqMaxPoints) * 100) : 0}%)
            </span>
          </>
        ) : `--/${frqMaxPoints} (pending)`}
      </p>
    </div>
  )
})()}
```

### Verification Steps
1. Create test with FRQ section that has a multiplier (frqMultiplier: 1.5)
2. Complete test, get it graded
3. Verify weighted points shown in FRQ summary

### Potential Risks
- Most tests may not have multipliers - default behavior unchanged
- Test not loaded: Handle with optional chaining

---

## Issue 6: Download Graded Paper Button Label Mismatch

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** [Download Graded Paper (PDF)] button label
- **Current State:** Button says "Download PDF" instead of matching spec.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (lines 246-256) - HandwrittenFilesSection download button
- **Current Implementation:** Button text is "Download PDF"
- **Gap:** Should say "Download Graded Paper (PDF)" per acceptance criteria

### Fix Plan

#### Step 1: Update button label
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (line 252)
**Details:**
- Change button text from "Download PDF" to "Download Graded Paper (PDF)":

```jsx
<a
  href={annotatedPdfUrl}
  target="_blank"
  rel="noopener noreferrer"
  className="bg-surface text-brand-primary px-4 py-2 rounded-[--radius-button] border border-border-default hover:bg-hover text-sm font-medium"
  download
>
  Download Graded Paper (PDF)
</a>
```

### Verification Steps
1. Complete handwritten FRQ submission
2. Get it graded with annotated PDF uploaded
3. View report card
4. Verify button label reads "Download Graded Paper (PDF)"

### Potential Risks
- None - cosmetic change only

---

## Issue 7: Teacher View Side-Panel Not Showing Report Card

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Teacher view: Side-panel from Gradebook (editable)
- **Current State:** GradingPanel only shows grading workflow, not a read-only/editable report card view.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APGradebook.jsx` (lines 182-191) - Both Grade and View open same panel
  - `src/apBoost/components/grading/GradingPanel.jsx` - Focused on FRQ grading only
- **Current Implementation:** "View" button opens the grading panel which is designed for editing grades, not viewing completed reports.
- **Gap:** Need either a separate read-only view or navigation to full report card.
- **Dependencies:** Design decision needed: read-only panel vs. linking to full page

### Fix Plan

#### Option A: Link to Full Report Card Page (Recommended)
This is simpler and provides a consistent experience.

#### Step 1: Update View button to navigate to report card
**File:** `src/apBoost/pages/APGradebook.jsx`
**Action:** Modify
**Details:**
- Add useNavigate hook and update handleView:

```jsx
import { useNavigate } from 'react-router-dom'

// In component:
const navigate = useNavigate()

// Update handleView:
const handleView = (resultId) => {
  navigate(`/ap/results/${resultId}`)
}
```

#### Step 2: Update GradebookRow View button styling to indicate navigation
**File:** `src/apBoost/pages/APGradebook.jsx`
**Action:** Modify (lines 90-95)
**Details:**
- Add visual indicator that this navigates away:

```jsx
<button
  onClick={() => onView(result.id)}
  className="px-4 py-1 rounded-[--radius-button] border border-border-default text-text-secondary text-sm hover:bg-hover inline-flex items-center gap-1"
>
  View Report
  <span className="text-xs">→</span>
</button>
```

### Verification Steps
1. Go to Gradebook as teacher
2. Find a completed/graded result
3. Click "View Report" button
4. Verify navigation to /ap/results/:resultId page

### Potential Risks
- Teacher may want inline view: Could add panel option later
- Authorization: Report card page should work for teachers viewing student results (requires Issue 8 fix)

---

## Issue 8: Student Name Source for Teacher View

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Student name from users/{userId}
- **Current State:** Uses AuthContext user object which is the currently logged-in user, not the student whose report this is.

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (line 264) - `const { user } = useAuth()`
  - `src/apBoost/pages/APReportCard.jsx` (line 380) - Uses `user?.displayName`
- **Current Implementation:** Shows currently authenticated user's name, which is wrong when a teacher views a student's report.
- **Gap:** Should fetch student name from result.userId, not current user.
- **Dependencies:** None - standard pattern exists in grading service.

### Fix Plan

#### Step 1: Fetch student info from result.userId
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify
**Details:**
- Add state: `const [studentInfo, setStudentInfo] = useState(null)`
- Add import: `import { doc, getDoc } from 'firebase/firestore'` and `import { db } from '../../firebase'`
- In useEffect after loading result:

```javascript
// Fetch student info from result.userId (not current user)
if (resultData.userId) {
  try {
    const userDoc = await getDoc(doc(db, 'users', resultData.userId))
    if (userDoc.exists()) {
      const userData = userDoc.data()
      setStudentInfo({
        name: userData.displayName || userData.email || 'Student',
        email: userData.email
      })
    }
  } catch {
    // Fallback to current user if fetch fails
    setStudentInfo({
      name: user?.displayName || user?.email || 'Student',
      email: user?.email
    })
  }
} else {
  // No userId, fallback to current user
  setStudentInfo({
    name: user?.displayName || user?.email || 'Student',
    email: user?.email
  })
}
```

#### Step 2: Update display to use studentInfo
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (line 380)
**Details:**

```jsx
<p>Student: {studentInfo?.name || user?.displayName || user?.email || 'Student'}</p>
```

### Verification Steps
1. As teacher, navigate to a student's report card
2. Verify student's name shows (not teacher's name)
3. As student, verify own name shows correctly

### Potential Risks
- Firebase rules: Ensure teachers can read users collection or result includes studentName
- Fallback: Gracefully falls back to current user if fetch fails

---

## Issue 9: Field Name Inconsistency (annotatedPdfUrl vs frqGradedPdfUrl)

### Audit Finding
- **Status:** ⚠️ Partial
- **Criterion:** Graded PDF from ap_test_results.frqGradedPdfUrl
- **Current State:** Uses `annotatedPdfUrl` field instead of spec's `frqGradedPdfUrl`

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (line 355) - `const annotatedPdfUrl = result?.annotatedPdfUrl`
  - `src/apBoost/services/apScoringService.js` (line 148) - `annotatedPdfUrl: null`
  - `src/apBoost/services/apGradingService.js` (lines 176-178) - Saves as `annotatedPdfUrl`
  - `src/apBoost/components/grading/GradingPanel.jsx` (line 267) - Uses `annotatedPdfUrl`
- **Current Implementation:** Consistently uses `annotatedPdfUrl` across codebase
- **Gap:** Spec says `frqGradedPdfUrl` but code uses `annotatedPdfUrl`
- **Dependencies:** Would require migration of existing data if changed

### Fix Plan

#### Option A: Document the deviation (Recommended)
Since `annotatedPdfUrl` is consistently used throughout the codebase and changing would require data migration, recommend documenting this as an intentional deviation.

**Action:** Update acceptance criteria or documentation to note that `annotatedPdfUrl` is used instead of `frqGradedPdfUrl`.

#### Option B: Rename field (Not recommended unless required)
Would require:
1. Migration script to rename field in existing documents
2. Update all code references (5+ files)
3. Deploy atomically

### Verification Steps
1. Verify current functionality works with `annotatedPdfUrl`
2. Document the field name in data model documentation

### Potential Risks
- None if keeping current name
- Breaking existing data if renamed without migration

---

## Issue 10: PDF Utility Missing Class Name

### Audit Finding
- **Status:** ⚠️ Partial (related to Issue 2)
- **Criterion:** Header with student/test info in PDF
- **Current State:** PDF includes student, test, date but NOT class name

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/utils/generateReportPdf.js` (lines 52-66) - Header section
- **Current Implementation:** Shows Student, Test, Date
- **Gap:** Missing class name line

### Fix Plan

#### Step 1: Update generateReportPdf to accept and display class name
**File:** `src/apBoost/utils/generateReportPdf.js`
**Action:** Modify
**Details:**
- Update function signature to accept class name:

```javascript
export async function generateReportPdf(result, test, student, className = null) {
```

- Add class line after student info (around line 55):

```javascript
// Student Info
addText('Student:', margin, yPos, { fontStyle: 'bold' })
addText(student?.name || 'Student', margin + 40, yPos)
yPos += 7

if (className) {
  addText('Class:', margin, yPos, { fontStyle: 'bold' })
  addText(className, margin + 40, yPos)
  yPos += 7
}

addText('Test:', margin, yPos, { fontStyle: 'bold' })
// ... rest unchanged
```

#### Step 2: Update downloadReportPdf similarly
**File:** `src/apBoost/utils/generateReportPdf.js`
**Action:** Modify
**Details:**

```javascript
export async function downloadReportPdf(result, test, student, className = null) {
  const doc = await generateReportPdf(result, test, student, className)
  // ... rest unchanged
}
```

#### Step 3: Pass className when calling from APReportCard
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (in download button handler)
**Details:**

```jsx
onClick={() => downloadReportPdf(result, test, { name: studentInfo?.name || user?.displayName }, className)}
```

### Verification Steps
1. Download PDF from report card with a class assigned
2. Verify class name appears in PDF header
3. Verify PDF still works when no class assigned

### Potential Risks
- None - additional optional parameter with fallback

---

## Issue 11: MCQ Correct Answer Column Header Mismatch

### Audit Finding
- **Status:** ⚠️ Partial (minor)
- **Criterion:** Column header: "Answer" for correct answer
- **Current State:** Column says "Correct" instead of "Answer"

### Code Analysis
- **Relevant Files:**
  - `src/apBoost/pages/APReportCard.jsx` (line 80) - Header says "Correct"
- **Current Implementation:** `<th>Correct</th>` for the correct answer column
- **Gap:** Spec says "Answer" (for correct answer), "Response" (for student answer)

### Fix Plan

#### Step 1: Update column headers to match spec
**File:** `src/apBoost/pages/APReportCard.jsx`
**Action:** Modify (lines 79-82)
**Details:**

```jsx
<tr className="border-b border-border-default">
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Q#</th>
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Answer</th>
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Response</th>
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Domain</th>
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Topic</th>
  <th className="text-left py-2 px-3 text-text-secondary font-medium">Result</th>
</tr>
```

### Verification Steps
1. View report card with MCQ results
2. Verify column headers match: Q#, Answer, Response, Domain, Topic, Result

### Potential Risks
- None - cosmetic change

---

## Implementation Order

Recommended order to implement fixes (considering dependencies):

1. **Issue 3: MCQ Domain/Topic in Scoring Service** - Foundational data change; new results will have metadata
2. **Issue 2: Class Name Display** - Includes new service function needed by Issue 10
3. **Issue 8: Student Name from userId** - Needed for teacher view correctness
4. **Issue 1: Download PDF Button** - Can be done after class name is available
5. **Issue 10: PDF Class Name** - Depends on Issue 2 completion
6. **Issue 4: FRQ Domain/Topic Display** - Independent enhancement
7. **Issue 5: FRQ Weighted Display** - Independent enhancement
8. **Issue 6: Button Label Fix** - Quick cosmetic fix
9. **Issue 7: Teacher View Navigation** - Depends on Issue 8
10. **Issue 11: Column Header Labels** - Quick cosmetic fix
11. **Issue 9: Field Name Documentation** - Documentation only

---

## Cross-Cutting Concerns

### Pattern: Fetching related data
Multiple issues require fetching related documents (class, student, questions). Consider:
1. Creating a unified `getReportCardData(resultId)` function that fetches all needed data in one call
2. This would reduce code duplication and improve performance

### Pattern: Error handling
All fetch operations should fail gracefully with:
- Try/catch blocks
- Fallback values (null, '—', or current user)
- No visible errors to user for non-critical data

### Pattern: Backward compatibility
Changes to mcqResults structure (Issue 3) should handle:
- Old results without domain/topic: Show '—'
- No need for data migration; graceful degradation

---

## Notes for Implementer

1. **Test with real data:** Create test results with various configurations (with/without class, with/without FRQ, graded/pending) to verify all code paths.

2. **Firebase rules:** Ensure teachers have read access to:
   - ap_classes (to get class name)
   - users (to get student name)
   - ap_questions (to get domain/topic for FRQ)

3. **Performance:** The report card now makes additional API calls. Monitor load time and consider:
   - Parallel Promise.all for independent fetches
   - Caching frequently accessed data
   - Loading states for each section

4. **Component extraction:** Consider extracting inline components (APScoreBadge, SectionScoreBar, MCQResultsTable, FRQGradedResults) to `src/apBoost/components/report/` folder for better organization.

5. **Design tokens:** All new UI elements must use design tokens from `/src/index.css` - no raw Tailwind values.

6. **Change log:** Remember to log all changes to `change_action_log_ap.md` as per project instructions.

---

## Part 2: Codebase Facts

# CODEBASE_FACTS__09__9.1_to_9.4.md

**Chunk ID:** 09__9.1_to_9.4
**Scope:** AP Report Card / Gradebook report-view for AP tests (PDF export, class & student identity display, MCQ/FRQ metadata columns, FRQ weighting display, teacher view navigation, graded-paper download labeling, field-name consistency for graded PDF URLs).
**Generated:** 2026-01-14

---

## 1) Canonical Data Schema / Source-of-Truth

**Found: Yes**

### ap_test_results (Collection: `COLLECTIONS.TEST_RESULTS` = `'ap_test_results'`)

**Evidence:** `src/apBoost/utils/apTypes.js:95`, `src/apBoost/services/apScoringService.js:127-154`

Fields as written in `createTestResult()` (lines 127-154):
```javascript
const resultData = {
  userId: session.userId,           // string - student user ID
  testId: session.testId,           // string - test document ID
  classId: session.classId || null, // string | null - class document ID
  assignmentId: session.assignmentId || null,
  attemptNumber: session.attemptNumber,
  isFirstAttempt: session.attemptNumber === 1,
  sessionId: session.id,
  answers,                          // object - map of questionId -> answer
  score: totalScore,                // number
  maxScore,                         // number
  percentage,                       // number
  apScore,                          // number (1-5)
  sectionScores,                    // object - map of sectionIndex -> { correct, total, points }
  mcqResults,                       // array - [{ questionId, studentAnswer, correctAnswer, correct }]
  frqSubmissionType: frqData?.frqSubmissionType || null, // 'TYPED' | 'HANDWRITTEN' | null
  frqUploadedFiles: frqData?.frqUploadedFiles || null,   // array | null
  frqAnswers: session.answers || {},                     // object - FRQ typed answers
  frqMaxPoints: 0,                  // number
  frqScore: null,                   // number | null - set after grading
  annotatedPdfUrl: null,            // string | null - teacher's annotated PDF
  frqGrades: null,                  // object | null - { [questionId]: { subScores, maxPoints, comment } }
  gradingStatus,                    // GRADING_STATUS enum value
  startedAt: session.startedAt,
  completedAt: serverTimestamp(),
  gradedAt: null,
}
```

**Key Observations:**
- `mcqResults` array contains: `{ questionId, studentAnswer, correctAnswer, correct }` - does **NOT** include `questionDomain` or `questionTopic`
- `classId` is stored (line 130)
- `annotatedPdfUrl` is the field name used (NOT `frqGradedPdfUrl`)

### ap_classes (Collection: `COLLECTIONS.CLASSES` = `'ap_classes'`)

**Evidence:** `src/apBoost/utils/apTypes.js:96`, `src/apBoost/services/apTeacherService.js:160-178`, `src/apBoost/services/apGradingService.js:271-285`

Fields observed in usage:
- `teacherId` - string (line 164 apTeacherService, line 274 apGradingService)
- `name` - string (line 166 apTeacherService sorts by `name`)
- `studentIds` - array of user IDs (line 195 apTeacherService)

### users/{userId}

**Evidence:** `src/apBoost/services/apGradingService.js:64-69`, `src/apBoost/services/apTeacherService.js:203-216`

Fields read for display:
- `displayName` - string (line 68 apGradingService, line 210 apTeacherService)
- `email` - string (line 68 apGradingService, line 210 apTeacherService)

**Note:** The code reads from `'users'` collection directly (NOT `ap_users`).

### ap_questions (Collection: `COLLECTIONS.QUESTIONS` = `'ap_questions'`)

**Evidence:** `src/apBoost/services/apQuestionService.js:155-196`

Question document shape from `createQuestion()`:
```javascript
const newQuestion = {
  questionText: ...,
  questionType: ...,           // MCQ, MCQ_MULTI, FRQ, SAQ, DBQ
  format: ...,                 // VERTICAL, HORIZONTAL
  subject: ...,
  questionDomain: ...,         // ✅ CONFIRMED - line 164
  questionTopic: ...,          // ✅ CONFIRMED - line 165
  difficulty: ...,
  choiceA, choiceB, choiceC, choiceD, choiceE,
  choiceCount,
  correctAnswers: [],
  subQuestions: ...,           // FRQ sub-questions array
  stimulusId, stimulus,
  explanation,
  partialCredit,
  createdBy,
  createdAt, updatedAt,
}
```

**Evidence for field names:** `src/apBoost/services/apQuestionService.js:57` uses `where('questionDomain', '==', ...)` and line 88-89 searches `questionDomain`/`questionTopic`.

---

## 2) Write Paths

**Found: Yes**

### Where `mcqResults` is created/populated

**Evidence:** `src/apBoost/services/apScoringService.js:86-112`

```javascript
// Build MCQ results for report card (lines 97-112)
for (const questionId of section.questionIds || []) {
  const question = test.questions[questionId]
  if (!question) continue

  const studentAnswer = answers[questionId] || null
  const correctAnswers = question.correctAnswers || []
  const isCorrect = correctAnswers.includes(studentAnswer)

  mcqResults.push({
    questionId,
    studentAnswer,
    correctAnswer: correctAnswers[0] || 'N/A',
    correct: isCorrect,
  })
}
```

**Current stored shape:** `{ questionId, studentAnswer, correctAnswer, correct }` - NO domain/topic fields.

### Where `frqGrades` is created/updated

**Evidence:** `src/apBoost/services/apGradingService.js:165-211`

Function: `saveGrade(resultId, grades, status, teacherId, annotatedPdfUrl = null)`

Updates written:
```javascript
const updateData = {
  frqGrades: grades,          // { [questionId]: { subScores, maxPoints, comment } }
  gradingStatus: status,
  gradedBy: teacherId,
  gradedAt: serverTimestamp(),
}
if (annotatedPdfUrl) {
  updateData.annotatedPdfUrl = annotatedPdfUrl
}
```

### Where `annotatedPdfUrl` is set

**Write Paths:**
1. **Initial creation:** `src/apBoost/services/apScoringService.js:148` - set to `null`
2. **Grading update:** `src/apBoost/services/apGradingService.js:177-179` - set from parameter
3. **GradingPanel UI:** `src/apBoost/components/grading/GradingPanel.jsx:305` - passes to `saveGrade()`

**Read Paths:**
- `src/apBoost/pages/APReportCard.jsx:355` - `const annotatedPdfUrl = result?.annotatedPdfUrl`
- `src/apBoost/components/grading/GradingPanel.jsx:267` - `setAnnotatedPdfUrl(data.annotatedPdfUrl || null)`

### Service functions for fetching

| Function | File:Line | Description |
|----------|-----------|-------------|
| `getTestResult(resultId)` | `apScoringService.js:173-184` | Gets result by ID from `COLLECTIONS.TEST_RESULTS` |
| `getTestMeta(testId)` | `apTestService.js:131-142` | Gets test metadata from `COLLECTIONS.TESTS` |
| `getQuestion(questionId)` | `apTestService.js:176-187` | Gets question by ID |
| `getQuestionById(questionId)` | `apQuestionService.js:105-122` | Alternate question getter |
| `getTeacherClasses(teacherId)` | `apGradingService.js:271-285` | Gets classes by teacherId |
| `getTeacherClasses(teacherId)` | `apTeacherService.js:160-178` | Duplicate function in teacher service |
| `getClassById(classId)` | **NOT FOUND** | No such function exists in codebase |

---

## 3) Offline/Resilience Mechanics

**Found: Yes - but NOT applicable to Report Card data loads**

**Evidence:** `src/apBoost/hooks/useOfflineQueue.js` (entire file, 287 lines)

The `useOfflineQueue` hook:
- Uses IndexedDB for queueing (`DB_NAME = 'ap_boost_queue'`)
- Handles `ANSWER_CHANGE`, `FLAG_TOGGLE`, `NAVIGATION`, `TIMER_SYNC` actions
- Writes only to `COLLECTIONS.SESSION_STATE` (line 232)
- Implements exponential backoff retry (lines 258-261)

**Key Finding:** This offline queue is ONLY for test session state syncing. It does NOT apply to:
- Report card data loading (`getTestResult`, `getTestMeta`)
- Gradebook data loading (`getPendingGrades`)
- Class/User data loading

The report card page (`APReportCard.jsx`) and gradebook (`APGradebook.jsx`) have NO offline/retry handling for their data fetches - they fail silently or show error UI.

---

## 4) UI/Flow Entry Points

**Found: Yes**

### Student route to report card

**Evidence:** `src/apBoost/routes.jsx:41-48`

```jsx
<Route
  path="/ap/results/:resultId"
  element={
    <PrivateRoute>
      <APReportCard />
    </PrivateRoute>
  }
/>
```

Route path: `/ap/results/:resultId`
Component: `APReportCard`

### Teacher Gradebook "View" action

**Evidence:** `src/apBoost/pages/APGradebook.jsx:187-191`

```javascript
// Handle view action (same as grade for now)
const handleView = (resultId) => {
  setSelectedResultId(resultId)
  setIsPanelOpen(true)
}
```

**Current behavior:** Opens `GradingPanel` side panel (NOT navigation to `/ap/results/:id`)

Button label: "View" (line 94)
Handler: `onView={handleView}` passed to `GradebookRow` (line 313)

### APReportCard.jsx UI Elements

**Actions section (lines 497-505):**
```jsx
{/* Actions */}
<div className="flex justify-center gap-4">
  <Link
    to="/ap"
    className="bg-surface text-text-primary px-6 py-2 ..."
  >
    Back to Dashboard
  </Link>
</div>
```

**No "Download Report PDF" button exists.** Only a "Back to Dashboard" link.

**Graded paper download (lines 245-253):**
```jsx
<a
  href={annotatedPdfUrl}
  target="_blank"
  rel="noopener noreferrer"
  className="..."
  download
>
  Download PDF
</a>
```
Label: **"Download PDF"** (generic, not "Download Graded Paper")

**MCQ table headers (lines 77-83):**
```jsx
<th>Q#</th>
<th>Correct</th>
<th>Your Answer</th>
<th>Result</th>
```

**NO Domain/Topic columns rendered today.**

**FRQ graded results UI (lines 163-199):**
- Renders `FRQGradedResults` component
- Shows question number, sub-scores, teacher comment
- **Does NOT display question domain/topic**
- **Does NOT fetch FRQ question docs for metadata**

**Header block student display (line 380):**
```jsx
<p>Student: {user?.displayName || user?.email || 'Student'}</p>
```

**Uses authenticated user (`useAuth()`), NOT `result.userId` student.**

---

## 5) Must-Answer Questions

### A. PDF download integration

**1. Is `downloadReportPdf` imported anywhere in the app today?**

**Answer: NOT FOUND**

Searched: `import.*generateReportPdf|import.*downloadReportPdf` in `src/`
Result: Only found in markdown audit/fix plan files, NOT in any `.jsx` or `.js` source files.

**Evidence:** Grep returned only `.md` files:
- `src/apBoost/criteria_audit/fix_plans/section_12.1_to_13.2_fix_plan.md`
- `src/apBoost/criteria_audit/fix_plans/section_9.1_to_9.4_fix_plan.md`
- `src/apBoost/criteria_audit/section_9.1_to_9.4_criteria_audit.md`

---

**2. Does `APReportCard.jsx` currently render any button/link that triggers report PDF generation?**

**Answer: No**

**Evidence:** `src/apBoost/pages/APReportCard.jsx:497-505`
The Actions section only contains a "Back to Dashboard" link. No PDF generation trigger exists.

The `generateReportPdf.js` file exists (`src/apBoost/utils/generateReportPdf.js`) but is NEVER imported or called.

---

**3. What student object shape does `downloadReportPdf`/`generateReportPdf` expect?**

**Answer:** `{ name, email }` (optional)

**Evidence:** `src/apBoost/utils/generateReportPdf.js:11-12`

```javascript
/**
 * @param {Object} student - Student info { name, email }
 */
export async function generateReportPdf(result, test, student) { ... }
```

Usage in function (line 54):
```javascript
addText(student?.name || 'Student', margin + 40, yPos)
```

Filename generation (line 246):
```javascript
const filename = `AP_Report_${student?.name?.replace(/\s+/g, '_') || 'Student'}_${...}.pdf`
```

---

### B. Class name + student identity

**4. Does the codebase already have a `getClassById` service?**

**Answer: NOT FOUND**

Searched: `getClassById` in `src/apBoost/`
Result: Only found in `src/apBoost/criteria_audit/fix_plans/section_9.1_to_9.4_fix_plan.md` (markdown)

No actual `getClassById` function exists in any service file. Related functions exist:
- `getTeacherClasses(teacherId)` - returns array of classes for a teacher (apTeacherService.js:160)
- `getClassStudents(classId)` - returns students in a class (apTeacherService.js:185)

---

**5. In report card header, does it use authenticated user or result.userId student?**

**Answer: Uses authenticated user (incorrect for teacher view)**

**Evidence:** `src/apBoost/pages/APReportCard.jsx:264, 380`

```javascript
const { user } = useAuth()  // line 264
...
<p>Student: {user?.displayName || user?.email || 'Student'}</p>  // line 380
```

The `result` object DOES contain `userId` (from `createTestResult` at apScoringService.js:128), but it is NOT used for student name display.

---

**6. Does the repo include Firestore rules for `users/{userId}` or `ap_classes/{classId}`?**

**Answer: Partial - rules exist for `users` but NOT for `ap_*` collections**

**Evidence:** `firestore.rules:27-39`

```
// USERS
match /users/{userId} {
  allow read: if isAuthenticated();
  ...
}
```

**Critical Finding:** NO rules exist for `ap_*` collections (`ap_tests`, `ap_test_results`, `ap_questions`, `ap_classes`, `ap_assignments`, `ap_session_state`, `ap_stimuli`). These collections are **unprotected** by Firestore rules.

---

### C. MCQ/FRQ domain/topic metadata

**7. Are `questionDomain` and `questionTopic` present on question docs?**

**Answer: Yes - field names CONFIRMED as `questionDomain` and `questionTopic`**

**Evidence:** `src/apBoost/services/apQuestionService.js:164-165`

```javascript
questionDomain: questionData.questionDomain || '',
questionTopic: questionData.questionTopic || '',
```

Also confirmed in search/filter (lines 57, 88-89):
```javascript
constraints.push(where('questionDomain', '==', filters.domain))
...
q.questionDomain?.toLowerCase().includes(searchLower) ||
q.questionTopic?.toLowerCase().includes(searchLower)
```

---

**8. Is `mcqResults` persisted with domain/topic today?**

**Answer: No**

**Evidence:** `src/apBoost/services/apScoringService.js:106-111`

Current stored shape:
```javascript
mcqResults.push({
  questionId,
  studentAnswer,
  correctAnswer: correctAnswers[0] || 'N/A',
  correct: isCorrect,
})
```

No `questionDomain` or `questionTopic` fields are included.

---

**9. For FRQ report display: does `APReportCard.jsx` fetch FRQ question docs for metadata today?**

**Answer: No**

**Evidence:** `src/apBoost/pages/APReportCard.jsx:271-297`

The `loadResult()` function fetches:
1. `getTestResult(resultId)` - line 277
2. `getTestMeta(resultData.testId)` - line 284

It does NOT fetch individual FRQ question documents. The `FRQGradedResults` component (lines 156-200) renders from `result.frqGrades` without question metadata.

---

### D. FRQ weighting & multipliers

**10. Is there an implemented `frqMultiplier` on test sections?**

**Answer: No - only `mcqMultiplier` exists**

**Evidence:** `src/apBoost/services/apScoringService.js:41`

```javascript
// Apply multiplier if present
const multiplier = section.mcqMultiplier || 1
const points = correct * multiplier
```

Searched: `frqMultiplier` in `src/` - found only in markdown audit/criteria files, NOT in actual source code.

**Note:** FRQ weighting is not implemented. FRQ scores are calculated by summing `subScores` (apGradingService.js:218-231).

---

### E. Field-name consistency for graded PDF

**11. Is the graded PDF URL field consistently named `annotatedPdfUrl`?**

**Answer: Yes - consistently `annotatedPdfUrl`**

**Evidence:**
- Creation: `apScoringService.js:148` - `annotatedPdfUrl: null`
- Update: `apGradingService.js:178` - `updateData.annotatedPdfUrl = annotatedPdfUrl`
- Read (Report): `APReportCard.jsx:355` - `const annotatedPdfUrl = result?.annotatedPdfUrl`
- Read (Grading): `GradingPanel.jsx:267` - `setAnnotatedPdfUrl(data.annotatedPdfUrl || null)`

`frqGradedPdfUrl` does NOT appear in any source code - only in markdown documentation/audit files.

---

### F. Teacher "View Report" behavior

**12. In `APGradebook.jsx`, what does the "View" action do today?**

**Answer: Opens `GradingPanel` side panel (does NOT navigate)**

**Evidence:** `src/apBoost/pages/APGradebook.jsx:187-191, 331-344`

Handler:
```javascript
const handleView = (resultId) => {
  setSelectedResultId(resultId)
  setIsPanelOpen(true)
}
```

Rendered panel:
```jsx
{isPanelOpen && selectedResultId && (
  <>
    <div className="fixed inset-0 bg-black/50 z-40" onClick={handleClosePanel} />
    <GradingPanel
      resultId={selectedResultId}
      onClose={handleClosePanel}
      onSave={handleSave}
      teacherId={user?.uid}
    />
  </>
)}
```

Button label: "View" (line 94 in `GradebookRow`)

---

## Additional Findings

### Missing Firestore Security Rules for AP Collections

**Evidence:** `firestore.rules` (entire file)

The rules file defines rules for: `users`, `classes`, `lists`, `attempts`, `system_logs`

**No rules exist for:**
- `ap_tests`
- `ap_test_results`
- `ap_questions`
- `ap_classes`
- `ap_assignments`
- `ap_session_state`
- `ap_stimuli`

This means AP collections are either open (default deny in production) or rely on implicit rules not shown.

### Duplicate `getTeacherClasses` Functions

Two implementations exist:
1. `src/apBoost/services/apGradingService.js:271-285`
2. `src/apBoost/services/apTeacherService.js:160-178`

Both query the same collection with the same logic. This is a potential maintenance issue.
